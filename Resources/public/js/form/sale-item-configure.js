define(["jquery","ekyna-product/templates","ekyna-number","fancybox"],function(a,b){"use strict";function c(a,b){if(this.$element=a,void 0===b)throw"Invalid 'parentItem' argument";this.parentItem=b,this.init()}function d(a,b){if(this.$element=a,!b)throw"Invalid 'optionGroups' argument";this.optionGroups=b,this.init()}function e(a,b){if(this.$element=a,!b)throw"Invalid 'item' argument";this.item=b,this.init()}function f(a,b){if(this.$element=a,!b)throw"Invalid 'item' argument";this.item=b,this.init()}function g(a,b){this.$element=a,this.parentItem=b,this.init()}var h=function(a,b){a.prop("disabled",b).find("input, select, button, textarea").not('[data-locked="1"]').prop("disabled",b)},i=function(a){return Math.round(100*parseFloat(a))/100};return a.extend(c.prototype,{init:function(){this.busy=!1,this.$choice=void 0,this.choice=void 0,this.$radio=this.$element.find(".slot-buttons input[type=radio]"),this.$label=this.$element.find(".slot-buttons label"),this.$prev=this.$element.find(".slot-choices > a.prev"),this.$next=this.$element.find(".slot-choices > a.next"),this.$element.find(".slot-choice-form[disabled]").each(function(){h(a(this),!0)}),this.bindEvents(),this.selectChoice()},bindEvents:function(){if(0!==this.$radio.size()){var b=this;this.$radio.on("change",function(a){return b.selectChoice(),a.preventDefault(),a.stopPropagation(),!1}),this.$label.on("click",function(a){if(b.busy)return a.preventDefault(),a.stopPropagation(),!1}),this.$prev.on("click",function(c){if(b.busy)return c.preventDefault(),c.stopPropagation(),!1;var d=b.$radio.filter(":checked").data("index")-1,e=b.$radio.filter("[data-index="+d+"]");0===e.size()&&(e=a(b.$radio.eq(b.$radio.size()-1))),e.prop("checked",!0),b.selectChoice()}),this.$next.on("click",function(c){if(b.busy)return c.preventDefault(),c.stopPropagation(),!1;var d=b.$radio.filter(":checked").data("index")+1,e=b.$radio.filter("[data-index="+d+"]");0===e.size()&&(e=a(b.$radio.eq(0))),e.prop("checked",!0),b.selectChoice()})}},unbindEvents:function(){0!==this.$radio.size()&&(this.$radio.off("change"),this.$label.off("click"),this.$prev.off("click"),this.$next.off("click"))},destroy:function(){this.unbindEvents(),this.$element.removeData(),this.$choice&&this.$choice.data("saleItem")&&this.$choice.data("saleItem").destroy()},selectChoice:function(){if(0===this.$radio.size())return this.$choice=this.$element.find(".slot-choice-form").saleItem(this.parentItem),void(this.choice=this.$choice.data("saleItem"));var a=this,b=a.$choice,c=a.choice,d=this.$radio.filter(":checked").val()||0,e=this.$element.find('.slot-choice-form[data-id="'+d+'"]');if(1===e.size()){this.busy=!0;var f=function(){h(e,!1),a.$choice=e,1===a.$choice.find("input.sale-item-quantity").size()?(a.$choice.saleItem(a.parentItem),a.choice=a.$choice.data("saleItem")):a.choice=void 0,a.$choice.fadeIn(250),a.$element.trigger("change"),a.busy=!1};b?b.fadeOut(250,function(){c&&c.destroy(),h(b,!0),f()}):f()}},updateQuantity:function(){this.choice&&this.choice.onQuantityChange()},hasChoice:function(){return void 0!==this.choice},getChoice:function(){return this.choice},getLabel:function(){return this.$choice.find(".product-title").html()}}),a.fn.bundleSlot=function(b){return this.each(function(){void 0===a(this).data("bundleSlot")&&a(this).data("bundleSlot",new c(a(this),b))})},a.extend(d.prototype,{init:function(){this.$select=this.$element.find("select"),this.$option=this.option=void 0,this.locked=!!this.$select.attr("data-locked"),this.$image=void 0,this.optionGroups.item.$gallery&&(this.$image=this.optionGroups.item.$gallery.find('a[data-option-id="'+this.$element.data("id")+'"]'),0===this.$image.size()&&(this.$image=a('<a data-option-id="'+this.$element.data("id")+'"><img></a>'),this.$image.appendTo(this.optionGroups.item.$gallery.find(".item-gallery-children")))),this.$availability=this.$element.find(".sale-item-option-availability"),this.updateState(),this.selectOption(),this.bindEvents()},updateState:function(){return this.locked?void this.$select.prop("disabled",!0):void this.$select.prop("disabled",!1)},bindEvents:function(){var a=this;this.$select.on("change",function(b){return b.preventDefault(),b.stopPropagation(),a.selectOption(),a.optionGroups.$element.trigger("change"),!1})},selectOption:function(){this.$option=this.option=void 0;var a=this.$select.find('option[value="'+this.$select.val()+'"]');1===a.length&&a.data("config")?(this.$option=a,this.option=a.data("config"),this.$image&&(this.option.thumb?this.$image.show().attr("href",this.option.image).attr("title",this.$option.text()).find("img").attr("src",this.option.thumb):this.$image.hide())):this.$image&&this.$image.hide(),this.updateAvailability()},updateAvailability:function(){if(this.$availability.empty(),this.$element.removeClass("has-error"),this.option&&this.option.availability){var b=this.optionGroups.item.getTotalQuantity(),c=a.extend({o_msg:null,min_qty:0,min_msg:null,max_qty:0,max_msg:null,a_qty:0,a_msg:null,r_qty:0,r_msg:null},this.option.availability),d=parseFloat(c.min_qty),e="INF"===c.max_qty?Number.POSITIVE_INFINITY:parseFloat(c.max_qty),f=!1,g=null;b<d?(g=c.min_msg,f=!0):b>e?(g=c.max_msg,f=!0):b>c.a_qty&&(g=c.r_msg?this.totalQuantity>c.a_qty+c.r_qty?c.o_msg:c.r_msg:c.o_msg),f&&this.$element.addClass("has-error"),this.$availability.html(g)}},unbindEvents:function(){this.$select.off("change")},destroy:function(){this.unbindEvents(),this.$image&&this.$image.remove(),this.$element.removeData()},getId:function(){return this.$element.data("id")},getType:function(){return this.$element.data("type")},hasOption:function(){return!this.locked&&!!this.$option},getPrice:function(){return this.hasOption()?i(this.option.price):0},getLabel:function(){return this.hasOption()?this.$option.text():""},isLocked:function(){return this.locked},isRequired:function(){return this.$select.prop("required")},lock:function(){return this.locked||(this.$select.attr("data-locked","1"),this.locked=!0),this},unlock:function(){return this.locked&&(this.$select.attr("data-locked","0"),this.locked=!1),this},hide:function(){return this.$element.hide(),this.$image&&this.$image.size()&&this.$image.hide(),this},show:function(){return this.$element.show(),this.$image&&this.$image.size()&&this.$image.show(),this}}),a.fn.optionGroup=function(b){return this.each(function(){void 0===a(this).data("optionGroup")&&a(this).data("optionGroup",new d(a(this),b))})},a.extend(e.prototype,{init:function(){this.name=this.$element.attr("name"),this.loadGroups(),this.bindEvents()},loadGroups:function(){var b=this;this.$groups=[],this.groups=[],this.$element.find(" > .form-group").each(function(){var c=a(this).optionGroup(b);b.$groups.push(c),b.groups.push(c.data("optionGroup"))})},getGroups:function(){return this.groups},hasOptions:function(){var b=!1;return a.each(this.groups,function(){if(b=this.hasOption())return!1}),b},bindEvents:function(){},unbindEvents:function(){},destroy:function(){this.unbindEvents(),a.each(this.groups,function(){this.destroy()}),this.$element.removeData()},hasGroups:function(){return 0<this.groups.length},getPrice:function(){var b=0;return a.each(this.groups,function(){this.isLocked()||(b+=this.getPrice())}),b},create:function(c){if(c.hasOwnProperty("id")){var d=this.$element.find('> .form-group[data-id="'+c.id+'"]');if(1===d.size())return void d.data("optionGroup").show().unlock().updateState();c.parent=this.name,d=a(b["sale_item_option_group.html.twig"].render(c)),d.appendTo(this.$element).optionGroup(this),this.$groups.push(d),this.groups.push(d.data("optionGroup"))}},lockByType:function(b){return this.$element.find('> .form-group[data-type="'+b+'"]').each(function(){a(this).data("optionGroup").lock().hide().updateState()}),this},hideByType:function(b){return this.$element.find('> .form-group[data-type="'+b+'"]').each(function(){a(this).data("optionGroup").hide()}),this},updateAvailability:function(){a.each(this.groups,function(){this.updateAvailability()})}}),a.fn.optionGroups=function(b){return this.each(function(){void 0===a(this).data("optionGroups")&&a(this).data("optionGroups",new e(a(this),b))})},a.extend(f.prototype,{init:function(){if(this.$image=void 0,this.item.$gallery&&(this.$image=this.item.$gallery.find("> a"),1===this.$image.size())){this.$image.data("href",this.$image.attr("href")).data("title",this.$image.attr("title"));var a=this.$image.find("img");a.data("src",a.attr("src"))}this.selectVariant(),this.bindEvents()},bindEvents:function(){var a=this;this.$element.on("change",function(){a.selectVariant()})},unbindEvents:function(){this.$element.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData()},selectVariant:function(){this.$variant=void 0,this.config={label:null,thumb:null,price:0,groups:[],availability:null};var b=this.$element.find('option[value="'+this.$element.val()+'"]');if(1===b.size()&&b.data("config")&&(this.$variant=b,this.config=a.extend(this.config,b.data("config"),{label:b.text()}),this.$image&&this.config.thumb))return void this.$image.attr("href",this.config.image).attr("title",this.config.label).find("img").attr("src",this.config.thumb);if(this.$image){this.$image.attr("href",this.$image.data("href")).attr("title",this.$image.data("title"));var c=this.$image.find("img");c.attr("src",c.data("src"))}},hasVariant:function(){return void 0!==this.$variant},getConfig:function(){return this.config},getPrice:function(){return i(this.config.price)},getLabel:function(){return this.config.label},getOptionGroups:function(){return this.config.groups}}),a.fn.variant=function(b){return this.each(function(){void 0===a(this).data("variant")&&a(this).data("variant",new f(a(this),b))})},g.trans={quantity:"Quantity",discount:"Discount",unit_price:"Unit price",total:"Net total",rule_table:"Your prices",price_table:"Detailed unit price"},a.extend(g.prototype,{init:function(){this.id=this.$element.attr("id"),this.config=a.extend({price:0,currency:"EUR",rules:[],availability:null,privileged:!1},this.$element.data("config"));var b=this.$element.data("trans");b&&(g.trans=b),this.$gallery=void 0;var c=a("#"+this.id+"_gallery");1===c.size()&&(this.$gallery=c),this.$quantity=this.$element.find("#"+this.id+"_quantity"),this.quantity=this.$quantity.val(),this.totalQuantity=this.quantity,this.parentItem&&(this.totalQuantity=this.quantity*this.parentItem.getTotalQuantity(),this.$parentQuantity=this.$quantity.parent().find(".sale-item-parent-qty"),0===this.$parentQuantity.size()&&(this.$parentQuantity=a('<span class="input-group-addon sale-item-parent-qty"></span>'),this.$parentQuantity.insertBefore(this.$quantity)),this.updateParentQuantity()),this.$pricing=this.$element.find("#"+this.id+"_pricing"),this.activeRule=void 0,this.basePrice=0,this.unitPrice=0,this.totalPrice=0,this.optionGroups=void 0,this.$optionGroups=this.$element.find("#"+this.id+"_options").optionGroups(this),this.optionGroups=this.$optionGroups.data("optionGroups"),this.$variant=this.variant=void 0;var d=this.$element.find("#"+this.id+"_variant");1===d.size()&&(this.$variant=d.variant(this),this.variant=d.data("variant"),this.createVariantOptionGroups());var e=[];if(this.$bundleSlots=this.$element.find("#"+this.id+"_configuration > .bundle-slot"),0<this.$bundleSlots.size()&&this.$bundleSlots.bundleSlot(this).each(function(){e.push(a(this).data("bundleSlot"))}),this.bundleSlots=e,this.$availability=this.parentItem?this.$element.find(".sale-item-availability"):this.$element.find(".sale-item-inner .sale-item-availability"),this.$submitButton=void 0,!this.parentItem&&(this.$submitButton=this.$element.find("button[type=submit]"),0===this.$submitButton.size()&&(this.$submitButton=this.$element.closest(".modal-content").find(".bootstrap-dialog-footer button#submit")),0===this.$submitButton.size()))throw"Submit button not found";this.bindEvents(),this.onChange()},bindEvents:function(){var a=this;this.$variant&&this.$variant.on("change",function(){a.onVariantChange()}),this.$bundleSlots.on("change",function(){a.onChildChange()}),this.$optionGroups.on("change",function(){a.onChildChange()}),this.$quantity.on("keyup change mouseup",function(){a.onQuantityChange()})},unbindEvents:function(){this.$variant&&this.$variant.variant().off("change"),this.$bundleSlots.off("change"),this.$optionGroups.off("change"),this.$quantity.off("keyup change mouseup")},destroy:function(){this.unbindEvents(),this.variant&&this.variant.destroy(),a.each(this.bundleSlots,function(){this.destroy()}),this.optionGroups.destroy(),this.$element.removeData()},onVariantChange:function(){this.createVariantOptionGroups(),this.onChildChange()},createVariantOptionGroups:function(){var b=this;this.optionGroups.lockByType("variant").hideByType("variant"),this.variant&&this.variant.hasVariant()&&a.each(this.variant.getOptionGroups(),function(a,c){b.optionGroups.create(c)});var c=this.optionGroups.$element.find(".form-group");c.sort(function(b,c){var d=a(b).data("optionGroup"),e=a(c).data("optionGroup"),f=d.isRequired(),g=e.isRequired();if(f&&g){var h=d.getType(),i=e.getType();if("variant"===h&&"variant"===i)return 0;if("variant"===h&&"variant"!==i)return 1}else if(!f&&g)return 1;return-1}),c.detach().appendTo(this.optionGroups.$element)},onChildChange:function(){this.calculatePrices(),this.updatePricing(),this.updateAvailability()},updateParentQuantity:function(){this.parentItem&&(1<this.parentItem.getQuantity()?this.$parentQuantity.html(this.parentItem.getQuantity()+"x").show():this.$parentQuantity.hide())},onQuantityChange:function(){this.quantity=this.$quantity.val(),this.totalQuantity=this.quantity,this.parentItem&&(this.totalQuantity=this.quantity*this.parentItem.getTotalQuantity()),a.each(this.bundleSlots,function(){this.updateQuantity()}),this.updateParentQuantity(),this.onChange()},onChange:function(){this.resolveActiveRule(),this.calculatePrices(),this.updatePricing(),this.updateAvailability()},updateAvailability:function(){this.optionGroups.updateAvailability(),this.$availability.empty(),this.$quantity.closest(".form-group").removeClass("has-error"),this.parentItem||!this.$submitButton||this.config.privileged||this.$submitButton.prop("disabled",!1);var b=this.config;if(this.variant&&this.variant.hasVariant()&&(b=this.variant.getConfig()),null!==b.availability){b=a.extend({o_msg:null,min_qty:0,min_msg:null,max_qty:0,max_msg:null,a_qty:0,a_msg:null,r_qty:0,r_msg:null},b.availability);var c=parseFloat(b.min_qty),d="INF"===b.max_qty?Number.POSITIVE_INFINITY:parseFloat(b.max_qty),e=!1,f=[];if(c>this.totalQuantity)f.push(b.min_msg),e=!0;else if(d<this.totalQuantity)f.push(b.max_msg),e=!0;else{if(this.parentItem)return;b.a_msg&&f.push(b.a_msg),this.totalQuantity>b.a_qty&&(b.r_msg?(f.push(b.r_msg),this.totalQuantity>b.a_qty+b.r_qty&&f.push(b.o_msg)):f.push(b.o_msg))}0===f.length&&f.push(b.o_msg),e&&(this.$quantity.closest(".form-group").addClass("has-error"),this.parentItem||!this.$submitButton||this.config.privileged||this.$submitButton.prop("disabled",!0)),this.$availability.html(f.join("<br>"))}},resolveActiveRule:function(){if(0<this.config.rules.length){var b=void 0,c=this.totalQuantity;if(a.each(this.config.rules,function(a,d){if(c>=parseFloat(d.quantity))return b=d,!1}),b!==this.activeRule)return this.activeRule=b,!0}return!1},calculatePrices:function(){var b,c,d=0;0<this.bundleSlots.length?a.each(this.bundleSlots,function(){this.hasChoice()&&(d+=this.getChoice().getUnitPrice()*this.getChoice().getQuantity())}):d=this.variant?this.variant.getPrice():i(this.config.price),d+=this.optionGroups.getPrice(),b=d,this.activeRule&&(b*=1-parseFloat(this.activeRule.percent)/100),c=b*this.totalQuantity;var e=d!==this.basePrice||b!==this.unitPrice||c!==this.totalPrice;return this.basePrice=d,this.unitPrice=b,this.totalPrice=c,e},updatePricing:function(){if(0!==this.$pricing.size()){var c=this,d=this.totalQuantity,e=[],f=[],h={detailed:!1,trans:g.trans,quantity:d,base:this.basePrice,unit:this.unitPrice,basePrice:this.basePrice.formatPrice(c.config.currency),unitPrice:this.unitPrice.formatPrice(c.config.currency),totalPrice:this.totalPrice.formatPrice(c.config.currency)};if(0<this.config.rules.length&&(h.detailed=!0,a(this.config.rules).each(function(a,b){var d=parseFloat(b.percent),e=c.basePrice*(1-d/100);f.push({label:b.label,f_percent:b.percent.toLocaleString()+"%",f_price:e.formatPrice(c.config.currency),active:c.activeRule&&c.activeRule.id===b.id})})),h.rules=f.reverse(),a.each(this.bundleSlots,function(){if(this.hasChoice()){var a=this.getChoice().getUnitPrice()*this.getChoice().getQuantity();e.push({label:this.getLabel(),price:a.formatPrice(c.config.currency)})}}),this.optionGroups.hasOptions()&&(0===e.length&&(this.variant?e.push({label:this.variant.getLabel(),price:this.variant.getPrice().formatPrice(c.config.currency)}):e.push({label:"Base price",price:this.config.price.formatPrice(c.config.currency)})),a.each(this.optionGroups.getGroups(),function(){this.hasOption()&&e.push({label:this.getLabel(),price:this.getPrice().formatPrice(c.config.currency)})})),e.length>0){if(h.detailed=!0,this.activeRule){var i=parseFloat(this.activeRule.percent),j=c.basePrice*i/100;e.push({label:g.trans.discount+" "+i.toLocaleString()+"%",price:"-"+j.formatPrice(c.config.currency)})}e.push({label:g.trans.unit_price,price:this.unitPrice.formatPrice(c.config.currency),"class":"info"})}h.lines=e,this.$pricing.html(b["sale_item_pricing.html.twig"].render(h))}},getConfig:function(){return this.config},getQuantity:function(){return this.quantity},getTotalQuantity:function(){return this.totalQuantity},getUnitPrice:function(){return this.unitPrice},getTotalPrice:function(){return this.totalPrice}}),a.fn.saleItem=function(b){return this.each(function(){void 0===a(this).data("saleItem")&&a(this).data("saleItem",new g(a(this),b))})},a(document).on("click",".sale-item-configure .item-gallery a",function(b){b.preventDefault(),b.stopPropagation();var c=String(a(this).attr("href"));return c.length&&a.fancybox.open({src:c,caption:a(this).attr("title"),protect:!0}),!1}),{init:function(a){a.saleItem()},destroy:function(a){var b=a.data("saleItem");void 0!==b&&b.destroy()}}});