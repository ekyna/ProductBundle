define(["require","jquery","ekyna-product/templates","ekyna-polyfill"],function(d,o,r){"use strict";function h(t,i){t.prop("disabled",i).find("input, select, button, textarea").not('[data-locked="1"]').prop("disabled",i)}var l={net_price:0,offers:[],taxes:[]};function e(t,i,e){this.level=t,this.message=i,this.qty=void 0===e?0:e}l.currency="USD",l.mode="ati",l.calculate=function(i,t,e){if("number"!=typeof this.net_price||this.net_price<0)return 0;(void 0===i||i<1)&&(i=1),void 0===t&&(t=!0),void 0===e&&(e=!0);var n,s="ati"===l.mode?this.net_price:Math.fRound(this.net_price,2),a=void 0;return e||(s*=i),t&&(a=Array.isArray(this.offers)?this.offers.find(function(t){return t.min_qty<=i}):a)&&(s-=Math.fRound(s*a.percent/100,2)),Array.isArray(this.taxes)&&"ati"===l.mode&&(n=s,o.each(this.taxes,function(t,i){s+=Math.fRound(n*i/100,2)})),s},l.display=function(t){var i=l.calculate.call(this,t),t=l.calculate.call(this,t,!1),e="";return(e=t!==i?"<del>"+t.localizedCurrency(l.currency)+"</del>&nbsp;":e)+"<strong>"+i.localizedCurrency(l.currency)+"</strong>&nbsp;<sup>"+("ati"===l.mode?c.trans.ati:c.trans.net)+"</sup>"},e.prototype.getClass=function(){return 3===this.level?"error":0<this.level?"warning":null},e.prototype.hasClass=function(){return 0<this.level},e.prototype.display=function(){return this.message&&0<this.message.length?"<span>"+this.message+"</span>":""},e.prototype.merge=function(t){t&&(t.level>this.level||0===t.level&&t.level===this.level&&t.qty<this.qty)&&(this.level=t.level,this.message=t.message,this.qty=t.qty)};var s={o_msg:"",min_qty:0,min_msg:"",max_qty:0,max_msg:"",a_qty:0,a_msg:"",r_qty:0,r_msg:""};function a(t,a){var e=null;return o.each(t,function(t,i){if(0===i.length)return!0;var n="all"===t.substring(t.lastIndexOf("_")+1),s=n,i=(o.each(i,function(t,i){null===i.c&&console.log("Yup");var e='[data-index="'+(null===i.c?"null":i.c)+'"]';if(a[i.s].$radio.filter(e).is(":checked")){if(!n)return!(s=!0)}else if(n)return!(s=!0)}),t.substring(0,t.indexOf("_")));return s?(e=i,!1):("show"===i&&(e="hide"),!0)}),e}function i(t,i){if(this.$element=t,this.$element.data("bundleSlot",this),void 0===i)throw"Invalid 'parentItem' argument";this.parentItem=i,this.init()}function n(t,i){if(this.$element=t,this.$element.data("optionGroup",this),this.$select=this.$element.find("select"),this.locked=!!this.$select.attr("data-locked"),this.option=void 0,this.$image=void 0,this.id=this.$element.data("id"),this.name=this.$select.attr("name"),!i)throw"Invalid 'optionGroups' argument";this.optionGroups=i,this.init()}function p(t,i){if(this.$element=t,this.$element.data("optionGroups",this),this.name=this.$element.attr("name"),!i)throw"Invalid 'item' argument";this.item=i,this.init()}function u(t,i){if(this.$element=t,this.$element.data("variant",this),this.$image=void 0,this.$info=void 0,this.name=this.$element.attr("name"),!i)throw"Invalid 'item' argument";this.item=i,this.init()}function c(t,i){this.$element=t,this.$element.data("saleItem",this),this.parentItem=i,this.id=this.$element.attr("id"),this.name=this.$element.attr("name"),this.availability={},this.originalPrice=0,this.finalPrice=0,this.$variant=this.variant=void 0,this.init()}return s.resolve=function(t){return this?(void 0===t&&(t=1),("INF"===this.max_qty?Number.POSITIVE_INFINITY:this.max_qty)<t?new e(3,this.max_msg):t<this.min_qty?new e(3,this.min_msg):t>this.a_qty?this.r_msg&&t<=this.a_qty+this.r_qty?new e(1,this.r_msg):new e(2,this.o_msg):new e(0,this.a_msg,this.a_qty)):new e(0)},o.extend(i.prototype,{init:function(){this.busy=!1,this.config=o.extend({required:!1,rules:{}},this.$element.data("config")),this.hidden=!1,this.required=this.config.required,this.$radio=this.$element.find(".slot-buttons input[type=radio]"),this.$label=this.$element.find(".slot-buttons label"),this.$prev=this.$element.find(".slot-choices > a.prev"),this.$next=this.$element.find(".slot-choices > a.next"),this.$element.find(".slot-choice-form[disabled]").each(function(){h(o(this),!0)}),this.clearChoice(),this.bindEvents(),this.selectChoice()},bindEvents:function(){var n;0!==this.$radio.length&&((n=this).$radio.on("change",function(t){return n.selectChoice(),t.preventDefault(),t.stopPropagation(),!1}),this.$label.on("click",function(t){if(n.busy)return t.preventDefault(),t.stopPropagation(),!1}),this.$prev.on("click",function(t){if(n.busy)return t.preventDefault(),t.stopPropagation(),!1;var i=n.$radio.filter(":checked").data("index"),t=o(n.$radio.filter(":not(:disabled)").get().reverse()),e=null;t.each(function(){if(i>o(this).data("index"))return e=o(this),!1}),(e=e&&0!==e.length?e:t.first()).prop("checked",!0),n.selectChoice()}),this.$next.on("click",function(t){if(n.busy)return t.preventDefault(),t.stopPropagation(),!1;var i=n.$radio.filter(":checked").data("index"),t=n.$radio.filter(":not(:disabled)"),e=null;t.each(function(){if(i<o(this).data("index"))return e=o(this),!1}),(e=e&&0!==e.length?e:t.first()).prop("checked",!0),n.selectChoice()}))},unbindEvents:function(){0!==this.$radio.length&&(this.$radio.off("change"),this.$label.off("click"),this.$prev.off("click"),this.$next.off("click"))},destroy:function(){this.unbindEvents(),this.$element.removeData(),this.$choice&&this.$choice.data("saleItem")&&this.$choice.data("saleItem").destroy()},show:function(){var t;this.hidden&&(this.busy=!0,this.hidden=!1,(t=this).$element.slideDown(250,function(){t.busy=!1}))},hide:function(){var t,i;this.hidden||(this.busy=!0,this.hidden=!0,(t=this).$element.slideUp(250,function(){t.busy=!1}),(i=this.$radio.filter('[value=""]').eq(0)).is(":not(:checked)")&&(i.prop("checked",!0),this.selectChoice()))},toggleRequired:function(t){if(t)return this.required?void 0:(this.required=!0,this.$radio.filter('[value=""]').eq(0).prop("disabled",!0).parent("li").hide(),void h(this.$element.find('.slot-choice-form[data-id="0"]').hide(),!0));this.required&&(this.required=!1,this.$radio.filter('[value=""]').eq(0).prop("disabled",!1).parent("li").show(),h(this.$element.find('.slot-choice-form[data-id="0"]'),!1))},selectChoice:function(){if(0===this.$radio.length)return this.$choice=this.$element.find(".slot-choice-form").saleItem(this.parentItem),void(this.choice=this.$choice.data("saleItem"));this.$radio.filter(":checked").is(":disabled")&&this.$radio.filter(":not(:disabled)").eq(0).prop("checked",!0);var t,i=this,e=i.$choice,n=i.choice,s=this.$radio.filter(":checked:not(:disabled)").val()||0,a=this.$element.find('.slot-choice-form[data-id="'+s+'"]');0!==a.length&&a!==e&&(this.busy=!0,t=function(){h(a,!1),i.$choice=a,1===i.$choice.find("input.sale-item-quantity").length?(i.$choice.saleItem(i.parentItem),i.choice=i.$choice.data("saleItem")):i.choice=void 0,i.parentItem.$element.trigger("child_change"),i.$choice.show().fadeIn(250),i.busy=!1},e?e.fadeOut(250,function(){n&&n.destroy(),h(e,!0),t()}):t())},updateState:function(){var i=this.parentItem.bundleSlots,e=!1,n=this;if(this.$radio.filter(':not([value=""])').each(function(){var t=o(this);"hide"===a(t.data("rules"),i)?t.is(":disabled")||(t.prop("disabled",!0).parent("li").hide(),h(n.$element.find('.slot-choice-form[data-id="'+t.prop("val")+'"]').hide(),!0),e=!0):t.is(":not(:disabled)")||(t.prop("disabled",!1).parent("li").show(),h(n.$element.find('.slot-choice-form[data-id="'+t.prop("val")+'"]').show(),!1),e=!0)}),0<this.$radio.filter(':not([value=""]):not(:disabled)').length)switch(a(this.config.rules,i)){case"hide":this.toggleRequired(!1),this.hide(),e=!0;break;case"show":this.toggleRequired(!1),this.show(),e=!0;break;case"required":this.toggleRequired(!0),this.show(),e=!0;break;default:this.toggleRequired(!1),this.show()}else this.toggleRequired(!1),0<this.$radio.length?(this.hide(),e=!0):this.show();return e&&this.$radio.filter(":checked").eq(0).is(":disabled")&&this.selectChoice(),e},updateQuantity:function(){this.choice&&this.choice.onQuantityChange()},hasChoice:function(){return!!this.choice},getChoice:function(){return this.choice},clearChoice:function(){this.$choice=void 0,this.choice=void 0}}),o.fn.bundleSlot=function(t){return this.each(function(){void 0===o(this).data("bundleSlot")&&new i(o(this),t)})},o.extend(n.prototype,{init:function(){this.optionGroups.item.$gallery&&(this.$image=this.optionGroups.item.$gallery.find('a[data-option-id="'+this.$element.data("id")+'"]'),0===this.$image.length&&(this.$image=o('<a data-option-id="'+this.$element.data("id")+'"><img></a>'),this.$image.appendTo(this.optionGroups.item.$gallery.find(".item-gallery-children")))),this.$info=this.$element.find(".sale-item-info"),this.updateState(),this.selectOption(),this.bindEvents()},updateState:function(){this.locked?this.$select.prop("disabled",!0):this.$select.prop("disabled",!1)},bindEvents:function(){var i=this;this.$select.on("change",function(t){return t.preventDefault(),t.stopPropagation(),i.selectOption(),!1})},selectOption:function(){this.optionGroups.$element.trigger("pre_change",[this.option,this.getId()]),this.option=void 0;var t=this.$select.find('option[value="'+this.$select.val()+'"]');1===t.length&&t.data("config")?(this.option=o.extend({id:this.$select.val(),label:null,thumb:null,image:null,pricing:null,availability:null,product:null,groups:[]},t.data("config")),this.$image&&(this.option.thumb?this.$image.show().attr("href",this.option.image).attr("title",t.text()).find("img").attr("src",this.option.thumb):this.$image.hide())):this.$image&&this.$image.hide(),this.updatePricesAndAvailability(),this.optionGroups.$element.trigger("post_change",[this.option,this.getId()])},updatePricesAndAvailability:function(){var t,i,e,n;this.$info.empty(),this.$element.removeClass("has-error has-warning"),this.hasOption()&&(t=this.getTotalQuantity(),e=i="",this.option.availability&&((n=s.resolve.call(this.option.availability,t)).hasClass()&&this.$element.addClass("has-"+n.getClass()),e=n.display()),this.option.pricing&&(i=l.display.call(this.option.pricing,t)),this.$info.html(e+i))},getTotalQuantity:function(){return this.optionGroups.item.getTotalQuantity()},unbindEvents:function(){this.$select.off("change")},destroy:function(){this.unbindEvents(),this.$image&&this.$image.remove(),this.$element.removeData()},getId:function(){return this.id},getName:function(){return this.name},hasOption:function(){return!this.locked&&!!this.option},getOption:function(){return this.option},getChoiceCount:function(){return this.$select.find('option[value]:not([value=""])').length},getAvailability:function(){return this.hasOption()?this.option.availability:null},getOriginalPrice:function(){return this.hasOption()?l.calculate.call(this.option.pricing,this.optionGroups.item.getTotalQuantity(),!1):0},getFinalPrice:function(){return this.hasOption()?l.calculate.call(this.option.pricing,this.optionGroups.item.getTotalQuantity()):0},isLocked:function(){return this.locked},isRequired:function(){return this.$select.prop("required")},getPosition:function(){var t=parseInt(this.$element.data("position")),i=this.getParent();return i instanceof u?t=10*(t+this.optionGroups.getRootGroupsMaxPosition()+1):i instanceof n?t+=i.getPosition()+1:t*=10,t},getParentId:function(){return this.$element.data("parent")},getParent:function(){var t=this.$element.data("parent");if("variant"===t)return this.optionGroups.item.variant;if(0<t){t=this.optionGroups.$element.find('> .form-group[data-id="'+t+'"]');if(1===t.length)return t.data("optionGroup")}return null},lock:function(){return this.locked||(this.$select.attr("data-locked","1"),this.locked=!0),this},unlock:function(){return this.locked&&(this.$select.attr("data-locked","0"),this.locked=!1),this},hide:function(){return this.$element.hide(),this.$image&&this.$image.length&&this.$image.hide(),this},show:function(){return this.$element.show(),this.$image&&this.$image.length&&this.$image.show(),this}}),o.fn.optionGroup=function(t){return this.each(function(){void 0===o(this).data("optionGroup")&&new n(o(this),t)})},o.extend(p.prototype,{init:function(){this.loadGroups()},loadGroups:function(){var i=this;this.$groups=[],this.groups=[],this.$element.find(" > .form-group").each(function(){var t=o(this).optionGroup(i);i.$groups.push(t),i.groups.push(t.data("optionGroup"))})},getGroups:function(){return this.groups},destroy:function(){o.each(this.groups,function(){this.destroy()}),this.$element.removeData()},getOriginalPrice:function(){var t=0;return o.each(this.groups,function(){this.isLocked()||(t+=this.getOriginalPrice())}),t},getFinalPrice:function(){var t=0;return o.each(this.groups,function(){this.isLocked()||(t+=this.getFinalPrice())}),t},createGroups:function(t,e){var n=this,s=!1;o.each(t,function(t,i){s|=n.createGroup(i,e)}),s&&this.sortGroups()},createGroup:function(t,i){if(!t.hasOwnProperty("id"))return!1;var e=this.$element.find('> .form-group[data-id="'+t.id+'"]');if(1===e.length)return e.data("optionGroup").show().unlock().updateState(),e.attr("data-parent",i),!1;t.parent=this.name,(e=o(r["@EkynaProduct/Js/sale_item_option_group.html.twig"].render(t))).appendTo(this.$element),e.optionGroup(this),e.attr("data-parent",i);t=e.data("optionGroup");return this.$groups.push(e),this.groups.push(t),!0},lockGroups:function(t){return this.$element.find('> .form-group[data-parent="'+t+'"]').each(function(){o(this).data("optionGroup").hide().lock().updateState()}),this},resolveAvailability:function(){var i=null;return o.each(this.groups,function(){var t;!this.isLocked()&&this.hasOption()&&(t=s.resolve.call(this.getAvailability(),this.getTotalQuantity()),i?i.merge(t):i=t)}),i},updatePricesAndAvailability:function(){o.each(this.groups,function(){this.updatePricesAndAvailability()})},getRootGroupsMaxPosition:function(){var i=0;return this.$element.find("> .form-group:not([data-parent])").each(function(){var t=o(this).data("position");i<t&&(i=t)}),i},sortGroups:function(){var t=this.$element.find("> .form-group");t.sort(function(t,i){t=o(t).data("optionGroup").getPosition(),i=o(i).data("optionGroup").getPosition();return t!==i?i<t?1:-1:0}),t.detach().appendTo(this.$element)}}),o.fn.optionGroups=function(t){return this.each(function(){void 0===o(this).data("optionGroups")&&new p(o(this),t)})},o.extend(u.prototype,{init:function(){var t;this.item.$gallery&&(this.$image=this.item.$gallery.find("> a"),1===this.$image.length&&(this.$image.data("href",this.$image.attr("href")).data("title",this.$image.attr("title")),(t=this.$image.find("img")).data("src",t.attr("src")))),this.$info=this.$element.closest(".input-group").find(".sale-item-info"),this.selectVariant(),this.bindEvents()},bindEvents:function(){var t=this;this.$element.on("change",function(){t.selectVariant()})},unbindEvents:function(){this.$element.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData()},selectVariant:function(){this.$element.trigger("pre_change",[this.variant,"variant"]),this.variant=void 0;var t=this.$element.find('option[value="'+this.$element.val()+'"]').eq(0);1===t.length&&t.data("config")&&(this.variant=o.extend({id:this.$element.val(),label:null,thumb:null,image:null,pricing:null,availability:null,groups:[]},t.data("config"),{label:t.text()})),this.updatePricesAndAvailability(),this.$image&&(this.hasVariant()&&this.variant.thumb?this.$image.attr("href",this.variant.image).attr("title",this.variant.label).find("img").attr("src",this.variant.thumb):(this.$image.attr("href",this.$image.data("href")).attr("title",this.$image.data("title")),(t=this.$image.find("img")).attr("src",t.data("src")))),this.$element.trigger("post_change",[this.variant,"variant"])},updatePricesAndAvailability:function(){var t,i;this.$info.empty(),this.$element.closest(".form-group").removeClass("has-error has-warning"),this.hasVariant()&&(i=this.item.getTotalQuantity(),t=s.resolve.call(this.variant.availability,i),i=l.display.call(this.variant.pricing,i),t.hasClass()&&this.$element.closest(".form-group").addClass("has-"+t.getClass()),this.$info.html(t.display()+i))},getName:function(){return this.name},hasVariant:function(){return!!this.variant},getVariant:function(){return this.variant},getOptionGroups:function(){return this.variant.groups}}),o.fn.variant=function(t){return this.each(function(){void 0===o(this).data("variant")&&new u(o(this),t)})},c.trans={quantity:"Quantity",discount:"Discount",unit_price:"Unit price",total:"Net total",rule_table:"Your prices",price_table:"Detailed unit price",ati:"ATI",net:"Net",from:"from %min%",range:"from %min% to %max%",add_to_cart:"Add to cart",pre_order:"Pre order"},o.extend(c.prototype,{init:function(){this.config=o.extend({id:null,net_price:0,pricing:{net_price:0,offers:[],taxes:[]},availability:null,privileged:!1},this.$element.data("config"));var n,t=this.$element.data("globals"),t=(t&&(l.mode=t.mode,l.currency=t.currency),this.$element.data("trans")),t=(t&&(c.trans=t),this.$gallery=void 0,o("#"+this.id+"_gallery")),t=(1===t.length&&(this.$gallery=t),this.$quantity=this.$element.find("#"+this.id+"_quantity"),this.quantity=parseFloat(this.$quantity.val()),this.totalQuantity=this.quantity,this.parentItem&&(this.totalQuantity=this.quantity*this.parentItem.getTotalQuantity(),this.$parentQuantity=this.$quantity.parent().find(".sale-item-parent-qty"),0===this.$parentQuantity.length&&(this.$parentQuantity=o('<span class="input-group-addon sale-item-parent-qty"></span>'),this.$parentQuantity.insertBefore(this.$quantity)),this.updateParentQuantity()),this.$pricing=this.$element.find("#"+this.id+"_pricing"),this.$offers=this.$element.find("#"+this.id+"_offers"),this.optionGroups=null,this.$optionGroups=this.$element.find("#"+this.id+"_options").optionGroups(this),this.$optionGroups.length&&(this.optionGroups=this.$optionGroups.data("optionGroups")),this.$element.find("#"+this.id+"_variant")),i=(1===t.length&&(this.$variant=t.variant(this),this.variant=t.data("variant"),this.variant.hasVariant()&&(t=this.variant.getVariant(),this.optionGroups&&this.optionGroups.createGroups(t.groups,"variant"))),this.optionGroups&&o.each((n=this).optionGroups.getGroups(),function(t,i){if(!i.hasOption())return!0;var e=i.getOption();n.optionGroups.createGroups(e.groups,i.getId())}),[]);this.$bundleSlots=this.$element.find("#"+this.id+"_configuration > .bundle-slot"),0<this.$bundleSlots.length&&this.$bundleSlots.bundleSlot(this).each(function(){i.push(o(this).data("bundleSlot"))}),this.bundleSlots=i,o.each(this.bundleSlots,function(){this.updateState()}),this.$availability=this.parentItem?this.$element.find(".sale-item-availability"):this.$element.find(".sale-item-inner .sale-item-availability"),this.$submitButton=void 0,this.parentItem||(this.$submitButton=this.$element.find("button#submit"),0===this.$submitButton.length&&(this.$submitButton=this.$element.closest(".modal-content").find(".bootstrap-dialog-footer button#submit"))),this.optionGroups&&this.optionGroups.sortGroups(),this.bindEvents(),this.onChange()},bindEvents:function(){var n=this;this.$variant&&(this.$variant.on("pre_change",function(t,i,e){i&&n.optionGroups&&n.optionGroups.lockGroups(e)}),this.$variant.on("post_change",function(t,i,e){i&&n.optionGroups&&n.optionGroups.createGroups(i.groups,e),n.onChange()})),this.optionGroups&&(this.$optionGroups.on("pre_change",function(t,i,e){i&&n.optionGroups.lockGroups(e)}),this.$optionGroups.on("post_change",function(t,i,e){i&&n.optionGroups.createGroups(i.groups,e),n.onChange()})),this.$bundleSlots.on("change",function(){n.onChange()}),this.$element.on("child_change",function(t){return t.preventDefault(),t.stopPropagation(),n.onChildChange(),!1}),this.$quantity.on("keyup change mouseup",function(){n.onQuantityChange()})},unbindEvents:function(){this.$variant&&(this.$variant.off("pre_change"),this.$variant.off("post_change")),this.$optionGroups.off("pre_change"),this.$optionGroups.off("post_change"),this.$bundleSlots.off("change"),this.$element.off("child_change"),this.$quantity.off("keyup change mouseup")},destroy:function(){this.unbindEvents(),this.variant&&this.variant.destroy(),o.each(this.bundleSlots,function(){this.destroy()}),this.optionGroups&&this.optionGroups.destroy(),this.$element.removeData()},updateParentQuantity:function(){1<this.parentItem.getQuantity()?this.$parentQuantity.show().html(this.parentItem.getQuantity()+"x"):this.$parentQuantity.hide()},onQuantityChange:function(){this.quantity=parseFloat(this.$quantity.val()),this.totalQuantity=this.quantity,this.parentItem&&(this.updateParentQuantity(),this.totalQuantity=this.quantity*this.parentItem.getTotalQuantity()),this.variant&&this.variant.updatePricesAndAvailability(),this.optionGroups&&this.optionGroups.updatePricesAndAvailability(),o.each(this.bundleSlots,function(){this.updateQuantity()}),this.onChange()},onChildChange:function(){o.each(this.bundleSlots,function(){this.updateState()}),this.onChange()},onChange:function(){this.updatePricesAndAvailability(),this.parentItem&&this.parentItem.$element.trigger("child_change")},resolveAvailability:function(){var i=new e(0);return 0<this.bundleSlots.length?o.each(this.bundleSlots,function(){var t;this.hasChoice()&&(t=this.getChoice().resolveAvailability(),i?i.merge(t):i=t)}):i=this.variant&&this.variant.hasVariant()?s.resolve.call(this.variant.getVariant().availability,this.getTotalQuantity()):s.resolve.call(this.config.availability,this.getTotalQuantity()),this.optionGroups&&i.merge(this.optionGroups.resolveAvailability()),i},updatePricesAndAvailability:function(){var e,n,s=this,t="",i=this.config.pricing,a=this.resolveAvailability();this.originalUnit=0,this.originalPrice=0,this.finalPrice=0,this.$availability.empty(),this.$quantity.closest(".form-group").removeClass("has-error has-warning"),this.$submitButton&&this.$submitButton.prop("disabled",!1),0<this.bundleSlots.length?o.each(this.bundleSlots,function(){this.hasChoice()&&(s.originalUnit+=this.getChoice().getOriginalPrice(),s.originalPrice+=this.getChoice().getOriginalPrice(),s.finalPrice+=this.getChoice().getFinalPrice())}):(this.variant&&this.variant.hasVariant()&&(i=this.variant.getVariant().pricing),this.originalUnit=l.calculate.call(i,this.totalQuantity,!1,!0),this.originalPrice=l.calculate.call(i,this.totalQuantity,!1,!1),this.finalPrice=l.calculate.call(i,this.totalQuantity,!0,!1)),this.optionGroups&&(this.originalUnit+=this.optionGroups.getOriginalPrice(),this.originalPrice+=this.optionGroups.getOriginalPrice()*this.totalQuantity,this.finalPrice+=this.optionGroups.getFinalPrice()*this.totalQuantity),0<this.originalPrice&&this.originalPrice!==this.finalPrice&&(t="<del>"+this.originalPrice.localizedCurrency(l.currency)+"</del>&nbsp;"),t+="<strong>"+this.finalPrice.localizedCurrency(l.currency)+"</strong>&nbsp;<sup>"+c.trans[l.mode]+"</sup>",this.$pricing.html(t),0<i.offers.length?(e=[],n=null,o.each(i.offers,function(t,i){e.push({min:Number(i.min_qty).localizedNumber(),max:n?Number(n).localizedNumber():null,percent:Math.fRound(i.percent,2).localizedNumber(),net_price:Number(s.originalUnit*(1-i.percent/100)).localizedCurrency(l.currency)}),n=i.min_qty-1}),this.$offers.html(r["@EkynaProduct/Js/sale_item_offers.html.twig"].render({trans:c.trans,offers:e.reverse(),quantity:this.totalQuantity}))):this.$offers.empty(),this.$submitButton&&this.$submitButton.text(c.trans.add_to_cart),a.hasClass()&&(this.$quantity.closest(".form-group").addClass("has-"+a.getClass()),this.$submitButton&&(3!==a.level||this.parentItem||!this.$submitButton||this.config.privileged?1===a.level&&this.$submitButton.text(c.trans.pre_order):this.$submitButton.prop("disabled",!0))),this.$availability.html(a.display())},getConfig:function(){return this.config},getQuantity:function(){return this.quantity},getTotalQuantity:function(){return this.totalQuantity},getOriginalPrice:function(){return this.originalPrice},getFinalPrice:function(){return this.finalPrice}}),o.fn.saleItem=function(t){return this.each(function(){void 0===o(this).data("saleItem")&&new c(o(this),t)})},o(document).on("click",".sale-item-configure .item-gallery a",function(t){t.preventDefault(),t.stopPropagation();var i=String(o(this).attr("href"));return i.length&&d(["fancybox"],function(){o.fancybox.open({src:i,caption:o(this).attr("title"),protect:!0})}),!1}),{init:function(t){t.saleItem()},destroy:function(t){t=t.data("saleItem");void 0!==t&&t.destroy()}}});