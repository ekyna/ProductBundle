define(["jquery","ekyna-product/templates","ekyna-number"],function(a,b){"use strict";function c(a){this.$element=a,this.id=a.attr("id"),this.init()}function d(a,b){if(this.$element=a,void 0===b||0===b.size())throw"Invalid '$parent' argument";this.$parent=b,this.init()}function e(a){this.name=a.attr("name"),this.$element=a,this.init()}function f(a){this.$element=a,this.init()}function g(b){this.$element=b,this.id=b.attr("id"),this.config=a.extend({net_price:0,currency:"EUR",rules:[]},this.$element.data("config")),this.init()}return a.extend(c.prototype,{init:function(){this.$radio=this.$element.find(".slot-buttons input[type=radio]"),this.$choice=void 0,this.bindEvents(),this.selectChoice()},bindEvents:function(){var a=this;this.$radio.on("change",function(){a.selectChoice()})},unbindEvents:function(){this.$radio.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData(),this.$choice&&this.$choice.data("saleItem").destroy()},selectChoice:function(){var a=this,b=this.$radio.filter(":checked").val(),c=this.$element.find('.slot-choice-form[data-id="'+b+'"]');if(1===c.size()){var d=function(){a.$choice=c.prop("disabled",!1).saleItem().fadeIn(250),a.$element.trigger("change")};this.$choice?this.$choice.fadeOut(250,function(){a.$choice.data("saleItem").destroy(),a.$choice.prop("disabled",!0),d()}):d()}},getPrice:function(){return this.$choice&&this.$choice.data("saleItem").getTotalPrice(),0}}),a.fn.bundleSlot=function(){return this.each(function(){void 0===a(this).data("bundleSlot")&&a(this).data("bundleSlot",new c(a(this)))})},a.extend(d.prototype,{init:function(){this.$select=this.$element.find("select"),this.bindEvents()},bindEvents:function(){var a=this;this.$select.on("change",function(){a.$parent.trigger("change")})},unbindEvents:function(){this.$select.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData()},getId:function(){return this.$element.data("id")},getType:function(){return this.$element.data("type")},getPrice:function(){var a=this.$select.find('option[value="'+this.$select.val()+'"]');return 1===a.length&&0<a.data("price")?parseFloat(a.data("price")):0}}),a.fn.optionGroup=function(b){return this.each(function(){void 0===a(this).data("optionGroup")&&a(this).data("optionGroup",new d(a(this),b))})},a.extend(e.prototype,{init:function(){this.loadGroups(),this.bindEvents()},loadGroups:function(){this.$groups=this.$element.find(" > .form-group").optionGroup(this.$element)},bindEvents:function(){},unbindEvents:function(){},destroy:function(){this.unbindEvents(),this.$groups.each(function(){a(this).data("optionGroup").destroy()}),this.$element.removeData()},getPrice:function(){var b=0;return this.$groups.each(function(){b+=a(this).data("optionGroup").getPrice()}),b},create:function(c){c.hasOwnProperty("id")&&0!==this.$groups.filter('[data-id="'+c.id+'"]')&&(c.parent=this.name,a(b["sale_item_option_group.html.twig"].render(c)).appendTo(this.$element).optionGroup(this.$element),this.loadGroups())},removeByType:function(b){this.$groups.filter('[data-type="'+b+'"]').each(function(){a(this).data("optionGroup").destroy()}).remove(),this.loadGroups()}}),a.fn.optionGroups=function(){return this.each(function(){void 0===a(this).data("optionGroups")&&a(this).data("optionGroups",new e(a(this)))})},a.extend(f.prototype,{init:function(){this.selectVariant(),this.bindEvents()},bindEvents:function(){var a=this;this.$element.on("change",function(){a.selectVariant()})},unbindEvents:function(){this.$element.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData()},selectVariant:function(){this.$variant=void 0,this.variantConfig=[];var b=this.$element.find('option[value="'+this.$element.val()+'"]');1===b.size()&&b.data("config")&&(this.$variant=b,this.variantConfig=a.extend({price:0,groups:[]},b.data("config")))},hasVariant:function(){return void 0!==this.$variant},getPrice:function(){return this.variantConfig?parseFloat(this.variantConfig.price):0},getOptionGroups:function(){return this.variantConfig?this.variantConfig.groups:[]}}),a.fn.variant=function(){return this.each(function(){void 0===a(this).data("variant")&&a(this).data("variant",new f(a(this)))})},a.extend(g.prototype,{init:function(){this.$bundleSlots=this.$element.find("#"+this.id+"_configuration > .bundle-slot"),console.log("bundle slots",this.$bundleSlots.size()),0<this.$bundleSlots.size()&&this.$bundleSlots.bundleSlot(),this.$optionGroups=this.$element.find("#"+this.id+"_options").optionGroups(this.$element),this.$variant=this.$element.find("#"+this.id+"_variant"),1===this.$variant.size()?this.$variant.variant():this.$variant=void 0,this.$quantity=this.$element.find("#"+this.id+"_quantity"),this.$element.find("#"+this.id+"_pricing").show(),this.$priceTotal=this.$element.find("#"+this.id+"_price_total"),this.$priceHelp=this.$element.find("#"+this.id+"_price_help"),this.quantity=1,this.activeRule=void 0,this.basePrice=0,this.unitPrice=0,this.totalPrice=0,this.bindEvents(),this.onChange()},bindEvents:function(){var a=this;this.$variant&&this.$variant.on("change",function(){a.onVariantChange()}),this.$optionGroups.on("change",function(){a.onChildChange()}),this.$quantity.on("keyup change mouseup",function(){a.onQuantityChange()})},unbindEvents:function(){this.$variant&&this.$variant.variant().off("change"),this.$optionGroups.off("change"),this.$quantity.off("keyup change mouseup")},destroy:function(){this.unbindEvents(),this.$variant&&this.$variant.data("variant").destroy(),this.$optionGroups.data("optionGroups").destroy(),this.$element.removeData()},onVariantChange:function(){var b=this.$optionGroups.data("optionGroups");b.removeByType("variant");var c=this.$variant.data("variant");c.hasVariant()&&a.each(c.getOptionGroups(),function(a,c){b.create(c)}),this.onChildChange()},onChildChange:function(){this.calculatePrices()&&this.updatePriceHelp()},onQuantityChange:function(){var a=this.$quantity.val();a!==this.quantity&&(this.quantity=a,this.onChange())},onChange:function(){var a=this.resolveActiveRule();a|=this.calculatePrices(),a&&this.updatePriceHelp()},resolveActiveRule:function(){if(0<this.config.rules.length){var b=void 0;if(a.each(this.config.rules,function(a,c){if(this.quantity>=parseFloat(c.quantity))return b=c,!1}),b!==this.activeRule)return this.activeRule=b,!0}return!1},calculatePrices:function(){var a,b,c;a=this.$variant?this.$variant.data("variant").getPrice():parseFloat(this.config.net_price),a+=this.$optionGroups.data("optionGroups").getPrice(),b=a,this.activeRule&&(b*=(100-parseFloat(this.activeRule.percent))/100),c=b*this.quantity;var d=a!==this.basePrice||b!==this.unitPrice||c!==this.totalPrice;return this.basePrice=a,this.unitPrice=b,this.totalPrice=c,this.$priceTotal.html(this.totalPrice.formatPrice(this.config.currency)),d},updatePriceHelp:function(){0!==this.$priceHelp.size()&&this.$priceHelp.html("<p>TODO</p>")},getUnitPrice:function(){return this.unitPrice},getTotalPrice:function(){return this.totalPrice}}),a.fn.saleItem=function(){return this.each(function(){void 0===a(this).data("saleItem")&&a(this).data("saleItem",new g(a(this)))})},{init:function(a){a.saleItem()}}});