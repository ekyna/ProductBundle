define(["jquery","jquery-ui/widget","select2","ekyna-commerce/form/price"],function(a){"use strict";return a.widget("ekyna_product.optionType",{_create:function(){if(this.$mode=this.element.find('div.option-mode input[type="radio"]'),this.$price=this.element.find("div.commerce-price"),this.$productWrapper=this.element.find("> .option-product"),this.$dataWrapper=this.element.find("> .option-data"),this.$product=this.$productWrapper.find("select.entity-search"),this.$cascade=this.$productWrapper.find("input.product-cascade"),this.$taxGroup=this.$dataWrapper.find(".tax-group-choice"),2!==this.$mode.length||1!==this.$price.length||1!==this.$product.length||1!==this.$cascade.length||1!==this.$taxGroup.length)throw"Missing product option type fields";this._on(this.$mode,{change:this._onModeChange}),this._onModeChange()},_destroy:function(){this._off(this.$mode,"change"),this._off(this.$product,"change"),this._off(this.$taxGroup,"change"),this.$mode=void 0,this.$product=void 0,this.$taxGroup=void 0},_onModeChange:function(){this.$dataWrapper.hide(),this.$productWrapper.hide(),this._off(this.$taxGroup,"change"),this._off(this.$product,"change");var a=this.$mode.filter(":checked").val();"product"===a?(this._on(this.$product,{change:this._onProductChange}),this._onProductChange(),this.$productWrapper.show()):"data"===a&&(this._on(this.$taxGroup,{change:this._onTaxGroupChange}),this._onTaxGroupChange(),this.$dataWrapper.show())},_onProductChange:function(){var b=null,c=this.$product.select2("data");if(c&&c[0])if(c[0].tax_group)b=c[0].tax_group;else{var d=a(c[0].element).data("entity");d&&d.tax_group&&(b=d.tax_group)}this.$price.priceType("option","taxes",this._getTaxes(b))},_onTaxGroupChange:function(){this.$price.priceType("option","taxes",this._getTaxes(this.$taxGroup.val()))},_getTaxes:function(b){if(!b)return[];var c=[],d=this.$taxGroup.find('option[value="'+b+'"]').data("taxes");return d&&a.each(d,function(a,b){c.push(b.rate)}),c},save:function(){var a=this.$mode.filter(":checked").val();"data"===a?(this.$product.val(void 0).find("option:selected").prop("selected",!1),this.$cascade.prop("checked",!1)):"product"===a&&this.$dataWrapper.find("input, select").val(void 0)}}),{init:function(a){a.optionType()},save:function(a){a.data("ekyna_product.optionType")&&a.optionType("save")},destroy:function(a){a.data("ekyna_product.optionType")&&a.optionType("destroy")}}});