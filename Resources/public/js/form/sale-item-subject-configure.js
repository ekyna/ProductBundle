define(["jquery","ekyna-product/templates","ekyna-number"],function(a,b){"use strict";function c(a,b){if(this.$element=a,void 0===b||0===b.size())throw"Invalid '$groups' argument";this.$parent=b,this.init()}function d(a){this.name=a.attr("name"),this.$element=a,this.init()}function e(a){this.$element=a,this.init()}function f(a,b){this.$element=a,this.$parent=b,this.name=a.attr("name"),this.config=this.$element.data("config"),this.init()}return a.extend(c.prototype,{init:function(){this.$select=this.$element.find("select"),this.bindEvents()},bindEvents:function(){var a=this;this.$select.on("change",function(){a.$parent.trigger("change")})},unbindEvents:function(){this.$select.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData()},getId:function(){return this.$element.data("id")},getType:function(){return this.$element.data("type")},getPrice:function(){var a=this.$select.find('option[value="'+this.$select.val()+'"]');return 1===a.length&&0<a.data("price")?parseFloat(a.data("price")):0}}),a.fn.optionGroup=function(b){return this.each(function(){void 0===a(this).data("optionGroup")&&a(this).data("optionGroup",new c(a(this),b))})},a.extend(d.prototype,{init:function(){this.loadGroups(),this.bindEvents()},loadGroups:function(){this.$groups=this.$element.find(" > .form-group").optionGroup(this.$element)},bindEvents:function(){},unbindEvents:function(){},destroy:function(){this.unbindEvents(),this.$groups.each(function(){a(this).data("optionGroup").destroy()}),this.$element.removeData()},getPrice:function(){var b=0;return this.$groups.each(function(){b+=a(this).data("optionGroup").getPrice()}),b},create:function(c){c.hasOwnProperty("id")&&0!==this.$groups.filter('[data-id="'+c.id+'"]')&&(c.parent=this.name,a(b["sale_item_option_group.html.twig"].render(c)).appendTo(this.$element).optionGroup(this.$element),this.loadGroups())},removeByType:function(b){this.$groups.filter('[data-type="'+b+'"]').each(function(){a(this).data("optionGroup").destroy()}).remove(),this.loadGroups()}}),a.fn.optionGroups=function(){return this.each(function(){void 0===a(this).data("optionGroups")&&a(this).data("optionGroups",new d(a(this)))})},a.extend(e.prototype,{init:function(){this.$variant=void 0,this.selectVariant(),this.bindEvents()},bindEvents:function(){var a=this;this.$element.on("change",function(){a.selectVariant()})},unbindEvents:function(){this.$element.off("change")},destroy:function(){this.unbindEvents(),this.$element.removeData()},selectVariant:function(){this.$variant=void 0;var a=this.$element.find('option[value="'+this.$element.val()+'"]');1===a.size()&&0<a.data("price")&&(this.$variant=a)},hasVariant:function(){return void 0!==this.$variant},getPrice:function(){return this.$variant?parseFloat(this.$variant.data("price")):0},getOptionGroups:function(){return this.$variant?this.$variant.data("optionGroups"):[]}}),a.fn.variant=function(){return this.each(function(){void 0===a(this).data("variant")&&a(this).data("variant",new e(a(this)))})},a.extend(f.prototype,{init:function(){this.$optionGroups=this.$element.find("#"+this.name+"_options").optionGroups(this.$element),this.$variant=this.$element.find("#"+this.name+"_variant"),1===this.$variant.size()?this.$variant.variant():this.$variant=void 0,this.$quantity=this.$element.find("#"+this.name+"_quantity"),this.$element.find("#"+this.name+"_pricing").show(),this.$priceTotal=this.$element.find("#"+this.name+"_price_total"),this.$priceHelp=this.$element.find("#"+this.name+"_price_help"),this.quantity=1,this.activeRule=void 0,this.basePrice=0,this.unitPrice=0,this.totalPrice=0,this.bindEvents(),this.onChange()},bindEvents:function(){var a=this;this.$variant&&this.$variant.on("change",function(){a.onVariantChange()}),this.$optionGroups.on("change",function(){a.onChildChange()}),this.$quantity.on("keyup change mouseup",function(){a.onQuantityChange()})},unbindEvents:function(){this.$variant&&this.$variant.variant().off("change"),this.$optionGroups.off("change"),this.$quantity.off("keyup change mouseup")},destroy:function(){this.unbindEvents(),this.$variant&&this.$variant.data("variant").destroy(),this.$optionGroups.data("optionGroups").destroy(),this.$element.removeData()},onVariantChange:function(){var b=this.$optionGroups.data("optionGroups");b.removeByType("variant");var c=this.$variant.data("variant");c.hasVariant()&&a.each(c.getOptionGroups(),function(a,c){b.create(c)}),this.onChildChange()},onChildChange:function(){this.calculatePrices()&&this.updatePriceHelp()},onQuantityChange:function(){var a=this.$quantity.val();a!==this.quantity&&(this.quantity=a,this.onChange())},onChange:function(){var a=this.resolveActiveRule();a|=this.calculatePrices(),a&&this.updatePriceHelp()},resolveActiveRule:function(){var b;return 0<this.config.rules.length&&(a.each(this.config.rules,function(a,c){if(this.quantity>=parseFloat(c.quantity))return b=c,!1}),b!==this.activeRule)&&(this.activeRule=b,!0)},calculatePrices:function(){var a,b,c;a=this.$variant?this.$variant.data("variant").getPrice():parseFloat(this.config.net_price),a+=this.$optionGroups.data("optionGroups").getPrice(),b=a,this.activeRule&&(b*=(100-parseFloat(this.activeRule.percent))/100),c=b*this.quantity;var d=a!==this.basePrice||b!==this.unitPrice||c!==this.totalPrice;return this.basePrice=a,this.unitPrice=b,this.totalPrice=c,this.$priceTotal.html(this.totalPrice.formatPrice(this.config.currency)),d},updatePriceHelp:function(){0!==this.$priceHelp.size()&&this.$priceHelp.html("<p>TODO</p>")},getUnitPrice:function(){return this.unitPrice},getTotalPrice:function(){return this.totalPrice}}),a.fn.saleItem=function(){return this.each(function(){void 0===a(this).data("saleItem")&&a(this).data("saleItem",new f(a(this)))})},{init:function(a){a.saleItem()}}});