define(["require","jquery","routing","ekyna-dispatcher","ekyna-product/templates","ekyna-modal","ekyna-admin/barcode-scanner","ekyna-clipboard-copy"],function(n,u,s,c,p,f,y){const m=u(window),_=u("#inventory thead"),a=u("#inventory tbody"),k=u("#inventory tfoot"),t=u("#inventory_wait").detach(),v=u("#inventory_none").detach(),o=u('form[name="inventory"]');let l=!1,e;let r=!1,i=-1;function h(){e&&e.abort(),a.empty(),r=!1,i=-1,g()}function g(){e&&e.abort(),r||(l=!0,v.detach(),t.appendTo(a),i++,(e=u.ajax({url:s.generate("admin_ekyna_product_inventory_products",{page:i}),method:"GET",dataType:"json",data:function(){var t=o.serializeArray();let e={};for(let n=0;n<t.length;n++)t[n].value&&(e[t[n].name]=t[n].value);return e}()})).done(T),e.always(function(){l=!1}))}function b(){let n=m.height()-o.outerHeight()-_.outerHeight()-k.outerHeight();n<0&&(n=0),a.height(n)}function d(n,t,e,o){if(n.preventDefault(),n.stopPropagation(),l)return!1;if(l=!0,o=o||T,!0===(e=e||{})){n=u(n.currentTarget).parents("tr").eq(0).data("id");if(!n)return console.log("Undefined product id."),!1;e={productId:n}}try{const a=new f;a.load({url:s.generate(t,e),method:"GET"}),u(a).on("ekyna.modal.response",function(n){l=!1,"json"===n.contentType&&(n.preventDefault(),o(n.content),n.modal.close())}),u(a).on("ekyna.modal.load_fail",function(){l=!1})}catch(n){console.log(n),l=!1}return!1}function T(n){if(!n.hasOwnProperty("products")||0===n.products.length)return 0===i&&v.appendTo(a),void(r=!0);n.update||t.detach(),u.each(n.products,function(n,t){const e=u(p["@EkynaProduct/Js/inventory_line.html.twig"].render(t)),o=a.find("tr[data-id="+t.id+"]");1===o.length?o.replaceWith(e):e.appendTo(a)}),n.update||(n.products.length<30?r=!0:t.appendTo(a))}y.init({}),y.addListener(function(n){e&&e.abort(),a.empty(),v.detach(),t.appendTo(a),r=!1,l=!0,i=0,(e=u.ajax({url:s.generate("admin_ekyna_product_inventory_products",{page:i}),method:"GET",dataType:"json",data:{referenceCode:n}})).done(T),e.always(function(){l=!1})}),a.on("click","a.bookmark",function(n){const t=u(n.currentTarget).closest("a"),e=t.hasClass("fa-bookmark-o"),o=e?"admin_ekyna_product_product_bookmark_add":"admin_ekyna_product_product_bookmark_remove";{var a=o,r=!0,i=e?"POST":"DELETE",d=function(){e?t.removeClass("fa-bookmark-o").addClass("fa-bookmark"):t.removeClass("fa-bookmark").addClass("fa-bookmark-o")};if(i=i||"GET",n.preventDefault(),n.stopPropagation(),l)return!1;if((l=!0)===(r=r||{})){n=u(n.currentTarget).parents("tr").eq(0).data("id");if(!n)return console.log("Undefined product id."),!1;r={productId:n}}const c=u.ajax({url:s.generate(a,r),method:i});return c.done(d||T),void c.always(function(){l=!1})}}),a.on("click","a.quick-edit",function(n){return d(n,"admin_ekyna_product_inventory_quick_edit",!0)}),a.on("click","a.print-label",function(n){n=u(n.currentTarget).parents("tr").eq(0).data("id");if(!n)return console.log("Undefined product id."),!1;n=s.generate("admin_ekyna_product_product_label",{format:"large",id:[n]});const t=window.open(n,"_blank");t.focus()}),o.on("submit",function(n){var t=n.originalEvent??n;return!(!t.submitter||"inventory_export"!==t.submitter.id)||(n.preventDefault(),n.stopPropagation(),h(),!1)}),o.on("reset",function(){o.find("table input").val(null).attr("value",null),o.find("table select").val(null).find("option").prop("selected",!1),h()}),a.on("click","a.quick-edit",function(n){return d(n,"admin_ekyna_product_inventory_quick_edit",!0)}),a.on("click","a.stock-units",function(n){return d(n,"admin_ekyna_product_inventory_stock_units",!0)}),a.on("click","a.treatment",function(n){return d(n,"admin_ekyna_product_inventory_customer_orders",!0)}),a.on("click","a.resupply",function(n){return d(n,"admin_ekyna_product_inventory_resupply",!0)}),u('button[name="batch_submit"]').on("click",function(n){let t=[];return u("#inventory").serializeArray().forEach(function(n){t.push(n.value)}),t.length<=1?(alert("Please select some products"),!1):d(n,"admin_ekyna_product_inventory_batch_edit",{id:t})}),_.on("click","th.sort a",function(n){n.preventDefault(),n.stopPropagation();const t=u(n.currentTarget);let e="none";return t.hasClass("none")?e="asc":t.hasClass("asc")&&(e="desc"),_.find("th.sort a").removeClass("asc desc").addClass("none"),"none"!==e?(t.removeClass("none").addClass(e),o.find('input[name="inventory[sortBy]"]').val(t.data("by")),o.find('input[name="inventory[sortDir]"]').val(e)):(o.find('input[name="inventory[sortBy]"]').val(null),o.find('input[name="inventory[sortDir]"]').val(null)),o.trigger("submit"),!1}),c.on("ekyna_commerce.stock_units.change",function(){h()}),h(),m.on("resize",b),b(),a.on("scroll",function(){l||r||t.offset().top<a.height()+o.outerHeight()+_.outerHeight()&&g()}),n(["ekyna-admin/summary"],function(n){n.init()}),n(["ekyna-admin/side-detail"],function(n){n.init()})});