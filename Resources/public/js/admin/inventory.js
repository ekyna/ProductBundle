define(["require","jquery","routing","ekyna-product/templates","ekyna-modal","ekyna-admin/barcode-scanner","ekyna-clipboard-copy"],function(s,t,r,i,p,e){const d=t("#inventory_list"),f=t("#inventory_wait"),u=t("#inventory_none"),a="admin_ekyna_product_inventory_app_",n=t("#display_valid"),o=t("#display_end_of_life");let l=!1,h=n.prop("checked"),y=o.prop("checked");function c(){h?d.addClass("display-valid"):d.removeClass("display-valid"),y?d.addClass("display-end-of-life"):d.removeClass("display-end-of-life")}function v(e){const n=t(i["@EkynaProduct/Js/inventory_line.html.twig"].render(e)),o=d.find("div[data-id="+e.id+"]");1===o.length?o.replaceWith(n):n.appendTo(d)}function k(e,n,o){if(confirm(o)){o=t(e.currentTarget).parents("div").eq(1).data("id");if(!o)throw new Error("Undefined id");if(l)return!1;l=!0,fetch(r.generate(a+n,{id:o}),{method:"POST",headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error("Request failed");return e.json()}).then(e=>{console.log(e),e.hasOwnProperty("product")&&"object"==typeof e.product&&v(e.product)}).finally(()=>{l=!1})}}l||(l=!0,f.show(),u.hide(),d.empty(),fetch(r.generate(a+"list"),{headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to fetch product list");return e.json()}).then(e=>{if(console.log(e),e.hasOwnProperty("products")&&e.products instanceof Array)if(0!==e.products.length){for(const n of e.products)t(i["@EkynaProduct/Js/inventory_line.html.twig"].render(n)).appendTo(d);c()}else u.show()}).finally(()=>{l=!1,f.hide()})),n.on("change",()=>{h=n.prop("checked"),c()}),o.on("change",()=>{y=o.prop("checked"),c()}),d.on("click","a.count",e=>{var n="count";if(!(e=t(e.currentTarget).parents("div").eq(1).data("id")))throw new Error("Undefined id");if(l)return!1;l=!0;try{const o=new p;o.load({url:r.generate(a+n,{id:e}),method:"GET"}),t(o).on("ekyna.modal.response",function(e){l=!1,"json"===e.contentType&&(e.preventDefault(),v(e.content.product),e.modal.close())}),t(o).on("ekyna.modal.load_fail",function(){l=!1})}catch(e){console.log(e),l=!1}return!1}),d.on("click","a.validate",e=>k(e,"validate","Valider le stock ?")),d.on("click","a.end-of-life",e=>k(e,"end_of_life","Confirmer «En fin de vie» ?")),e.init({}),e.addListener(e=>{d.find("> div").removeClass("focus");let n=d.find('div[data-gtin="'+e+'"]');0!==n.length&&(n.addClass("focus"),e=n.offset().top,t("html, body").scrollTop(e-50))})});