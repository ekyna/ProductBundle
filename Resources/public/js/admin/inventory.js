define(["require","jquery","routing","ekyna-product/templates","ekyna-modal","ekyna-admin/barcode-scanner","ekyna-clipboard-copy"],function(s,t,d,r,p,f){const i=t("#inventory_list"),u=t("#inventory_wait"),y=t("#inventory_none"),a="admin_ekyna_product_inventory_app_",h=t("#reload_list"),e=t("#display_zero"),v=t("#display_bundle"),n=t("#display_valid"),o=t("#display_end_of_life");let l=!1,k=e.prop("checked"),m=n.prop("checked"),_=v.prop("checked"),g=o.prop("checked");function c(){k?i.addClass("display-zero"):i.removeClass("display-zero"),_?i.addClass("display-bundle"):i.removeClass("display-bundle"),m?i.addClass("display-valid"):i.removeClass("display-valid"),g?i.addClass("display-end-of-life"):i.removeClass("display-end-of-life")}function w(){l||(l=!0,u.show(),y.hide(),i.empty(),fetch(d.generate(a+"list"),{headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to fetch product list");return e.json()}).then(e=>{if(console.log(e),e.hasOwnProperty("products")&&e.products instanceof Array)if(0!==e.products.length){for(const n of e.products)t(r["@EkynaProduct/Js/inventory_line.html.twig"].render(n)).appendTo(i);c()}else y.show()}).finally(()=>{l=!1,u.hide()}))}function C(e){const n=t(r["@EkynaProduct/Js/inventory_line.html.twig"].render(e)),o=i.find("div[data-id="+e.id+"]");1===o.length?o.replaceWith(n):n.appendTo(i)}function b(e,n,o){if(confirm(o)){o=t(e.currentTarget).parents("div").eq(1).data("id");if(!o)throw new Error("Undefined id");if(l)return!1;l=!0,fetch(d.generate(a+n,{id:o}),{method:"POST",headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error("Request failed");return e.json()}).then(e=>{console.log(e),e.hasOwnProperty("product")&&"object"==typeof e.product&&C(e.product)}).finally(()=>{l=!1})}}w(),h.on("click",()=>{h.blur(),w()}),e.on("change",()=>{k=e.prop("checked"),e.blur(),c()}),n.on("change",()=>{m=n.prop("checked"),n.blur(),c()}),o.on("change",()=>{g=o.prop("checked"),o.blur(),c()}),i.on("click","a.count",e=>{var n="count";if(!(e=t(e.currentTarget).parents("div").eq(1).data("id")))throw new Error("Undefined id");if(l)return!1;l=!0;try{const o=new p;o.load({url:d.generate(a+n,{id:e}),method:"GET"}),t(o).on("ekyna.modal.response",function(e){l=!1,"json"===e.contentType&&(e.preventDefault(),C(e.content.product),e.modal.close())}),t(o).on("ekyna.modal.load_fail",function(){l=!1})}catch(e){console.log(e),l=!1}return!1}),i.on("click","a.validate",e=>b(e,"validate","Valider le stock ?")),i.on("click","a.end-of-life",e=>b(e,"end_of_life","Confirmer «En fin de vie» ?")),f.init({}),f.addListener(e=>{i.find("> div").removeClass("focus");let n=i.find('div[data-gtin="'+e+'"]');0!==n.length&&(n.addClass("focus"),e=n.offset().top,t("html, body").scrollTop(e-50))})});