{%- macro show_designation(product, options = {}) -%}
    {{- show_row(product.designation, 'text', {
        'label': t('field.designation', [], 'EkynaUi'),
        'id': 'product_designation'
    }|merge(options)) -}}
{%- endmacro show_designation -%}


{%- macro show_visible(product, options = {}) -%}
    {{- show_row(product.visible, 'boolean', {
        'label': t('field.visible', [], 'EkynaUi'),
        'id': 'product_visible',
        'color': true
    }|merge(options)) -}}
{%- endmacro show_visible -%}


{%- macro show_visibility(product, options = {}) -%}
    {{- show_row(product.visibility, 'number', {
        'label': t('common.visibility', [], 'EkynaProduct'),
        'id': 'product_visibility'
    }|merge(options)) -}}
{%- endmacro show_visibility -%}


{%- macro show_best_seller(product, options = {}) -%}
    {{- show_row(product|product_best_seller_badge, 'text', {
        'label': t('product.field.best_seller', [], 'EkynaProduct'),
        'id': 'product_best_seller'
    }|merge(options)) -}}
{%- endmacro show_best_seller -%}


{%- macro show_cross_selling(product, options = {}) -%}
    {{- show_row(product|product_cross_selling_badge, 'text', {
        'label': t('product.field.cross_selling', [], 'EkynaProduct'),
        'id': 'product_cross_selling'
    }|merge(options)) -}}
{%- endmacro show_cross_selling -%}


{%- macro show_brand(product, options = {}) -%}
    {{- show_row(product.brand, 'resource', {
        'resource': 'ekyna_product.brand',
        'id': 'product_brand'
    }|merge(options)) -}}
{%- endmacro show_brand -%}


{%- macro show_brandNaming(product, options = {}) -%}
    {{- show_row(product.brandNaming, 'boolean', {
        'label': t('product.field.brand_naming', [], 'EkynaProduct'),
        'id': 'product_brandNaming',
        'color': true,
        'false_class': 'label label-default'
    }|merge(options)) -}}
{%- endmacro show_brandNaming -%}


{%- macro show_categories(product, options = {}) -%}
    {{- show_row(product.categories, 'resource', {
        'resource': 'ekyna_product.category',
        'id': 'product_categories'
    }|merge(options)) -}}
{%- endmacro show_categories -%}


{%- macro show_customer_groups(product, options = {}) -%}
    {{- show_row(product.customerGroups, 'resource', {
        'resource': 'ekyna_commerce.customer_group',
        'id': 'product_customerGroups'
    }|merge(options)) -}}
{%- endmacro show_customer_groups -%}


{%- macro show_released_at(product, options = {}) -%}
    {{- show_row(product.releasedAt, 'datetime', {
        'label': t('product.field.released_at', [], 'EkynaProduct'),
        'date_format': 'short',
        'time_format': 'none',
        'id': 'product_releasedAt'
    }|merge(options)) -}}
{%- endmacro show_released_at -%}


{%- macro show_reference(product, options = {}) -%}
    {{- show_row(product.reference, 'text', {
        'label': t('field.reference', [], 'EkynaUi'),
        'id': 'product_reference',
        'attr': {
            'data-clipboard-copy': product.reference
        }
    }|merge(options)) -}}
{%- endmacro show_reference -%}


{%- macro show_translations(product, options = {}) -%}
    {% if product is variant_product %}
        {% set fields = {
            'title': {'label': t('field.title', [], 'EkynaUi')},
            'attributesTitle': {'label': t('product.field.attributes_title', [], 'EkynaProduct')},
            'subTitle': {'label': t('field.subtitle', [], 'EkynaUi')},
            'description': {
                'label': t('field.description', [], 'EkynaUi'),
                'type': 'tinymce',
                'property_path': null,
                'options': {
                    'height': 150,
                    'field' : 'description'
                }
            }
        } %}
    {% else %}
        {% set fields = {
            'title': {'label': t('field.title', [], 'EkynaUi')},
            'slug': {'label': t('field.url', [], 'EkynaUi')},
            'subTitle': {'label': t('field.subtitle', [], 'EkynaUi')},
            'description': {
                'label': t('field.description', [], 'EkynaUi'),
                'type': 'tinymce',
                'property_path': null,
                'options': {
                    'height': 150,
                    'field' : 'description'
                }
            }
        } %}
    {% endif %}
    {{- show_row(product.translations, 'translations', {
        'id': 'product_translations',
        'fields': fields
    }|merge(options)) -}}
{%- endmacro show_translations -%}


{%- macro show_attribute_set(product, options = {}) -%}
    {{- show_row(product.attributeSet, 'resource', {
        'label': t('attribute_set.label.singular', [], 'EkynaProduct'),
        'resource': 'ekyna_product.attribute_set',
        'id': 'product_attributeSet'
    }|merge(options)) -}}
{%- endmacro show_attribute_set -%}


{%- macro show_variable(product, options = {}) -%}
    {{- show_row(product.parent, 'resource', {
        'label': t('product.field.parent', [], 'EkynaProduct'),
        'resource': 'ekyna_product.product',
        'id': 'product_parent'
    }|merge(options)) -}}
{%- endmacro show_variable -%}


{%- macro show_medias(product, options = {}) -%}
    {{- show_row(product.medias, 'media_medias', {
        'label': t('field.medias', [], 'EkynaUi'),
        'id': 'product_medias'
    }|merge(options)) -}}
{%- endmacro show_medias -%}


{%- macro show_notContractual(product, options = {}) -%}
    {{- show_row(product.notContractual, 'boolean', {
        'label': t('product.field.not_contractual', [], 'EkynaProduct'),
        'id': 'product_notContractual',
        'color': true,
        'true_class': 'label label-warning',
        'false_class': 'label label-default'
    }|merge(options)) -}}
{%- endmacro show_notContractual -%}


{%- macro show_min_price(product, options = {}) -%}
    {{- show_row(product.minPrice|format_currency(commerce_default_currency), 'text', {
        'label': t('product.field.min_price', [], 'EkynaProduct'),
        'id': 'product_minPrice',
    }|merge(options)) -}}
{%- endmacro show_min_price -%}


{%- macro show_net_price(product, options = {}) -%}
    {{- show_row(product.netPrice|format_currency(commerce_default_currency), 'text', {
        'label': t('field.net_price', [], 'EkynaCommerce'),
        'id': 'product_netPrice',
    }|merge(options)) -}}
{%- endmacro show_net_price -%}


{%- macro show_tax_group(product, options = {}) -%}
    {{- show_row(product.taxGroup, 'resource', {
        'label': t('tax_group.label.singular', [], 'EkynaCommerce'),
        'resource': 'ekyna_commerce.tax_group',
        'id': 'product_taxGroup'
    }|merge(options)) -}}
{%- endmacro show_tax_group -%}


{%- macro show_references(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'product_reference.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-block" id="product_references">
                {%- if product.references is not empty -%}
                    <dl class="dl-horizontal">
                        {%- for reference in product.references -%}
                            <dt>{{ reference|product_reference_type_label }}</dt>
                            <dd data-clipboard-copy="{{ reference.code }}">{{ reference.code }}</dd>
                        {%- endfor -%}
                    </dl>
                {%- else -%}
                    <em>{{ 'value.none'|trans({}, 'EkynaUi') }}</em>
                {%- endif -%}
            </div>
        </div>
    </div>
{%- endmacro show_references -%}


{%- macro show_attributes(product, options = {}) -%}
    {%- if product is simple_product or product is variant_product -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'attribute.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-block" id="product_attributes">
                <dl class="dl-horizontal">
                    {%- for attribute in product.attributes -%}
                    <dt>{{ attribute.attributeSlot.attribute.name }}</dt>
                    <dd>{{ attribute|product_attribute }}</dd>
                    {%- endfor -%}
                </dl>
            </div>
        </div>
    </div>
    {%- endif -%}
{%- endmacro show_attributes -%}


{%- macro show_adjustments(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'adjustment.label.plural'|trans({}, 'EkynaCommerce') -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-block" id="product_adjustments">
                <table class="table table-stripped table-condensed table-hover table-alt-head">
                    <tr>
                        <th>{{ 'field.designation'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'field.type'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'field.mode'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'field.amount'|trans({}, 'EkynaUi') }}</th>
                    </tr>
                    {%- for adjustment in product.adjustments -%}
                        <tr>
                            <td>{{ adjustment.designation }}</td>
                            <td class="text-right">{{ adjustment.type|adjustment_type_label }}</td>
                            <td class="text-right">{{ adjustment.mode|adjustment_mode_label }}</td>
                            <td class="text-right">{{ adjustment.amount|format_currency(commerce_default_currency) }}</td>
                        </tr>
                        {# TODO translations ? #}
                    {%- else -%}
                        <tr>
                            <td colspan="4">
                                {{- 'value.none'|trans({}, 'EkynaUi') -}}
                            </td>
                        </tr>
                    {%- endfor -%}
                </table>
            </div>
        </div>
    </div>
{%- endmacro show_adjustments -%}


{%- macro show_option_groups(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'option_group.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            {%- if product.optionGroups|length -%}
            <div class="show-widget show-widget-sm">
                {%- for group in product.optionGroups -%}
                <div class="collection-item">
                    {%- set groupId = 'product_optionGroups_' ~ loop.index0 ~ '_' -%}
                    {{- show_row(group.name, 'text', {
                        'label': t('field.name', [], 'EkynaUi'),
                        'id': groupId ~ 'name'
                    }) -}}
                    <div class="row">
                        <div class="col-md-6">
                            {{- show_row(group.required, 'boolean', {
                                'label': t('field.required', [], 'EkynaUi'),
                                'id': groupId ~ 'required',
                                'label_col': 4,
                                'color': true
                            }) -}}
                        </div>
                        <div class="col-md-6">
                            {{- show_row(group.fullTitle, 'boolean', {
                                'label': t('option_group.field.full_title', [], 'EkynaProduct'),
                                'id': groupId ~ 'fullTitle',
                                'label_col': 4
                            }) -}}
                        </div>
                    </div>
                    {{- show_row(group.translations, 'translations', {
                        'id': groupId ~ 'translations',
                        'fields': {
                            'title': {'label': t('field.title', [], 'EkynaUi')},
                        }
                    }) -}}
                    <div class="row show-row">
                        <div class="col-md-2 show-label">
                            {{- 'option.label.plural'|trans({}, 'EkynaProduct') -}}
                        </div>
                        <div class="col-md-10">
                            <div class="show-widget">
                                <table class="table table-stripped table-condensed table-hover table-alt-head">
                                    <tr>
                                        <th>{{ 'field.designation'|trans({}, 'EkynaUi') }}</th>
                                        <th>{{ 'field.reference'|trans({}, 'EkynaUi') }}</th>
                                        <th class="text-right">{{ 'field.weight'|trans({}, 'EkynaUi') }}</th>
                                        <th class="text-right">{{ 'field.price'|trans({}, 'EkynaUi') }}</th>
                                        <th class="text-right">{{ 'field.group'|trans({}, 'EkynaUi') }}</th>
                                    </tr>
                                    {%- for option in group.options -%}
                                    {%- set optionId = groupId ~ 'options_' ~ loop.index0 ~ '_' -%}
                                    {%- set data = option.product ?: option -%}
                                    <tr>
                                        <td id="{{ optionId ~ 'designation' }}">
                                        {%- if option.product -%}
                                            <a href="{{ admin_resource_path(option.product) }}"
                                               data-summary='{{ {
                                                   'route': 'admin_ekyna_product_product_summary',
                                                   'parameters': {'productId': option.product.id}
                                               }|json_encode }}'>
                                                {{- option.product.fullDesignation -}}
                                            </a>
                                        {%- else -%}
                                            {{- data.designation -}}
                                        {%- endif -%}
                                        </td>
                                        <td id="{{ optionId ~ 'reference' }}" data-clipboard-copy="{{ data.reference }}">
                                            {{- data.reference -}}
                                        </td>
                                        <td id="{{ optionId ~ 'weight' }}" class="text-right">
                                            {{- data.weight|format_number ~ ' kg' -}}
                                        </td>
                                        <td id="{{ optionId ~ 'netPrice' }}" class="text-right">
                                        {%- if option.product and option.netPrice is same as(null) -%}
                                            {{- option.product.netPrice|format_currency(commerce_default_currency) -}}
                                        {%- else -%}
                                            {{- option.netPrice|format_currency(commerce_default_currency) -}}
                                        {%- endif -%}
                                        </td>
                                        <td id="{{ optionId ~ 'taxGroup' }}" class="text-right">
                                            {{- data.taxGroup -}}
                                        </td>
                                    </tr>
                                    {# TODO translations ? #}
                                    {%- endfor -%}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {%- endfor -%}
            </div>
            {%- else -%}
            <div class="show-widget show-widget-inline">
                <em>{{ 'value.none'|trans({}, 'EkynaUi') }}</em>
            </div>
            {%- endif -%}
        </div>
    </div>
{%- endmacro show_option_groups -%}


{%- macro show_special_offers(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'special_offer.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            {%- if product.specialOffers is not empty -%}
            <div class="show-widget show-widget-sm">
                <table class="table table-stripped table-condensed table-alt-head">
                    <tr>
                        <th>{{ 'field.name'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'common.min_quantity'|trans({}, 'EkynaProduct') }}</th>
                        <th class="text-right">{{ 'common.percent'|trans({}, 'EkynaProduct') }}</th>
                        <th class="text-right">{{ 'field.start_date'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'field.end_date'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'special_offer.field.stack'|trans({}, 'EkynaProduct') }}</th>
                        <th class="text-right">{{ 'field.enabled'|trans({}, 'EkynaUi') }}</th>
                    </tr>
                    {%- for offer in product.specialOffers -%}
                    {%- set offerId = 'product_specialOffers_' ~ loop.index0 ~ '_' -%}
                    <tr>
                        <td id="{{ offerId ~ 'name' }}">
                            {{- offer.name -}}
                        </td>
                        <td id="{{ offerId ~ 'minQuantity' }}" class="text-right">
                            {{- offer.minQuantity|format_number -}}
                        </td>
                        <td id="{{ offerId ~ 'percent' }}" class="text-right">
                            {{- (offer.percent / 100)|format_number(style='percent') -}}
                        </td>
                        <td id="{{ offerId ~ 'startsAt' }}" class="text-right">
                        {%- if offer.startsAt is null -%}
                            <em>{{ 'value.undefined'|trans({}, 'EkynaUi') }}</em>
                        {%- else -%}
                            {{ offer.startsAt|format_datetime('short', 'none') }}
                        {%- endif -%}
                        </td>
                        <td id="{{ offerId ~ 'endsAt' }}" class="text-right">
                        {%- if offer.endsAt is null -%}
                            <em>{{ 'value.undefined'|trans({}, 'EkynaUi') }}</em>
                        {%- else -%}
                            {{ offer.endsAt|format_datetime('short', 'none') }}
                        {%- endif -%}
                        </td>
                        <td id="{{ offerId ~ 'stack' }}" class="text-right">
                            {%- if offer.stack -%}
                                <span class="label label-success">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                            {%- else -%}
                                <span class="label label-danger">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ offerId ~ 'enabled' }}" class="text-right">
                            {%- if offer.enabled -%}
                                <span class="label label-success">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                            {%- else -%}
                                <span class="label label-danger">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                            {%- endif -%}
                        </td>
                    </tr>
                    {%- endfor -%}
                </table>
            </div>
            {%- else -%}
            <div class="show-widget show-widget-inline">
                <em>{{ 'value.none'|trans({}, 'EkynaUi') }}</em>
            </div>
            {%- endif -%}
        </div>
    </div>
{%- endmacro show_special_offers -%}


{%- macro show_pricings(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'pricing.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            {%- if product.pricings is not empty -%}
            <div class="show-widget show-widget-sm">
                <table class="table table-stripped table-condensed table-alt-head">
                    <tr>
                        <th>{{ 'field.name'|trans({}, 'EkynaUi') }}</th>
                        <th>{{ 'pricing_rule.label.plural'|trans({}, 'EkynaProduct') }}</th>
                    </tr>
                    {%- for pricing in product.pricings -%}
                    {%- set pricingId = 'product_pricings_' ~ loop.index0 ~ '_' -%}
                    <tr>
                        <td id="{{ pricingId ~ 'name' }}">
                            {{- pricing.name -}}
                        </td>
                        <td id="{{ pricingId ~ 'rules' }}">
                            <table class="table table-condensed table-alt-head">
                                <tr>
                                    <th class="text-right">{{ 'common.min_quantity'|trans({}, 'EkynaProduct') }}</th>
                                    {%- for rule in pricing.rules -%}
                                        <td class="text-right">{{ rule.minQuantity|format_number }}</td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    <th class="text-right">{{ 'common.percent'|trans({}, 'EkynaProduct') }}</th>
                                    {%- for rule in pricing.rules -%}
                                        <td class="text-right">{{ (rule.percent / 100)|format_number(style='percent') }}</td>
                                    {%- endfor -%}
                                </tr>
                            </table>
                        </td>
                    </tr>
                    {%- endfor -%}
                </table>
            </div>
            {%- else -%}
            <div class="show-widget show-widget-inline">
                <em>{{ 'value.none'|trans({}, 'EkynaUi') }}</em>
            </div>
            {%- endif -%}
        </div>
    </div>
{%- endmacro show_pricings -%}


{%- macro show_bundle_composition(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'bundle_slot.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-sm show-product-bundle">
            {%- if product is bundle_product -%}
                <table class="table table-stripped table-condensed table-hover table-alt-head">
                    <tr>
                        <th>{{ 'product.label.singular'|trans({}, 'EkynaProduct') }}</th>
                        <th>{{ 'field.reference'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'stock_subject.field.state'|trans({}, 'EkynaCommerce') }}</th>
                        <th class="text-right">{{ 'field.type'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'field.visible'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'bundle_choice.field.hidden'|trans({}, 'EkynaProduct') }}</th>
                        <th class="text-right">{{ 'field.images'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'option.label.plural'|trans({}, 'EkynaProduct') }}</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">{{ 'field.weight'|trans({}, 'EkynaUi') }}</th>
                        <th class="text-right">{{ 'field.net_price'|trans({}, 'EkynaCommerce') }}</th>
                        <th class="text-right">{{ 'field.buy_net_price'|trans({}, 'EkynaCommerce') }}</th>
                        <th class="text-right">{{ 'sale.field.margin'|trans({}, 'EkynaCommerce') }}</th>
                    </tr>
                    {%- set total_weight = 0 -%}
                    {%- set total_price = 0 -%}
                    {%- set total_purchase = 0 -%}
                    {%- for slot in product.bundleSlots -%}
                        {%- set slot_id = 'product_slots_' ~ loop.index0 ~ '_' -%}
                        {%- set choice = slot.choices|first -%}
                        {%- set choice_product = choice.product -%}
                    <tr>
                        <td id="{{ slot_id ~ 'choice_0_product' }}">
                            <a href="{{ admin_resource_path(choice_product) }}" class="show-entity"
                                data-summary="{{ admin_resource_path(choice_product, 'admin_summary') }}">
                                {{- choice_product -}}
                            </a>
                        </td>
                        <td id="{{ slot_id ~ 'reference' }}" class="text-right"
                            data-clipboard-copy="{{ choice_product.reference }}">
                            {{- choice_product.reference -}}
                        </td>
                        <td id="{{ slot_id ~ 'stockState' }}" class="text-right">
                            {{- choice_product|stock_subject_state_badge -}}
                        </td>
                        <td id="{{ slot_id ~ 'type' }}" class="text-right">
                            {{- choice_product|product_type_badge -}}
                        </td>
                        <td id="{{ slot_id ~ 'visible' }}" class="text-right">
                            {%- if choice_product.visible -%}
                                <span class="label label-success">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                            {%- else -%}
                                <span class="label label-danger">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ slot_id ~ 'hidden' }}" class="text-right">
                            {%- if choice.hidden -%}
                                <span class="label label-warning">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                            {%- else -%}
                                <span class="label label-default">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ slot_id ~ 'excludeImages' }}" class="text-right">
                            {%- if choice.excludeImages -%}
                                <span class="label label-warning">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                            {%- else -%}
                                <span class="label label-default">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ slot_id ~ 'options' }}" class="text-right">
                            {{ choice|bundle_choice_option_groups }}
                        </td>
                        <td id="{{ slot_id ~ 'minQuantity' }}" class="text-right">
                            {# TODO Packaging format #}
                            {{- choice.minQuantity|format_number -}}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_weight' }}" class="text-right">
                            {% set weight = choice_product.weight * choice.minQuantity %}
                            {{- weight|format_number -}}
                            {% set total_weight = total_weight + weight %}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_netPrice' }}" class="text-right">
                            {% if choice.netPrice is not null %}
                                {% set price = choice.netPrice * choice.minQuantity %}
                                <del>{{ (choice_product.netPrice * choice.minQuantity)|format_currency(commerce_default_currency) }}</del>
                            {% else %}
                                {% set price = choice_product.netPrice * choice.minQuantity %}
                            {% endif %}
                            {{- price|format_currency(commerce_default_currency) -}}
                            {% set total_price = total_price + price %}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_buyPrice' }}" class="text-right">
                            {%- set purchase = choice_product|product_purchase_cost(false, true) * choice.minQuantity -%}
                            {{- purchase|format_currency(commerce_default_currency) -}}
                            {%- set total_purchase = total_purchase + purchase -%}
                            {%- set cost = choice_product|product_purchase_cost(false) * choice.minQuantity -%}
                            &nbsp;(<em>{{- cost|format_currency(commerce_default_currency) -}}</em>)
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_margin' }}" class="text-right">
                        {%- if 0 < purchase  -%}
                            {%- if 0 < price -%}
                            {{ ((price - purchase) / price * 100)|round(2)|format_number }}%
                            {%- else -%}
                                <span class="text-red">-&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            -
                        {%- endif -%}
                        </td>
                    </tr>
                    {%- endfor -%}
                    <tr>
                        <td colspan="2" class="text-right">&nbsp;</td>
                        <td colspan="6" class="text-right">&nbsp;</td>
                        <td class="text-right">
                            <strong class="group-price">{{ 'field.total'|trans({}, 'EkynaUi') }}</strong>
                        </td>
                        <td class="text-right">
                            {{- total_weight|format_number -}}
                        </td>
                        <td class="text-right">
                            {{- total_price|format_currency(commerce_default_currency) -}}
                        </td>
                        <td class="text-right">
                            {{- total_purchase|format_currency(commerce_default_currency) -}}
                        </td>
                        <td class="text-right">
                        {%- if 0 < total_purchase  -%}
                            {%- if 0 < total_price -%}
                                {{ ((total_price - total_purchase) / total_price * 100)|round(2)|format_number }}%
                            {%- else -%}
                                <span class="text-red">-&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            -
                        {%- endif -%}
                        </td>
                    </tr>
                </table>
            {%- else -%}
                <p>
                    <em>Wrong product type</em>
                </p>
            {%- endif -%}
            </div>
        </div>
    </div>
{%- endmacro show_bundle_composition -%}


{%- macro show_bundle_rules(rules, bundle) -%}
    <table class="table table-stripped table-condensed table-hover table-alt-head">
    {%- for rule in rules -%}
        <tr>
            <td>{{ rule|bundle_rule_type }}</td>
            <td>
            {%- for cond in rule.conditions -%}
                {%- if cond['choice'] is same as(null) -%}
                    [{{ cond['slot'] }}.X]&nbsp;
                    <em>{{ 'value.none'|trans({}, 'EkynaUi') }}</em>
                {%- else -%}
                    [{{ cond['slot'] }}.{{ cond['choice'] }}]&nbsp;
                    {%- set product = cond|bundle_condition_product(bundle) -%}
                    {%- if product is null -%}
                        <strong class="text-danger">Not found</strong>
                    {%- else -%}
                        <a href="{{ admin_resource_path(product) }}" data-summary="{{ admin_resource_path(product, 'admin_summary') }}">
                            {{ product }}
                        </a>
                    {%- endif -%}
                {%- endif -%}
                <br>
            {%- endfor -%}
            </td>
        </tr>
    {%- endfor -%}
    </table>
{%- endmacro show_bundle_rules -%}


{%- macro show_components(product) -%}
<div class="row show-row">
    <div class="col-md-2 show-label">
        {{- 'component.label.plural'|trans({}, 'EkynaProduct') -}}
    </div>
    <div class="col-md-10">
        <div class="show-widget show-widget-sm show-product-configurable">
            <table class="table table-stripped table-condensed table-hover table-alt-head">
                <thead>
                <tr>
                    <th>{{ 'field.designation'|trans({}, 'EkynaUi') }}</th>
                    <th>{{ 'field.reference'|trans({}, 'EkynaUi') }}</th>
                    <th class="text-right">{{ 'field.quantity'|trans({}, 'EkynaUi') }}</th>
                    <th class="text-right">{{ 'field.weight'|trans({}, 'EkynaUi') }}&nbsp;(kg)</th>
                    <th class="text-right">{{ 'field.net_price'|trans({}, 'EkynaCommerce') }}</th>
                    <th class="text-right">{{ 'field.buy_net_price'|trans({}, 'EkynaCommerce') }}</th>
                    <th class="text-right">{{ 'sale.field.margin'|trans({}, 'EkynaCommerce') }}</th>
                </tr>
                </thead>
                <tbody>
                {%- set total_weight = 0 -%}
                {%- set total_price = 0 -%}
                {%- set total_purchase = 0 -%}
                {%- for component in product.components -%}
                    {%- set component_id = 'product_component_' ~ loop.index0 ~ '_' -%}
                <tr>
                    <td id="{{ component_id ~ 'designation' }}">
                        <a href="{{ admin_resource_path(component.child) }}" data-summary="{{ admin_resource_path(component.child, 'admin_summary') }}">{{ component.child }}</a>
                    </td>
                    <td>
                        <span data-clipboard-copy="{{ component.child.reference }}">{{ component.child.reference }}</span>
                    </td>
                    <td id="{{ component_id ~ 'quantity' }}" class="text-right">
                        {# TODO Packaging format #}
                        {{- component.quantity|format_number -}}
                    </td>
                    <td id="{{ component_id ~ 'weight' }}" class="text-right">
                        {% set weight = component.child.weight * component.quantity %}
                        {{- weight|format_number -}}
                        {%- set total_weight = total_weight + weight -%}
                    </td>
                    <td id="{{ component_id ~ 'netPrice' }}" class="text-right">
                        {%- if component.netPrice is not same as(null) -%}
                            {% set price = component.netPrice * component.quantity %}
                            <del>{{ (component.child.netPrice * component.quantity)|format_currency(commerce_default_currency) }}</del>
                        {%- else -%}
                            {% set price = component.child.netPrice * component.quantity %}
                        {%- endif -%}
                        {{- price|format_currency(commerce_default_currency) -}}
                        {% set total_price = total_price + price %}
                    </td>
                    <td id="{{ component_id ~ 'buyPrice' }}" class="text-right">
                        {% set purchase = component.child|product_purchase_cost(false) * component.quantity %}
                        {{- purchase|format_currency(commerce_default_currency) -}}
                        {% set total_purchase = total_purchase + purchase %}
                    </td>
                    <td id="{{ component_id ~ 'margin' }}" class="text-right">
                        {%- if 0 < purchase  -%}
                            {%- if 0 < price -%}
                                {{ ((price - purchase) / price * 100)|round(2)|format_number }}%
                            {%- else -%}
                                <span class="text-red">&dash;&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            &dash;
                        {%- endif -%}
                    </td>
                </tr>
                {%- else -%}
                <tr>
                    <td colspan="7" class="text-center"><em>{{ 'value.no_item'|trans({}, 'EkynaUi') }}</em></td>
                </tr>
                {%- endfor -%}
                <tr>
                    <td colspan="3" class="text-right">
                        <strong>{{ 'field.total'|trans({}, 'EkynaUi') }}</strong>
                    </td>
                    <td class="text-right">
                        {{- total_weight|format_number -}}
                    </td>
                    <td class="text-right">
                        {{- total_price|format_currency(commerce_default_currency) -}}
                    </td>
                    <td class="text-right">
                        {{- total_purchase|format_currency(commerce_default_currency) -}}
                    </td>
                    <td class="text-right">
                        {%- if 0 < total_purchase  -%}
                            {%- if 0 < total_price -%}
                                {{ ((total_price - total_purchase) / total_price * 100)|round(2)|format_number }}%
                            {%- else -%}
                                <span class="text-red">-&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            -
                        {%- endif -%}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{%- endmacro show_components -%}


{%- macro show_cross_sellings(product) -%}
<div class="row show-row">
    <div class="col-md-2 show-label">
        {{- 'cross_selling.label.plural'|trans({}, 'EkynaProduct') -}}
    </div>
    <div class="col-md-10">
        <div class="show-widget show-widget-sm show-product-configurable">
            <table class="table table-stripped table-condensed table-hover table-alt-head">
                <thead>
                <tr>
                    <th>{{ 'field.designation'|trans({}, 'EkynaUi') }}</th>
                    <th>{{ 'field.reference'|trans({}, 'EkynaUi') }}</th>
                    <th class="text-right">{{ 'field.net_price'|trans({}, 'EkynaCommerce') }}</th>
                </tr>
                </thead>
                <tbody>
                {%- for crossSelling in product.crossSellings -%}
                    {%- set crossSelling_id = 'product_crossSelling_' ~ loop.index0 ~ '_' -%}
                <tr>
                    <td id="{{ crossSelling_id ~ 'designation' }}">
                        <a href="{{ admin_resource_path(crossSelling.target) }}" data-summary="{{ admin_resource_path(crossSelling.target, 'admin_summary') }}">{{ crossSelling.target }}</a>
                    </td>
                    <td>
                        <span data-clipboard-copy="{{ crossSelling.target.reference }}">{{ crossSelling.target.reference }}</span>
                    </td>
                    <td id="{{ crossSelling_id ~ 'netPrice' }}" class="text-right">
                        {{- crossSelling.target.netPrice|format_currency(commerce_default_currency) -}}
                    </td>
                </tr>
                {%- else -%}
                <tr>
                    <td colspan="3" class="text-center"><em>{{ 'value.no_item'|trans({}, 'EkynaUi') }}</em></td>
                </tr>
                {%- endfor -%}
                </tbody>
            </table>
        </div>
    </div>
</div>
{%- endmacro show_cross_sellings -%}


{%- macro show_configurable_composition(product, options = {}) -%}
    {% import _self as macros %}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'bundle_slot.label.plural'|trans({}, 'EkynaProduct') -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-sm show-product-configurable">
            {%- if product is configurable_product -%}
                <p class="total">
                    <strong>{{ 'product.field.total_net_price'|trans({}, 'EkynaProduct') }}</strong>
                    <span>{{ product|product_configurable_total_price|format_currency(commerce_default_currency) }}</span>
                </p>
                {%- for slot in product.bundleSlots -%}
                {%- set slot_id = 'product_slots_' ~ loop.index0 ~ '_' -%}
                <div class="slot collection-item">
                    <span class="bundle-slot-index">{{ slot.position }}</span>
                    {{- show_row(slot.translations, 'translations', {
                        'id': slot_id ~ 'translations',
                        'fields': {
                            'title': {'label': t('field.title', [], 'EkynaUi')},
                            'description': {
                                'label': t('field.description', [], 'EkynaUi'),
                                'type': 'textarea',
                                'options': {'html': true},
                            },
                        }
                    }) -}}
                    <div class="row">
                        <div class="col-md-6">
                            {{- show_row(slot.media, 'media_media', {
                                'label': t('field.image', [], 'EkynaUi'),
                                'id': slot_id ~ 'image',
                                'label_col': 4
                            }) -}}
                        </div>
                        <div class="col-md-6">
                            {{- show_row(slot.required, 'boolean', {
                                'label': t('field.required', [], 'EkynaUi'),
                                'id': slot_id ~ 'required',
                                'color': true,
                                'label_col': 4
                            }) -}}
                        </div>
                    </div>
                    {%- if slot.rules is not empty -%}
                    <div class="row show-row">
                        <div class="col-md-2 show-label">
                            {{- 'bundle_rule.label.plural'|trans({}, 'EkynaProduct') -}}
                        </div>
                        <div class="col-md-10">
                            <div id="{{ slot_id ~ 'rules' }}" class="show-widget bundle-rules">
                                {{- macros.show_bundle_rules(slot.rules, product) -}}
                            </div>
                        </div>
                    </div>
                    {%- endif -%}
                    <table class="table table-stripped table-condensed table-hover table-alt-head">
                        <tr>
                            <th>&nbsp;</th>
                            <th>{{ 'product.label.singular'|trans({}, 'EkynaProduct') }}</th>
                            <th>{{ 'field.reference'|trans({}, 'EkynaUi') }}</th>
                            <th class="text-right">{{ 'field.type'|trans({}, 'EkynaUi') }}</th>
                            <th class="text-right">{{ 'stock_subject.field.state'|trans({}, 'EkynaCommerce') }}</th>
                            <th class="text-right">{{ 'field.visible'|trans({}, 'EkynaUi') }}</th>
                            <th class="text-right">{{ 'option.label.plural'|trans({}, 'EkynaProduct') }}</th>
                            <th class="text-right">{{ 'common.min_quantity'|trans({}, 'EkynaProduct') }}</th>
                            <th class="text-right">{{ 'common.max_quantity'|trans({}, 'EkynaProduct') }}</th>
                            <th class="text-right">{{ 'field.net_price'|trans({}, 'EkynaCommerce') }}</th>
                        </tr>
                        {%- for choice in slot.choices -%}
                        {%- set choice_id = slot_id ~ '_choice_' ~ loop.index0 ~ '_' -%}
                        {%- set choice_product = choice.product -%}
                        <tr>
                            <td>[{{ slot.position }}.{{ choice.position }}]</td>
                            <td id="{{ choice_id ~ 'product' }}">
                                <a href="{{ admin_resource_path(choice_product) }}" class="show-entity"
                                   data-summary="{{ admin_resource_path(choice_product, 'admin_summary') }}">
                                    {{- choice_product -}}
                                </a>
                            </td>
                            <td id="{{ choice_id ~ 'reference' }}" class="text-right"
                                data-clipboard-copy="{{ choice_product.reference }}">
                                {{- choice_product.reference -}}
                            </td>
                            <td id="{{ choice_id ~ 'type' }}" class="text-right">
                                {{- choice_product|product_type_badge -}}
                            </td>
                            <td id="{{ choice_id ~ 'stockState' }}" class="text-right">
                                {{- choice_product|stock_subject_state_badge -}}
                            </td>
                            <td id="{{ choice_id ~ 'visible' }}" class="text-right">
                                {%- if choice_product.visible -%}
                                    <span class="label label-success">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                                {%- else -%}
                                    <span class="label label-danger">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                                {%- endif -%}
                            </td>
                            <td id="{{ choice_id ~ 'options' }}" class="text-right">
                                {{ choice|bundle_choice_option_groups }}
                            </td>
                            <td id="{{ choice_id ~ 'minQuantity' }}" class="text-right">
                                {# TODO Packgaging format #}
                                {{- choice.minQuantity|format_number -}}
                            </td>
                            <td id="{{ choice_id ~ 'maxQuantity' }}" class="text-right">
                                {# TODO Packgaging format #}
                                {{- choice.maxQuantity|format_number -}}
                            </td>
                            <td id="{{ choice_id ~ 'product_netPrice' }}" class="text-right">
                                {{- (choice_product.netPrice * choice.minQuantity)|format_currency(commerce_default_currency) -}}
                            </td>
                        </tr>
                        {%- if choice.rules is not empty -%}
                        <tr>
                            <td colspan="10" class="bundle-rules">
                                {{- macros.show_bundle_rules(choice.rules, product) -}}
                            </td>
                        </tr>
                        {%- endif -%}
                        {%- endfor -%}
                    </table>
                </div>
                {%- endfor -%}
            {%- else -%}
                <p class="alert alert-danger">
                    <em>Wrong product type</em>
                </p>
            {%- endif -%}
            </div>
        </div>
    </div>
{%- endmacro show_configurable_composition -%}


{%- macro show_relations(products) -%}
    <table class="table table-stripped table-condensed table-hover table-alt-head show-product-relation">
        <tr>
            <th>{{ 'product.label.singular'|trans({}, 'EkynaProduct') }}</th>
            <th>{{ 'field.reference'|trans({}, 'EkynaUi') }}</th>
            <th class="text-right">{{ 'field.type'|trans({}, 'EkynaUi') }}</th>
            <th class="text-right">{{ 'stock_subject.field.state'|trans({}, 'EkynaCommerce') }}</th>
            <th class="text-right">{{ 'field.visible'|trans({}, 'EkynaUi') }}</th>
            <th class="text-right">{{ 'field.net_price'|trans({}, 'EkynaCommerce') }}</th>
        </tr>
        {%- for product in products -%}
            {%- set relationId = 'relation_' ~loop.index0 ~ '_' -%}
            <tr>
                <td id="{{ relationId ~ 'product' }}">
                    <a href="{{ admin_resource_path(product) }}" class="show-entity"
                       data-summary="{{ admin_resource_path(product, 'admin_summary') }}">
                        {{- product -}}
                    </a>
                </td>
                <td id="{{ relationId ~ 'reference' }}" class="text-right"
                    data-clipboard-copy="{{ product.reference }}">
                    {{- product.reference -}}
                </td>
                <td id="{{ relationId ~ 'type' }}" class="text-right">
                    {{- product|product_type_badge -}}
                </td>
                <td id="{{ relationId ~ 'stockState' }}" class="text-right">
                    {{- product|stock_subject_state_badge -}}
                </td>
                <td id="{{ relationId ~ 'visible' }}" class="text-right">
                    {%- if product.visible -%}
                        <span class="label label-success">{{ 'value.yes'|trans({}, 'EkynaUi') }}</span>
                    {%- else -%}
                        <span class="label label-danger">{{ 'value.no'|trans({}, 'EkynaUi') }}</span>
                    {%- endif -%}
                </td>
                <td id="{{ relationId ~ 'product_netPrice' }}" class="text-right">
                    {{- product.netPrice|format_currency(commerce_default_currency) -}}
                </td>
            </tr>
        {%- endfor -%}
    </table>
{%- endmacro show_relations -%}


{%- macro show_seo(product, options = {}) -%}
    {{- show_row(product.seo, 'seo', {
        'id': 'product_seo'
    }|merge(options)) -}}
{%- endmacro show_seo -%}


{%- macro show_stock_units(product) -%}
    {%- if product.stockMode is not stock_mode_disabled -%}
        <hr>
        {%- if product.stockMode is stock_mode_manual -%}
        <div class="actions">
            {{- admin_resource_btn('ekyna_product.product_stock_unit', 'Ekyna\\Bundle\\AdminBundle\\Action\\CreateAction', {
                'label': t('stock_unit.button.new', [], 'EkynaCommerce'),
                'size': 'xs',
                'path': path('ekyna_product_product_stock_unit_admin_new', {
                    'productId': product.id,
                })
            }) -}}
        </div>
        {%- endif -%}
        {{- render_subject_stock_units(product, {
            'prefix': 'product_stockUnit',
            'id': 'stock-units-view'
        }) -}}
    {%- endif -%}
{%- endmacro show_stock_units -%}


{%- macro show_stat_charts(product) -%}
    <div class="panel-group" id="stat_collapse" role="tablist" aria-multiselectable="true">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="order_count_stat_heading">
                <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#stat_collapse" href="#collapse_order_count_chart"
                       aria-expanded="true" aria-controls="collapseOne" style="display:block;">
                        {{- 'stat.count'|trans({}, 'EkynaProduct') }}&nbsp;({{ 'order.label.plural'|trans({}, 'EkynaCommerce') -}})
                    </a>
                </h4>
            </div>
            <div id="collapse_order_count_chart" class="panel-collapse collapse in" role="tabpanel"
                 aria-labelledby="order_count_stat_heading">
                <div class="panel-body">
                    {{- product_stat_count_chart(product, constant('Ekyna\\Bundle\\ProductBundle\\Entity\\StatCount::SOURCE_ORDER')) -}}
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="quote_count_stat_heading">
                <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#stat_collapse" href="#collapse_quote_count_chart"
                       aria-expanded="true" aria-controls="collapseOne" style="display:block;">
                        {{- 'stat.count'|trans({}, 'EkynaProduct') }}&nbsp;({{ 'quote.label.plural'|trans({}, 'EkynaCommerce') -}})
                    </a>
                </h4>
            </div>
            <div id="collapse_quote_count_chart" class="panel-collapse collapse" role="tabpanel"
                 aria-labelledby="quote_count_stat_heading">
                <div class="panel-body">
                    {{- product_stat_count_chart(product, constant('Ekyna\\Bundle\\ProductBundle\\Entity\\StatCount::SOURCE_QUOTE')) -}}
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="cross_stat_heading">
                <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#stat_collapse" href="#collapse_cross_chart"
                       aria-expanded="true" aria-controls="collapseOne" style="display:block;">
                        {{- 'stat.cross'|trans({}, 'EkynaProduct') -}}
                    </a>
                </h4>
            </div>
            <div id="collapse_cross_chart" class="panel-collapse collapse" role="tabpanel"
                 aria-labelledby="cross_stat_heading">
                <div class="panel-body">
                    {{- product_stat_cross_chart(product) -}}
                </div>
            </div>
        </div>
    </div>
{%- endmacro show_stat_charts -%}
