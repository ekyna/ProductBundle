{%- macro show_designation(product, options = {}) -%}
    {{- show_row(product.designation, 'text', {
        'label': 'ekyna_core.field.designation',
        'id': 'product_designation'
    }|merge(options)) -}}
{%- endmacro show_designation -%}


{%- macro show_visible(product, options = {}) -%}
    {{- show_row(product.visible, 'boolean', {
        'label': 'ekyna_core.field.visible',
        'id': 'product_visible',
        'color': true
    }|merge(options)) -}}
{%- endmacro show_visible -%}


{%- macro show_visibility(product, options = {}) -%}
    {{- show_row(product.visibility, 'number', {
        'label': 'ekyna_product.common.visibility',
        'id': 'product_visibility'
    }|merge(options)) -}}
{%- endmacro show_visibility -%}


{%- macro show_best_seller(product, options = {}) -%}
    {{- show_row(product|product_best_seller_badge, 'text', {
        'label': 'ekyna_product.product.field.best_seller',
        'id': 'product_best_seller'
    }|merge(options)) -}}
{%- endmacro show_best_seller -%}


{%- macro show_cross_selling(product, options = {}) -%}
    {{- show_row(product|product_cross_selling_badge, 'text', {
        'label': 'ekyna_product.product.field.cross_selling',
        'id': 'product_cross_selling'
    }|merge(options)) -}}
{%- endmacro show_cross_selling -%}


{%- macro show_brand(product, options = {}) -%}
    {{- show_row(product.brand, 'entity', {
        'label': 'ekyna_product.brand.label.singular',
        'route': 'ekyna_product_brand_admin_show',
        'route_parameters_map': {'brandId': 'id'},
        'id': 'product_brand'
    }|merge(options)) -}}
{%- endmacro show_brand -%}


{%- macro show_brandNaming(product, options = {}) -%}
    {{- show_row(product.brandNaming, 'boolean', {
        'label': 'ekyna_product.product.field.brand_naming',
        'id': 'product_brandNaming',
        'color': true,
        'false_class': 'label label-default'
    }|merge(options)) -}}
{%- endmacro show_brandNaming -%}


{%- macro show_categories(product, options = {}) -%}
    {{- show_row(product.categories, 'entity', {
        'label': 'ekyna_product.category.label.plural',
        'route': 'ekyna_product_category_admin_show',
        'route_parameters_map': {'categoryId': 'id'},
        'id': 'product_categories'
    }|merge(options)) -}}
{%- endmacro show_categories -%}


{%- macro show_customer_groups(product, options = {}) -%}
    {{- show_row(product.customerGroups, 'entity', {
        'label': 'ekyna_commerce.customer_group.label.plural',
        'route': 'ekyna_commerce_customer_group_admin_show',
        'route_parameters_map': {'customerGroupId': 'id'},
        'id': 'product_customerGroups'
    }|merge(options)) -}}
{%- endmacro show_customer_groups -%}


{%- macro show_released_at(product, options = {}) -%}
    {{- show_row(product.releasedAt, 'datetime', {
        'label': 'ekyna_product.product.field.released_at',
        'date_format': 'short',
        'time_format': 'none',
        'id': 'product_releasedAt'
    }|merge(options)) -}}
{%- endmacro show_released_at -%}


{%- macro show_reference(product, options = {}) -%}
    {{- show_row(product.reference, 'text', {
        'label': 'ekyna_core.field.reference',
        'id': 'product_reference',
        'attr': {
            'data-clipboard-copy': product.reference
        }
    }|merge(options)) -}}
{%- endmacro show_reference -%}


{%- macro show_translations(product, options = {}) -%}
    {{- show_row(product.translations, 'translations', {
        'id': 'product_translations',
        'fields': {
            'title': {'label': 'ekyna_core.field.title'},
            'slug': {'label': 'ekyna_core.field.url'},
            'subTitle': {'label': 'ekyna_core.field.subtitle'},
            'description': {
                'label': 'ekyna_core.field.description',
                'type': 'tinymce',
                'options': {
                    'height': 150,
                    'route': 'ekyna_product_product_admin_tinymce',
                    'route_params': {'productId': product.id},
                }
            }
        }
    }|merge(options)) -}}
{%- endmacro show_translations -%}


{%- macro show_attribute_set(product, options = {}) -%}
    {{- show_row(product.attributeSet, 'entity', {
        'label': 'ekyna_product.attribute_set.label.singular',
        'id': 'product_attributeSet',
        'route': 'ekyna_product_attribute_set_admin_show',
        'route_parameters_map': {'attributeSetId': 'id'}
    }|merge(options)) -}}
{%- endmacro show_attribute_set -%}


{%- macro show_variable(product, options = {}) -%}
    {{- show_row(product.parent, 'entity', {
        'label': 'ekyna_product.product.field.parent',
        'id': 'product_parent',
        'route': 'ekyna_product_product_admin_show',
        'route_parameters_map': {'productId': 'id'},
    }|merge(options)) -}}
{%- endmacro show_variable -%}


{%- macro show_medias(product, options = {}) -%}
    {{- show_row(product.medias, 'medias', {
        'label': 'ekyna_core.field.medias',
        'id': 'product_medias'
    }|merge(options)) -}}
{%- endmacro show_medias -%}


{%- macro show_notContractual(product, options = {}) -%}
    {{- show_row(product.notContractual, 'boolean', {
        'label': 'ekyna_product.product.field.not_contractual',
        'id': 'product_notContractual',
        'color': true,
        'true_class': 'label label-warning',
        'false_class': 'label label-default'
    }|merge(options)) -}}
{%- endmacro show_notContractual -%}


{%- macro show_min_price(product, options = {}) -%}
    {{- show_row(product.minPrice|localizedcurrency(commerce_default_currency), 'text', {
        'label': 'ekyna_product.product.field.min_price',
        'id': 'product_minPrice',
    }|merge(options)) -}}
{%- endmacro show_min_price -%}


{%- macro show_net_price(product, options = {}) -%}
    {{- show_row(product.netPrice|localizedcurrency(commerce_default_currency), 'text', {
        'label': 'ekyna_commerce.field.net_price',
        'id': 'product_netPrice',
    }|merge(options)) -}}
{%- endmacro show_net_price -%}


{%- macro show_tax_group(product, options = {}) -%}
    {{- show_row(product.taxGroup, 'entity', {
        'label': 'ekyna_commerce.tax_group.label.singular',
        'id': 'product_taxGroup',
        'route': 'ekyna_commerce_tax_group_admin_show',
        'route_parameters_map': {'taxGroupId': 'id'},
    }|merge(options)) -}}
{%- endmacro show_tax_group -%}


{%- macro show_references(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.product_reference.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-block" id="product_references">
                {%- if product.references is not empty -%}
                    <dl class="dl-horizontal">
                        {%- for reference in product.references -%}
                            <dt>{{ reference|product_reference_type_label }}</dt>
                            <dd data-clipboard-copy="{{ reference.code }}">{{ reference.code }}</dd>
                        {%- endfor -%}
                    </dl>
                {%- else -%}
                    <em>{{ 'ekyna_core.value.none'|trans }}</em>
                {%- endif -%}
            </div>
        </div>
    </div>
{%- endmacro show_references -%}


{%- macro show_attributes(product, options = {}) -%}
    {%- if product is simple_product or product is variant_product -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.attribute.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-block" id="product_attributes">
                <dl class="dl-horizontal">
                    {%- for attribute in product.attributes -%}
                    <dt>{{ attribute.attributeSlot.attribute.name }}</dt>
                    <dd>{{ attribute|product_attribute }}</dd>
                    {%- endfor -%}
                </dl>
            </div>
        </div>
    </div>
    {%- endif -%}
{%- endmacro show_attributes -%}


{%- macro show_adjustments(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_commerce.adjustment.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-block" id="product_adjustments">
                <table class="table table-stripped table-condensed table-hover table-alt-head">
                    <tr>
                        <th>{{ 'ekyna_core.field.designation'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.type'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.mode'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.amount'|trans }}</th>
                    </tr>
                    {%- for adjustment in product.adjustments -%}
                        <tr>
                            <td>{{ adjustment.designation }}</td>
                            <td class="text-right">{{ adjustment.type|adjustment_type_label }}</td>
                            <td class="text-right">{{ adjustment.mode|adjustment_mode_label }}</td>
                            <td class="text-right">{{ adjustment.amount|localizedcurrency(commerce_default_currency) }}</td>
                        </tr>
                        {# TODO translations ? #}
                    {%- else -%}
                        <tr>
                            <td colspan="4">
                                {{- 'ekyna_core.value.none'|trans -}}
                            </td>
                        </tr>
                    {%- endfor -%}
                </table>
            </div>
        </div>
    </div>
{%- endmacro show_adjustments -%}


{%- macro show_option_groups(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.option_group.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            {%- if product.optionGroups|length -%}
            <div class="show-widget show-widget-sm">
                {%- for group in product.optionGroups -%}
                <div class="collection-item">
                    {%- set groupId = 'product_optionGroups_' ~ loop.index0 ~ '_' -%}
                    {{- show_row(group.name, 'text', {
                        'label': 'ekyna_core.field.name',
                        'id': groupId ~ 'name'
                    }) -}}
                    <div class="row">
                        <div class="col-md-6">
                            {{- show_row(group.required, 'boolean', {
                                'label': 'ekyna_core.field.required',
                                'id': groupId ~ 'required',
                                'label_col': 4,
                                'color': true
                            }) -}}
                        </div>
                        <div class="col-md-6">
                            {{- show_row(group.fullTitle, 'boolean', {
                                'label': 'ekyna_product.option_group.field.full_title',
                                'id': groupId ~ 'fullTitle',
                                'label_col': 4
                            }) -}}
                        </div>
                    </div>
                    {{- show_row(group.translations, 'translations', {
                        'id': groupId ~ 'translations',
                        'fields': {
                            'title': {'label': 'ekyna_core.field.title'},
                        }
                    }) -}}
                    <div class="row show-row">
                        <div class="col-md-2 show-label">
                            {{- 'ekyna_product.option.label.plural'|trans -}}
                        </div>
                        <div class="col-md-10">
                            <div class="show-widget">
                                <table class="table table-stripped table-condensed table-hover table-alt-head">
                                    <tr>
                                        <th>{{ 'ekyna_core.field.designation'|trans }}</th>
                                        <th>{{ 'ekyna_core.field.reference'|trans }}</th>
                                        <th class="text-right">{{ 'ekyna_core.field.weight'|trans }}</th>
                                        <th class="text-right">{{ 'ekyna_core.field.price'|trans }}</th>
                                        <th class="text-right">{{ 'ekyna_core.field.group'|trans }}</th>
                                    </tr>
                                    {%- for option in group.options -%}
                                    {%- set optionId = groupId ~ 'options_' ~ loop.index0 ~ '_' -%}
                                    {%- set data = option.product ?: option -%}
                                    <tr>
                                        <td id="{{ optionId ~ 'designation' }}">
                                        {%- if option.product -%}
                                            <a href="{{ admin_resource_path(option.product) }}"
                                               data-summary='{{ {
                                                   'route': 'ekyna_product_product_admin_summary',
                                                   'parameters': {'productId': option.product.id}
                                               }|json_encode }}'>
                                                {{- option.product.fullDesignation -}}
                                            </a>
                                        {%- else -%}
                                            {{- data.designation -}}
                                        {%- endif -%}
                                        </td>
                                        <td id="{{ optionId ~ 'reference' }}" data-clipboard-copy="{{ data.reference }}">
                                            {{- data.reference -}}
                                        </td>
                                        <td id="{{ optionId ~ 'weight' }}" class="text-right">
                                            {{- data.weight|localizednumber ~ ' kg' -}}
                                        </td>
                                        <td id="{{ optionId ~ 'netPrice' }}" class="text-right">
                                        {%- if option.product and option.netPrice is same as(null) -%}
                                            {{- option.product.netPrice|localizedcurrency(commerce_default_currency) -}}
                                        {%- else -%}
                                            {{- option.netPrice|localizedcurrency(commerce_default_currency) -}}
                                        {%- endif -%}
                                        </td>
                                        <td id="{{ optionId ~ 'taxGroup' }}" class="text-right">
                                            {{- data.taxGroup -}}
                                        </td>
                                    </tr>
                                    {# TODO translations ? #}
                                    {%- endfor -%}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {%- endfor -%}
            </div>
            {%- else -%}
            <div class="show-widget show-widget-inline">
                <em>{{ 'ekyna_core.value.none'|trans }}</em>
            </div>
            {%- endif -%}
        </div>
    </div>
{%- endmacro show_option_groups -%}


{%- macro show_special_offers(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.special_offer.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            {%- if product.specialOffers is not empty -%}
            <div class="show-widget show-widget-sm">
                <table class="table table-stripped table-condensed table-alt-head">
                    <tr>
                        <th>{{ 'ekyna_core.field.name'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_product.common.min_quantity'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_product.common.percent'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.start_date'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.end_date'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_product.special_offer.field.stack'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.enabled'|trans }}</th>
                    </tr>
                    {%- for offer in product.specialOffers -%}
                    {%- set offerId = 'product_specialOffers_' ~ loop.index0 ~ '_' -%}
                    <tr>
                        <td id="{{ offerId ~ 'name' }}">
                            {{- offer.name -}}
                        </td>
                        <td id="{{ offerId ~ 'minQuantity' }}" class="text-right">
                            {{- offer.minQuantity|localizednumber -}}
                        </td>
                        <td id="{{ offerId ~ 'percent' }}" class="text-right">
                            {{- (offer.percent / 100)|localizednumber('percent') -}}
                        </td>
                        <td id="{{ offerId ~ 'startsAt' }}" class="text-right">
                        {%- if offer.startsAt is null -%}
                            <em>{{ 'ekyna_core.value.undefined'|trans }}</em>
                        {%- else -%}
                            {{ offer.startsAt|localizeddate('short', 'none') }}
                        {%- endif -%}
                        </td>
                        <td id="{{ offerId ~ 'endsAt' }}" class="text-right">
                        {%- if offer.endsAt is null -%}
                            <em>{{ 'ekyna_core.value.undefined'|trans }}</em>
                        {%- else -%}
                            {{ offer.endsAt|localizeddate('short', 'none') }}
                        {%- endif -%}
                        </td>
                        <td id="{{ offerId ~ 'stack' }}" class="text-right">
                            {%- if offer.stack -%}
                                <span class="label label-success">{{ 'ekyna_core.value.yes'|trans }}</span>
                            {%- else -%}
                                <span class="label label-danger">{{ 'ekyna_core.value.no'|trans }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ offerId ~ 'enabled' }}" class="text-right">
                            {%- if offer.enabled -%}
                                <span class="label label-success">{{ 'ekyna_core.value.yes'|trans }}</span>
                            {%- else -%}
                                <span class="label label-danger">{{ 'ekyna_core.value.no'|trans }}</span>
                            {%- endif -%}
                        </td>
                    </tr>
                    {%- endfor -%}
                </table>
            </div>
            {%- else -%}
            <div class="show-widget show-widget-inline">
                <em>{{ 'ekyna_core.value.none'|trans }}</em>
            </div>
            {%- endif -%}
        </div>
    </div>
{%- endmacro show_special_offers -%}


{%- macro show_pricings(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.pricing.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            {%- if product.pricings is not empty -%}
            <div class="show-widget show-widget-sm">
                <table class="table table-stripped table-condensed table-alt-head">
                    <tr>
                        <th>{{ 'ekyna_core.field.name'|trans }}</th>
                        <th>{{ 'ekyna_product.pricing_rule.label.plural'|trans }}</th>
                    </tr>
                    {%- for pricing in product.pricings -%}
                    {%- set pricingId = 'product_pricings_' ~ loop.index0 ~ '_' -%}
                    <tr>
                        <td id="{{ pricingId ~ 'name' }}">
                            {{- pricing.name -}}
                        </td>
                        <td id="{{ pricingId ~ 'rules' }}">
                            <table class="table table-condensed table-alt-head">
                                <tr>
                                    <th class="text-right">{{ 'ekyna_product.common.min_quantity'|trans }}</th>
                                    {%- for rule in pricing.rules -%}
                                        <td class="text-right">{{ rule.minQuantity|localizednumber }}</td>
                                    {%- endfor -%}
                                </tr>
                                <tr>
                                    <th class="text-right">{{ 'ekyna_product.common.percent'|trans }}</th>
                                    {%- for rule in pricing.rules -%}
                                        <td class="text-right">{{ (rule.percent / 100)|localizednumber('percent') }}</td>
                                    {%- endfor -%}
                                </tr>
                            </table>
                        </td>
                    </tr>
                    {%- endfor -%}
                </table>
            </div>
            {%- else -%}
            <div class="show-widget show-widget-inline">
                <em>{{ 'ekyna_core.value.none'|trans }}</em>
            </div>
            {%- endif -%}
        </div>
    </div>
{%- endmacro show_pricings -%}


{%- macro show_bundle_composition(product, options = {}) -%}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.bundle_slot.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-sm show-product-bundle">
            {%- if product is bundle_product -%}
                <table class="table table-stripped table-condensed table-hover table-alt-head">
                    <tr>
                        <th>{{ 'ekyna_product.product.label.singular'|trans }}</th>
                        <th>{{ 'ekyna_core.field.reference'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_commerce.stock_subject.field.state'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.type'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.visible'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_product.bundle_choice.field.hidden'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_product.option.label.plural'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.quantity'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_core.field.weight'|trans }}&nbsp;(kg)</th>
                        <th class="text-right">{{ 'ekyna_commerce.field.net_price'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_commerce.field.buy_net_price'|trans }}</th>
                        <th class="text-right">{{ 'ekyna_commerce.sale.field.margin'|trans }}</th>
                    </tr>
                    {%- set total_weight = 0 -%}
                    {%- set total_price = 0 -%}
                    {%- set total_purchase = 0 -%}
                    {%- for slot in product.bundleSlots -%}
                        {%- set slot_id = 'product_slots_' ~ loop.index0 ~ '_' -%}
                        {%- set choice = slot.choices|first -%}
                        {%- set choice_product = choice.product -%}
                    <tr>
                        <td id="{{ slot_id ~ 'choice_0_product' }}">
                            <a href="{{ admin_resource_path(choice_product) }}" class="show-entity"
                                data-summary='{{ {
                                    'route': 'ekyna_product_product_admin_summary',
                                    'parameters': {'productId': choice_product.id}
                                }|json_encode }}'>
                                {{- choice_product -}}
                            </a>
                        </td>
                        <td id="{{ slot_id ~ 'reference' }}" class="text-right" style="font-size: 11px"
                            data-clipboard-copy="{{ choice_product.reference }}">
                            {{- choice_product.reference -}}
                        </td>
                        <td id="{{ slot_id ~ 'stockState' }}" class="text-right" style="font-size: 11px">
                            {{- choice_product|stock_subject_state_badge -}}
                        </td>
                        <td id="{{ slot_id ~ 'type' }}" class="text-right" style="font-size: 11px">
                            {{- choice_product|product_type_badge -}}
                        </td>
                        <td id="{{ slot_id ~ 'visible' }}" class="text-right" style="font-size: 11px">
                            {%- if choice_product.visible -%}
                                <span class="label label-success">{{ 'ekyna_core.value.yes'|trans }}</span>
                            {%- else -%}
                                <span class="label label-danger">{{ 'ekyna_core.value.no'|trans }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ slot_id ~ 'hidden' }}" class="text-right" style="font-size: 11px">
                            {%- if choice.hidden -%}
                                <span class="label label-warning">{{ 'ekyna_core.value.yes'|trans }}</span>
                            {%- else -%}
                                <span class="label label-default">{{ 'ekyna_core.value.no'|trans }}</span>
                            {%- endif -%}
                        </td>
                        <td id="{{ slot_id ~ 'options' }}" class="text-right" style="font-size: 11px">
                            {{ choice|bundle_choice_option_groups }}
                        </td>
                        <td id="{{ slot_id ~ 'minQuantity' }}" class="text-right">
                            {# TODO Packaging format #}
                            {{- choice.minQuantity|localizednumber -}}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_weight' }}" class="text-right">
                            {% set weight = choice_product.weight * choice.minQuantity %}
                            {{- weight|localizednumber -}}
                            {% set total_weight = total_weight + weight %}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_netPrice' }}" class="text-right">
                            {% if choice.netPrice is not null %}
                                {% set price = choice.netPrice * choice.minQuantity %}
                                <del>{{ (choice_product.netPrice * choice.minQuantity)|localizedcurrency(commerce_default_currency) }}</del>
                            {% else %}
                                {% set price = choice_product.netPrice * choice.minQuantity %}
                            {% endif %}
                            {{- price|localizedcurrency(commerce_default_currency) -}}
                            {% set total_price = total_price + price %}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_buyPrice' }}" class="text-right">
                            {% set purchase = choice_product|product_purchase_cost(false) * choice.minQuantity %}
                            {{- purchase|localizedcurrency(commerce_default_currency) -}}
                            {% set total_purchase = total_purchase + purchase %}
                        </td>
                        <td id="{{ slot_id ~ 'choice_0_product_margin' }}" class="text-right">
                        {%- if 0 < purchase  -%}
                            {%- if 0 < price -%}
                            {{ ((price - purchase) / price * 100)|round(2)|localizednumber }}%
                            {%- else -%}
                                <span class="text-red">-&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            -
                        {%- endif -%}
                        </td>
                    </tr>
                    {%- endfor -%}
                    <tr>
                        <td colspan="8" class="text-right">
                            <strong>{{ 'ekyna_core.field.total'|trans }}</strong>
                        </td>
                        <td class="text-right">
                            {{- total_weight|localizednumber -}}
                        </td>
                        <td class="text-right">
                            {{- total_price|localizedcurrency(commerce_default_currency) -}}
                        </td>
                        <td class="text-right">
                            {{- total_purchase|localizedcurrency(commerce_default_currency) -}}
                        </td>
                        <td class="text-right">
                        {%- if 0 < total_purchase  -%}
                            {%- if 0 < total_price -%}
                                {{ ((total_price - total_purchase) / total_price * 100)|round(2)|localizednumber }}%
                            {%- else -%}
                                <span class="text-red">-&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            -
                        {%- endif -%}
                        </td>
                    </tr>
                </table>
            {%- else -%}
                <p>
                    <em>Wrong product type</em>
                </p>
            {%- endif -%}
            </div>
        </div>
    </div>
{%- endmacro show_bundle_composition -%}


{%- macro show_bundle_rules(rules, bundle) -%}
    <table class="table table-stripped table-condensed table-hover table-alt-head">
    {%- for rule in rules -%}
        <tr>
            <td>{{ rule|bundle_rule_type }}</td>
            <td>
            {%- for cond in rule.conditions -%}
                {%- if cond['choice'] is same as(null) -%}
                    [{{ cond['slot'] }}.X]&nbsp;
                    <em>{{ 'ekyna_core.value.none'|trans }}</em>
                {%- else -%}
                    [{{ cond['slot'] }}.{{ cond['choice'] }}]&nbsp;
                    {%- set product = cond|bundle_condition_product(bundle) -%}
                    {%- if product is null -%}
                        <strong class="text-danger">Not found</strong>
                    {%- else -%}
                        <a href="{{ admin_resource_path(product) }}" data-summary='{{ {
                            'route': 'ekyna_product_product_admin_summary',
                            'parameters': {'productId': product.id}
                        }|json_encode }}'>{{ product }}</a>
                    {%- endif -%}
                {%- endif -%}
                <br>
            {%- endfor -%}
            </td>
        </tr>
    {%- endfor -%}
    </table>
{%- endmacro show_bundle_rules -%}


{%- macro show_components(product) -%}
<div class="row show-row">
    <div class="col-md-2 show-label">
        {{- 'ekyna_product.component.label.plural'|trans -}}
    </div>
    <div class="col-md-10">
        <div class="show-widget show-widget-sm show-product-configurable">
            <table class="table table-stripped table-condensed table-hover table-alt-head">
                <thead>
                <tr>
                    <th>{{ 'ekyna_core.field.designation'|trans }}</th>
                    <th>{{ 'ekyna_core.field.reference'|trans }}</th>
                    <th class="text-right">{{ 'ekyna_core.field.quantity'|trans }}</th>
                    <th class="text-right">{{ 'ekyna_core.field.weight'|trans }}&nbsp;(kg)</th>
                    <th class="text-right">{{ 'ekyna_commerce.field.net_price'|trans }}</th>
                    <th class="text-right">{{ 'ekyna_commerce.field.buy_net_price'|trans }}</th>
                    <th class="text-right">{{ 'ekyna_commerce.sale.field.margin'|trans }}</th>
                </tr>
                </thead>
                <tbody>
                {%- set total_weight = 0 -%}
                {%- set total_price = 0 -%}
                {%- set total_purchase = 0 -%}
                {%- for component in product.components -%}
                    {%- set component_id = 'product_component_' ~ loop.index0 ~ '_' -%}
                <tr>
                    <td id="{{ component_id ~ 'designation' }}">
                        <a href="{{ admin_resource_path(component.child) }}" data-summary='{{ {
                            'route': 'ekyna_product_product_admin_summary',
                            'parameters': {'productId': component.child.id}
                        }|json_encode }}'>{{ component.child }}</a>
                    </td>
                    <td>
                        <span data-clipboard-copy="{{ component.child.reference }}">{{ component.child.reference }}</span>
                    </td>
                    <td id="{{ component_id ~ 'quantity' }}" class="text-right">
                        {# TODO Packaging format #}
                        {{- component.quantity|localizednumber -}}
                    </td>
                    <td id="{{ component_id ~ 'weight' }}" class="text-right">
                        {% set weight = component.child.weight * component.quantity %}
                        {{- weight|localizednumber -}}
                        {%- set total_weight = total_weight + weight -%}
                    </td>
                    <td id="{{ component_id ~ 'netPrice' }}" class="text-right">
                        {%- if component.netPrice is not same as(null) -%}
                            {% set price = component.netPrice * component.quantity %}
                            <del>{{ (component.child.netPrice * component.quantity)|localizedcurrency(commerce_default_currency) }}</del>
                        {%- else -%}
                            {% set price = component.child.netPrice * component.quantity %}
                        {%- endif -%}
                        {{- price|localizedcurrency(commerce_default_currency) -}}
                        {% set total_price = total_price + price %}
                    </td>
                    <td id="{{ component_id ~ 'buyPrice' }}" class="text-right">
                        {% set purchase = component.child|product_purchase_cost(false) * component.quantity %}
                        {{- purchase|localizedcurrency(commerce_default_currency) -}}
                        {% set total_purchase = total_purchase + purchase %}
                    </td>
                    <td id="{{ component_id ~ 'margin' }}" class="text-right">
                        {%- if 0 < purchase  -%}
                            {%- if 0 < price -%}
                                {{ ((price - purchase) / price * 100)|round(2)|localizednumber }}%
                            {%- else -%}
                                <span class="text-red">&dash;&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            &dash;
                        {%- endif -%}
                    </td>
                </tr>
                {%- else -%}
                <tr>
                    <td colspan="7" class="text-center"><em>{{ 'ekyna_core.value.no_item'|trans }}</em></td>
                </tr>
                {%- endfor -%}
                <tr>
                    <td colspan="3" class="text-right">
                        <strong>{{ 'ekyna_core.field.total'|trans }}</strong>
                    </td>
                    <td class="text-right">
                        {{- total_weight|localizednumber -}}
                    </td>
                    <td class="text-right">
                        {{- total_price|localizedcurrency(commerce_default_currency) -}}
                    </td>
                    <td class="text-right">
                        {{- total_purchase|localizedcurrency(commerce_default_currency) -}}
                    </td>
                    <td class="text-right">
                        {%- if 0 < total_purchase  -%}
                            {%- if 0 < total_price -%}
                                {{ ((total_price - total_purchase) / total_price * 100)|round(2)|localizednumber }}%
                            {%- else -%}
                                <span class="text-red">-&infin;</span>
                            {%- endif -%}
                        {%- else -%}
                            -
                        {%- endif -%}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{%- endmacro show_components -%}


{%- macro show_cross_sellings(product) -%}
<div class="row show-row">
    <div class="col-md-2 show-label">
        {{- 'ekyna_product.cross_selling.label.plural'|trans -}}
    </div>
    <div class="col-md-10">
        <div class="show-widget show-widget-sm show-product-configurable">
            <table class="table table-stripped table-condensed table-hover table-alt-head">
                <thead>
                <tr>
                    <th>{{ 'ekyna_core.field.designation'|trans }}</th>
                    <th>{{ 'ekyna_core.field.reference'|trans }}</th>
                    <th class="text-right">{{ 'ekyna_commerce.field.net_price'|trans }}</th>
                </tr>
                </thead>
                <tbody>
                {%- for crossSelling in product.crossSellings -%}
                    {%- set crossSelling_id = 'product_crossSelling_' ~ loop.index0 ~ '_' -%}
                <tr>
                    <td id="{{ crossSelling_id ~ 'designation' }}">
                        <a href="{{ admin_resource_path(crossSelling.target) }}" data-summary='{{ {
                            'route': 'ekyna_product_product_admin_summary',
                            'parameters': {'productId': crossSelling.target.id}
                        }|json_encode }}'>{{ crossSelling.target }}</a>
                    </td>
                    <td>
                        <span data-clipboard-copy="{{ crossSelling.target.reference }}">{{ crossSelling.target.reference }}</span>
                    </td>
                    <td id="{{ crossSelling_id ~ 'netPrice' }}" class="text-right">
                        {{- crossSelling.target.netPrice|localizedcurrency(commerce_default_currency) -}}
                    </td>
                </tr>
                {%- else -%}
                <tr>
                    <td colspan="3" class="text-center"><em>{{ 'ekyna_core.value.no_item'|trans }}</em></td>
                </tr>
                {%- endfor -%}
                </tbody>
            </table>
        </div>
    </div>
</div>
{%- endmacro show_cross_sellings -%}


{%- macro show_configurable_composition(product, options = {}) -%}
    {% import _self as macros %}
    <div class="row show-row">
        <div class="col-md-2 show-label">
            {{- 'ekyna_product.bundle_slot.label.plural'|trans -}}
        </div>
        <div class="col-md-10">
            <div class="show-widget show-widget-sm show-product-configurable">
            {%- if product is configurable_product -%}
                <p class="total">
                    <strong>{{ 'ekyna_product.product.field.total_net_price'|trans }}</strong>
                    <span>{{ product|product_configurable_total_price|localizedcurrency(commerce_default_currency) }}</span>
                </p>
                {%- for slot in product.bundleSlots -%}
                {%- set slot_id = 'product_slots_' ~ loop.index0 ~ '_' -%}
                <div class="slot collection-item">
                    <span class="bundle-slot-index">{{ slot.position }}</span>
                    {{- show_row(slot.translations, 'translations', {
                        'id': slot_id ~ 'translations',
                        'fields': {
                            'title': {'label': 'ekyna_core.field.title'},
                            'description': {
                                'label': 'ekyna_core.field.description',
                                'type': 'textarea',
                                'options': {'html': true},
                            },
                        }
                    }) -}}
                    <div class="row">
                        <div class="col-md-6">
                            {{- show_row(slot.media, 'media', {
                                'label': 'ekyna_core.field.image',
                                'id': slot_id ~ 'image',
                                'label_col': 4
                            }) -}}
                        </div>
                        <div class="col-md-6">
                            {{- show_row(slot.required, 'boolean', {
                                'label': 'ekyna_core.field.required',
                                'id': slot_id ~ 'required',
                                'color': true,
                                'label_col': 4
                            }) -}}
                        </div>
                    </div>
                    {%- if slot.rules is not empty -%}
                    <div class="row show-row">
                        <div class="col-md-2 show-label">
                            {{- 'ekyna_product.bundle_rule.label.plural'|trans -}}
                        </div>
                        <div class="col-md-10">
                            <div id="{{ slot_id ~ 'rules' }}" class="show-widget bundle-rules">
                                {{- macros.show_bundle_rules(slot.rules, product) -}}
                            </div>
                        </div>
                    </div>
                    {%- endif -%}
                    <table class="table table-stripped table-condensed table-hover table-alt-head">
                        <tr>
                            <th>&nbsp;</th>
                            <th>{{ 'ekyna_product.product.label.singular'|trans }}</th>
                            <th>{{ 'ekyna_core.field.reference'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_core.field.type'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_commerce.stock_subject.field.state'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_core.field.visible'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_product.option.label.plural'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_product.common.min_quantity'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_product.common.max_quantity'|trans }}</th>
                            <th class="text-right">{{ 'ekyna_commerce.field.net_price'|trans }}</th>
                        </tr>
                        {%- for choice in slot.choices -%}
                        {%- set choice_id = slot_id ~ '_choice_' ~ loop.index0 ~ '_' -%}
                        {%- set choice_product = choice.product -%}
                        <tr>
                            <td style="font-size: 11px">[{{ slot.position }}.{{ choice.position }}]</td>
                            <td id="{{ choice_id ~ 'product' }}">
                                <a href="{{ admin_resource_path(choice_product) }}" class="show-entity"
                                   data-summary='{{ {
                                       'route': 'ekyna_product_product_admin_summary',
                                       'parameters': {'productId': choice_product.id}
                                   }|json_encode }}'>
                                    {{- choice_product -}}
                                </a>
                            </td>
                            <td id="{{ choice_id ~ 'reference' }}" class="text-right" style="font-size: 11px"
                                data-clipboard-copy="{{ choice_product.reference }}">
                                {{- choice_product.reference -}}
                            </td>
                            <td id="{{ choice_id ~ 'type' }}" class="text-right" style="font-size: 11px">
                                {{- choice_product|product_type_badge -}}
                            </td>
                            <td id="{{ choice_id ~ 'stockState' }}" class="text-right" style="font-size: 11px">
                                {{- choice_product|stock_subject_state_badge -}}
                            </td>
                            <td id="{{ choice_id ~ 'visible' }}" class="text-right" style="font-size: 11px">
                                {%- if choice_product.visible -%}
                                    <span class="label label-success">{{ 'ekyna_core.value.yes'|trans }}</span>
                                {%- else -%}
                                    <span class="label label-danger">{{ 'ekyna_core.value.no'|trans }}</span>
                                {%- endif -%}
                            </td>
                            <td id="{{ choice_id ~ 'options' }}" class="text-right" style="font-size: 11px">
                                {{ choice|bundle_choice_option_groups }}
                            </td>
                            <td id="{{ choice_id ~ 'minQuantity' }}" class="text-right">
                                {# TODO Packgaging format #}
                                {{- choice.minQuantity|localizednumber -}}
                            </td>
                            <td id="{{ choice_id ~ 'maxQuantity' }}" class="text-right">
                                {# TODO Packgaging format #}
                                {{- choice.maxQuantity|localizednumber -}}
                            </td>
                            <td id="{{ choice_id ~ 'product_netPrice' }}" class="text-right">
                                {{- (choice_product.netPrice * choice.minQuantity)|localizedcurrency(commerce_default_currency) -}}
                            </td>
                        </tr>
                        {%- if choice.rules is not empty -%}
                        <tr>
                            <td colspan="10" class="bundle-rules">
                                {{- macros.show_bundle_rules(choice.rules, product) -}}
                            </td>
                        </tr>
                        {%- endif -%}
                        {%- endfor -%}
                    </table>
                </div>
                {%- endfor -%}
            {%- else -%}
                <p class="alert alert-danger">
                    <em>Wrong product type</em>
                </p>
            {%- endif -%}
            </div>
        </div>
    </div>
{%- endmacro show_configurable_composition -%}


{%- macro show_relations(products) -%}
    <table class="table table-stripped table-condensed table-hover table-alt-head">
        <tr>
            <th>{{ 'ekyna_product.product.label.singular'|trans }}</th>
            <th>{{ 'ekyna_core.field.reference'|trans }}</th>
            <th class="text-right">{{ 'ekyna_core.field.type'|trans }}</th>
            <th class="text-right">{{ 'ekyna_commerce.stock_subject.field.state'|trans }}</th>
            <th class="text-right">{{ 'ekyna_core.field.visible'|trans }}</th>
            <th class="text-right">{{ 'ekyna_commerce.field.net_price'|trans }}</th>
        </tr>
        {%- for product in products -%}
            {%- set relationId = 'relation_' ~loop.index0 ~ '_' -%}
            <tr>
                <td id="{{ relationId ~ 'product' }}">
                    <a href="{{ admin_resource_path(product) }}" class="show-entity"
                       data-summary='{{ {
                           'route': 'ekyna_product_product_admin_summary',
                           'parameters': {'productId': product.id}
                       }|json_encode }}'>
                        {{- product -}}
                    </a>
                </td>
                <td id="{{ relationId ~ 'reference' }}" class="text-right" style="font-size: 11px"
                    data-clipboard-copy="{{ product.reference }}">
                    {{- product.reference -}}
                </td>
                <td id="{{ relationId ~ 'type' }}" class="text-right" style="font-size: 11px">
                    {{- product|product_type_badge -}}
                </td>
                <td id="{{ relationId ~ 'stockState' }}" class="text-right" style="font-size: 11px">
                    {{- product|stock_subject_state_badge -}}
                </td>
                <td id="{{ relationId ~ 'visible' }}" class="text-right" style="font-size: 11px">
                    {%- if product.visible -%}
                        <span class="label label-success">{{ 'ekyna_core.value.yes'|trans }}</span>
                    {%- else -%}
                        <span class="label label-danger">{{ 'ekyna_core.value.no'|trans }}</span>
                    {%- endif -%}
                </td>
                <td id="{{ relationId ~ 'product_netPrice' }}" class="text-right">
                    {{- product.netPrice|localizedcurrency(commerce_default_currency) -}}
                </td>
            </tr>
        {%- endfor -%}
    </table>
{%- endmacro show_relations -%}


{%- macro show_seo(product, options = {}) -%}
    {{- show_row(product.seo, 'seo', {
        'id': 'product_seo'
    }|merge(options)) -}}
{%- endmacro show_seo -%}


{%- macro show_stock_units(product) -%}
    {%- if product.stockMode is not stock_mode_disabled -%}
        <hr>
        {%- if product.stockMode is stock_mode_manual -%}
        <div class="actions">
            {{- admin_resource_btn('ekyna_product.product_stock_unit', 'new', {
                'label': 'ekyna_commerce.stock_unit.button.new',
                'size': 'xs',
                'path': path('ekyna_product_product_stock_unit_admin_new', {
                    'productId': product.id,
                })
            }) -}}
        </div>
        {%- endif -%}
        {{- render_subject_stock_units(product, {
            'prefix': 'product_stockUnit',
            'id': 'stock-units-view'
        }) -}}
    {%- endif -%}
{%- endmacro show_stock_units -%}


{%- macro show_stat_charts(product) -%}
    <div class="panel-group" id="stat_collapse" role="tablist" aria-multiselectable="true">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="count_stat_heading">
                <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#stat_collapse" href="#collapse_count_chart"
                       aria-expanded="true" aria-controls="collapseOne" style="display:block;">
                        {{- 'ekyna_product.stat.count'|trans -}}
                    </a>
                </h4>
            </div>
            <div id="collapse_count_chart" class="panel-collapse collapse in" role="tabpanel"
                 aria-labelledby="count_stat_heading">
                <div class="panel-body">
                    {{- product_stat_count_chart(product) -}}
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="cross_stat_heading">
                <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" data-parent="#stat_collapse" href="#collapse_cross_chart"
                       aria-expanded="true" aria-controls="collapseOne" style="display:block;">
                        {{- 'ekyna_product.stat.cross'|trans -}}
                    </a>
                </h4>
            </div>
            <div id="collapse_cross_chart" class="panel-collapse collapse" role="tabpanel" aria-labelledby="cross_stat_heading">
                <div class="panel-body">
                    {{- product_stat_cross_chart(product) -}}
                </div>
            </div>
        </div>
    </div>
{%- endmacro show_stat_charts -%}
