<?xml version="1.0" encoding="UTF-8" ?>
<container
        xmlns="http://symfony.com/schema/dic/services"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://symfony.com/schema/dic/services
                        http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="ekyna_product.attribute_slot.class">Ekyna\Bundle\ProductBundle\Entity\AttributeSlot</parameter>

        <parameter key="ekyna_product.pricing.form_type.class">Ekyna\Bundle\ProductBundle\Form\Type\Pricing\PricingType</parameter>

        <parameter key="ekyna_product.product.search_repository.class">Ekyna\Bundle\ProductBundle\Service\Search\ProductRepository</parameter>
        <parameter key="ekyna_product.brand.search_repository.class">Ekyna\Bundle\ProductBundle\Service\Search\BrandRepository</parameter>
        <parameter key="ekyna_product.category.search_repository.class">Ekyna\Bundle\ProductBundle\Service\Search\CategoryRepository</parameter>

        <!-- TODO Remove ? (can be overridden by compiler pass) -->
        <parameter key="ekyna_product.product.form_type.class">Ekyna\Bundle\ProductBundle\Form\Type\ProductType</parameter>
        <parameter key="ekyna_product.product.form_type.builder.class">Ekyna\Bundle\ProductBundle\Form\ProductFormBuilder</parameter>
        <parameter key="ekyna_product.product.form_type.event_subscriber.class">Ekyna\Bundle\ProductBundle\Form\EventListener\ProductTypeSubscriber</parameter>
    </parameters>

    <services>

        <!-- Attribute types -->
        <service id="ekyna_product.attribute.type_registry"
                 class="Ekyna\Bundle\ProductBundle\Attribute\AttributeTypeRegistry"
                 lazy="true">
            <argument type="collection"/>
        </service>
        <service id="ekyna_product.attribute.type.select"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\SelectType">
            <tag name="ekyna_product.attribute_type" alias="select"/>
        </service>
        <service id="ekyna_product.attribute.type.text"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\TextType">
            <tag name="ekyna_product.attribute_type" alias="text"/>
        </service>
        <service id="ekyna_product.attribute.type.boolean"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\BooleanType">
            <argument type="service" id="translator"/>
            <argument>%locales%</argument>
            <argument>%kernel.default_locale%</argument>
            <tag name="ekyna_product.attribute_type" alias="boolean"/>
        </service>
        <service id="ekyna_product.attribute.type.unit"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\UnitType">
            <argument type="service" id="translator"/>
            <tag name="ekyna_product.attribute_type" alias="unit"/>
        </service>

        <!-- Inventory -->
        <service id="ekyna_product.inventory"
                 class="Ekyna\Bundle\ProductBundle\Service\Stock\Inventory">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <argument type="service" id="router"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="form.factory"/>
            <argument type="service" id="session"/>
            <argument type="service" id="ekyna_commerce.util.formatter.default"/>
            <argument>%ekyna_commerce.supplier_order_item.class%</argument>
            <argument>%ekyna_product.product_stock_unit.class%</argument>
        </service>
        <service id="ekyna_product.resupply"
                 class="Ekyna\Bundle\ProductBundle\Service\Stock\Resupply">
            <argument type="service" id="ekyna_commerce.supplier_order.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_order_item.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_order.operator"/>
        </service>
        <service id="ekyna_product.inventory.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\InventoryType">
            <argument type="service" id="ekyna_product.brand.repository"/>
            <argument type="service" id="ekyna_commerce.supplier.repository"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.inventory_quick_edit.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\QuickEditType">
            <argument type="service" id="ekyna_product.product.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.stock_subject.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.pricing.tax_resolver"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.inventory_resupply.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\ResupplyType">
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <tag name="form.type"/>
            <tag name="form.js" selector="form[name=ekyna_product_inventory_resupply]" path="ekyna-product/form/resupply"/>
        </service>
        <service id="ekyna_product.inventory_resupply_product.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\ResupplyProductType">
            <argument type="service" id="ekyna_commerce.supplier_order.repository"/>
            <tag name="form.type"/>
        </service>

        <!-- Category event listener -->
        <service id="ekyna_product.category.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\CategoryListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product subject provider -->
        <service id="ekyna_product.commerce.subject_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ProductProvider">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.pricing.resolver"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="ekyna_commerce.subject_provider"/>
        </service>
        <service id="ekyna_product.commerce.product_filter"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ProductFilter">
            <argument type="service" id="ekyna_commerce.customer.security_provider"/>
        </service>
        <service id="ekyna_product.commerce.item_builder"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ItemBuilder">
            <argument type="service" id="ekyna_product.commerce.subject_provider"/>
            <argument type="service" id="ekyna_product.commerce.product_filter"/>
        </service>
        <service id="ekyna_product.commerce.form_builder"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\FormBuilder">
            <argument type="service" id="ekyna_product.commerce.subject_provider"/>
            <argument type="service" id="ekyna_product.commerce.product_filter"/>
            <argument type="service" id="ekyna_product.pricing.calculator"/>
            <argument type="service" id="ekyna_commerce.availability_helper"/>
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <argument type="service" id="translator"/>
            <argument>%ekyna_product.default.no_image%</argument>
            <call method="setCacheManager">
                <argument type="service" id="liip_imagine.cache.manager"/>
            </call>
        </service>

        <!-- Constants helper -->
        <service id="ekyna_product.constants_helper"
                 class="Ekyna\Bundle\ProductBundle\Service\ConstantsHelper">
            <argument type="service" id="translator"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
        </service>

        <!-- TODO Remove resources form types definitions (see configuration), by using resource choice form types -->

        <!-- Attribute form types -->
        <service id="ekyna_product.attribute.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeType">
            <argument>%ekyna_product.attribute.class%</argument>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeChoiceType">
            <argument>%ekyna_product.attribute_choice.class%</argument>
            <argument>%ekyna_product.attribute.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeSlotType">
            <argument>%ekyna_product.attribute_slot.class%</argument>
            <argument>%ekyna_product.attribute.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_set_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeSetChoiceType">
            <argument>%ekyna_product.attribute_set.class%</argument>
            <tag name="form.type"/>
        </service>
        <!-- Attribute type form types -->
        <service id="ekyna_product.attribute.unit.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\Type\UnitAttributeType">
            <argument type="service" id="translator"/>
            <tag name="form.type"/>
        </service>

        <!-- Brand choice form type -->
        <service id="ekyna_product.brand_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Brand\BrandChoiceType">
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Bundle form types -->
        <service id="ekyna_product.bundle_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleChoiceType">
            <argument>%ekyna_product.bundle_choice.class%</argument>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_choice_rule.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleChoiceRuleType">
            <argument>%ekyna_product.bundle_choice_rule.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleSlotType">
            <argument>%ekyna_product.bundle_slot.class%</argument>
            <argument>%ekyna_product.bundle_choice.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Bundle choice event listener -->
        <service id="ekyna_product.bundle_choice.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\BundleChoiceListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>
        <!-- Bundle slot event listener -->
        <service id="ekyna_product.bundle_slot.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\BundleSlotListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Catalog form types -->
        <service id="ekyna_product.catalog.theme_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Catalog\CatalogThemeChoiceType">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.catalog_page.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Catalog\CatalogPageType">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="form.type"/>
            <tag name="form.js" selector=".catalog-page" path="ekyna-product/form/catalog-page"/>
        </service>

        <!-- Category choice form type -->
        <service id="ekyna_product.category_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Category\CategoryChoiceType">
            <argument>%ekyna_product.category.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Sale item configurable/slots form types -->
        <service id="ekyna_product.sale_item.configurable_slots.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\ConfigurableSlotsType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.sale_item.configurable_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\ConfigurableSlotType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <tag name="form.type"/>
        </service>

        <!-- Sale item options/groups form types -->
        <service id="ekyna_product.sale_item.option_groups.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\OptionGroupsType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.sale_item.option_group.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\OptionGroupType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.sale_item.variant_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\VariantChoiceType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <tag name="form.type"/>
        </service>

        <!-- Sale item configure type extension -->
        <service id="ekyna_product.sale_item_configure.type_extension"
                 class="Ekyna\Bundle\ProductBundle\Form\Extension\SaleItemConfigureTypeExtension">
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <argument type="service" id="twig.form.renderer"/>
            <argument>%ekyna_product.default.sale_item_form_theme%</argument>
            <tag name="form.type_extension"
                 extended-type="Ekyna\Bundle\CommerceBundle\Form\Type\Sale\SaleItemConfigureType"/>
            <tag name="form.js" selector=".sale-item-configure"
                 path="ekyna-product/form/sale-item-configure"/>
        </service>

        <!-- Option form types -->
        <service id="ekyna_product.option.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Option\OptionType">
            <argument>%ekyna_product.option.class%</argument>
            <tag name="form.js" selector=".product-option" path="ekyna-product/form/product-option"/>
            <tag name="form.type"/>
        </service>

        <!-- Option event listener -->
        <service id="ekyna_product.option.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\OptionListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Pricing form types -->
        <service id="ekyna_product.pricing.form_type"
                 class="%ekyna_product.pricing.form_type.class%">
            <argument>%ekyna_product.pricing.class%</argument>
            <argument>%ekyna_commerce.customer_group.class%</argument>
            <argument>%ekyna_commerce.country.class%</argument>
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Product form type builder -->
        <service id="ekyna_product.product.form_type.builder"
                 class="%ekyna_product.product.form_type.builder.class%">
            <argument>%ekyna_product.product.class%</argument>
            <argument>%ekyna_product.product_media.class%</argument>
        </service>

        <!-- Product form types -->
        <service id="ekyna_product.product.form_type.event_subscriber"
                 class="%ekyna_product.product.form_type.event_subscriber.class%">
            <argument type="service" id="ekyna_product.product.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.stock_subject.form_type.builder"/>
            <argument type="service" id="ekyna_product.attribute_set.repository"/>
        </service>
        <service id="ekyna_product.product.form_type"
                 class="%ekyna_product.product.form_type.class%">
            <argument type="service" id="ekyna_product.product.form_type.event_subscriber"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.product_attributes.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\ProductAttributesType">
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <argument>%ekyna_product.product_attribute.class%</argument>
            <tag name="form.js" selector=".product-attributes" path="ekyna-product/form/product-attributes"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute.boolean_config.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\Config\BooleanConfigType">
            <argument>%locales%</argument>
            <argument>%kernel.default_locale%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.product_search.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\ProductSearchType">
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.editor.block_plugin.product_slide.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Editor\ProductSlideBlockType">
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="form.type"/>
        </service>

        <!-- Product type column column type -->
        <service id="ekyna_product.product_type.column_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Column\ProductTypeType">
            <argument type="service" id="ekyna_product.constants_helper"/>
            <tag name="table.column_type"/>
        </service>

        <!-- Product table type -->
        <service id="ekyna_product.product.table_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Type\ProductType"><!-- TODO use parameter defined by config builder -->
            <argument type="service" id="ekyna_commerce.subject_helper"/>
            <argument>%ekyna_product.product.class%</argument>
            <argument>%ekyna_product.brand.class%</argument>
            <argument>%ekyna_product.category.class%</argument>
            <argument>%ekyna_commerce.tax_group.class%</argument>
            <argument>%ekyna_cms.tag.class%</argument>
            <tag name="table.type"/>
        </service>

        <!-- Show types -->
        <service id="ekyna_product.show.attribute_config_type"
                 class="Ekyna\Bundle\ProductBundle\Show\Type\AttributeConfigType">
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="ekyna_admin.show.type" alias="attribute_config"/>
        </service>

        <!-- Price resolver -->
        <service id="ekyna_product.pricing.resolver"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceResolver"
                 lazy="true">
            <argument id="ekyna_product.pricing.repository" type="service"/>
        </service>

        <!-- Price calculator -->
        <service id="ekyna_product.pricing.calculator"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceCalculator"
                 lazy="true">
            <argument id="ekyna_product.pricing.resolver" type="service"/>
            <argument id="ekyna_commerce.pricing.tax_resolver" type="service"/>
            <argument id="ekyna_commerce.currency.converter" type="service"/>
            <argument id="ekyna_commerce.common.context_provider" type="service"/>
            <argument>%ekyna_commerce.default.currency%</argument>
        </service>

        <!-- Price renderer -->
        <service id="ekyna_product.pricing.renderer"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceRenderer"
                 lazy="true">
            <argument id="ekyna_product.pricing.calculator" type="service"/>
            <argument id="ekyna_resource.locale.request_provider" type="service"/>
            <argument id="ekyna_commerce.util.formatter_factory" type="service"/>
            <argument id="translator" type="service"/>
            <argument id="templating" type="service"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
        </service>

        <!-- Pricing event listener -->
        <service id="ekyna_product.pricing.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\PricingEventSubscriber">
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Schema.org providers -->
        <service id="ekyna_product.product.schema_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\SchemaOrg\ProductProvider">
            <argument>%ekyna_commerce.default.currency%</argument>
            <tag name="ekyna_cms.schema_org_provider"/>
        </service>
        <service id="ekyna_product.brand.schema_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\SchemaOrg\BrandProvider">
            <tag name="ekyna_cms.schema_org_provider"/>
        </service>

        <!-- Twig extensions -->
        <service id="ekyna_product.twig.product_extension"
                 class="Ekyna\Bundle\ProductBundle\Twig\ProductExtension">
            <argument type="service" id="ekyna_product.constants_helper"/>
            <argument type="service" id="ekyna_product.pricing.renderer"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument>%ekyna_product.default.no_image%</argument>
            <tag name="twig.extension"/>
        </service>
        <service id="ekyna_product.twig.catalog_extension"
                 class="Ekyna\Bundle\ProductBundle\Twig\CatalogExtension">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="twig.extension"/>
        </service>

        <!-- Add to cart event subscriber -->
        <service id="ekyna_product.add_to_cart.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\AddToCartEventSubscriber">
            <argument type="service" id="templating"/>
            <argument type="string"/><!-- Replaced by DI extension -->
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Sale item event listener -->
        <service id="ekyna_product.sale_item.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\SaleItemEventSubscriber">
            <argument type="service" id="ekyna_commerce.common.context_provider"/>
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <argument type="service" id="ekyna_product.pricing.resolver"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Variant generator -->
        <service id="ekyna_product.product.variant_generator"
                 class="Ekyna\Bundle\ProductBundle\Service\Generator\VariantGenerator">
            <argument>%ekyna_product.product.class%</argument>
        </service>

        <!-- Simple product event handler -->
        <service id="ekyna_product.product.event_subscriber.simple_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\SimpleHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Variant product event handler -->
        <service id="ekyna_product.product.event_subscriber.variant_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\VariantHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Variable product event handler -->
        <service id="ekyna_product.product.event_subscriber.variable_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\VariableHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Bundle product event handler -->
        <service id="ekyna_product.product.event_subscriber.bundle_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\BundleHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.pricing.calculator"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Configurable product event handler -->
        <service id="ekyna_product.product.event_subscriber.configurable_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\ConfigurableHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.pricing.calculator"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>

        <!-- Product event handlers registry -->
        <service id="ekyna_product.product.event_subscriber.handler_registry"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\HandlerRegistry"/>

        <!-- Product event listener -->
        <service id="ekyna_product.product.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductEventSubscriber">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.product.event_subscriber.handler_registry"/>
            <argument type="service" id="ekyna_product.product.reference_generator"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product stock unit event listener -->
        <service id="ekyna_product.product_stock_unit.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductStockUnitEventSubscriber"
                 parent="ekyna_commerce.stock_unit.abstract_listener">
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Supplier product event listener -->
        <service id="ekyna_product.supplier_product.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\SupplierProductEventSubscriber">
            <argument type="service" id="request_stack"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product label event listener -->
        <service id="ekyna_product.product.label_event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\LabelEventSubscriber">
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Product constraint validator -->
        <service id="ekyna_product.validator.product_validator"
                 class="Ekyna\Bundle\ProductBundle\Validator\Constraints\ProductValidator">
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Variant constraint validator -->
        <service id="ekyna_product.validator.variant_validator"
                 class="Ekyna\Bundle\ProductBundle\Validator\Constraints\VariantValidator">
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Product attribute constraint validator -->
        <service id="ekyna_product.validator.product_attribute_validator"
                 class="Ekyna\Bundle\ProductBundle\Validator\Constraints\ProductAttributeValidator">
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Reference generator -->
        <service id="ekyna_product.product.reference_generator"
                 class="Ekyna\Bundle\ProductBundle\Service\Generator\ReferenceGenerator">
            <argument>%kernel.data_dir%/product_reference</argument>
            <argument>ym</argument>
            <argument>8</argument>
        </service>

        <!-- Product converter -->
        <service id="ekyna_product.product.product_converter"
                 class="Ekyna\Bundle\ProductBundle\Service\Converter\ProductConverter">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="form.factory"/>
            <argument type="service" id="request_stack"/>
        </service>

        <!-- Product convert form type -->
        <service id="ekyna_product.convert_variable.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Convert\VariableType">
            <argument type="service" id="ekyna_admin.helper.resource_helper"/>
            <argument type="service" id="ekyna_product.attribute_set.repository"/>
            <tag name="form.type"/>
        </service>


        <!-- CMS Editor plugins -->
        <service id="ekyna_product.editor.block_plugin.product_thumb"
                 class="Ekyna\Bundle\ProductBundle\Service\Editor\Block\ProductSlidePlugin"
                 parent="ekyna_cms.editor.block_plugin.abstract"
                 public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="templating"/>
            <argument>%ekyna_product.editor.slide%</argument>
            <tag name="ekyna_cms.editor.block_plugin"/>
        </service>

        <!-- Search -->
        <!-- TODO Handle wide_search tag in \Ekyna\Bundle\ResourceBundle\Elastica\RepositoryManager
        <service id="ekyna_product.category.search_repository"
                 class="%ekyna_product.category.search_repository.class%">
            <factory service="fos_elastica.manager" method="getRepository"/>
            <argument>%ekyna_product.category.class%</argument>
            <tag name="ekyna_cms.wide_search.provider"/>
        </service>
        <service id="ekyna_product.brand.search_repository"
                 class="%ekyna_product.brand.search_repository.class%">
            <factory service="fos_elastica.manager" method="getRepository"/>
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="ekyna_cms.wide_search.provider"/>
        </service>
        <service id="ekyna_product.product.search_repository"
                 class="%ekyna_product.product.search_repository.class%">
            <factory service="fos_elastica.manager" method="getRepository"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="ekyna_cms.wide_search.provider"/>
        </service>-->

        <!-- Catalog services -->
        <service id="ekyna_product.catalog.registry"
                 class="Ekyna\Bundle\ProductBundle\Service\Catalog\CatalogRegistry">
            <argument type="collection"/><!-- Replaced by DI extension -->
            <argument type="collection"/><!-- Replaced by DI extension -->
        </service>
        <service id="ekyna_product.catalog.renderer"
                 class="Ekyna\Bundle\ProductBundle\Service\Catalog\CatalogRenderer">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <argument type="service" id="templating"/>
            <argument type="service" id="knp_snappy.pdf"/>
            <argument>%ekyna_commerce.company_logo%</argument>
            <argument>%kernel.debug%</argument>
        </service>

        <!-- Serialization -->
        <service id="ekyna_product.product.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\ProductNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer"
                 public="false">
            <call method="setSubjectNormalizerHelper">
                <argument type="service" id="ekyna_commerce.subject.normalizer_helper"/>
            </call>
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.product_reference.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\ProductReferenceNormalizer"
                 public="false">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.brand.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\BrandNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer"
                 public="false">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.category.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\CategoryNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer"
                 public="false">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>

        <!-- Commands -->
        <service id="ekyna_product.command.stock_report"
                 class="Ekyna\Bundle\ProductBundle\Command\StockReportCommand">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="templating"/>
            <argument type="service" id="ekyna_setting.manager"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="mailer"/>
            <tag name="console.command"/>
        </service>

    </services>

</container>
