<?xml version="1.0" encoding="UTF-8" ?>
<container
    xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services
                        http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="ekyna_product.attribute_slot.class">Ekyna\Bundle\ProductBundle\Entity\AttributeSlot</parameter>

        <parameter key="ekyna_product.configurable_slot.form_type.class">Ekyna\Bundle\ProductBundle\Form\Type\ConfigurableSlotType</parameter>

        <parameter key="ekyna_product.option_group.class">Ekyna\Bundle\ProductBundle\Entity\OptionGroup</parameter>
        <parameter key="ekyna_product.option.class">Ekyna\Bundle\ProductBundle\Entity\Option</parameter>

        <parameter key="ekyna_product.pricing.form_type.class">Ekyna\Bundle\ProductBundle\Form\Type\PricingType</parameter>

        <parameter key="ekyna_product.product.form_type.class">Ekyna\Bundle\ProductBundle\Form\Type\ProductType</parameter>
        <parameter key="ekyna_product.product.form_type.builder.class">Ekyna\Bundle\ProductBundle\Form\ProductFormBuilder</parameter>
        <parameter key="ekyna_product.product.form_type.event_subscriber.class">Ekyna\Bundle\ProductBundle\Form\EventListener\ProductTypeSubscriber</parameter>

        <parameter key="ekyna_product.product.search_repository.class">Ekyna\Bundle\ProductBundle\Service\Search\ProductRepository</parameter>
        <parameter key="ekyna_product.brand.search_repository.class">Ekyna\Bundle\ProductBundle\Service\Search\BrandRepository</parameter>
        <parameter key="ekyna_product.category.search_repository.class">Ekyna\Bundle\ProductBundle\Service\Search\CategoryRepository</parameter>
    </parameters>

    <services>

        <!-- Constants helper -->
        <service id="ekyna_product.constants_helper"
                 class="Ekyna\Bundle\ProductBundle\Service\ConstantsHelper">
            <argument type="service" id="translator"/>
        </service>

        <!-- TODO Remove resources form types definitions (see configuration), by using resource choice form types -->

        <!-- Attribute form types -->
        <service id="ekyna_product.attribute.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\AttributeType">
            <argument>%ekyna_product.attribute.class%</argument>
            <argument>%ekyna_product.attribute_group.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\AttributeSlotType">
            <argument>%ekyna_product.attribute_slot.class%</argument>
            <argument>%ekyna_product.attribute_group.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Brand choice form type -->
        <service id="ekyna_product.brand_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\BrandChoiceType">
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Bundle form types -->
        <service id="ekyna_product.bundle_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\BundleChoiceType">
            <argument>%ekyna_product.bundle_choice.class%</argument>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_choice_rule.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\BundleChoiceRuleType">
            <argument>%ekyna_product.bundle_choice_rule.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\BundleSlotType">
            <argument>%ekyna_product.bundle_slot.class%</argument>
            <argument>%ekyna_product.bundle_choice.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Category choice form type -->
        <service id="ekyna_product.category_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\CategoryChoiceType">
            <argument>%ekyna_product.category.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Configurable slot form types -->
        <service id="ekyna_product.configurable_slots.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\ConfigurableSlotsType">
            <argument>%ekyna_product.configurable_slot.form_type.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.configurable_slot.form_type"
                 class="%ekyna_product.configurable_slot.form_type.class%">
            <argument type="service" id="ekyna_product.product.subject_provider"/>
            <argument>%ekyna_product.default.no_image%</argument>
            <call method="setCacheManager">
                <argument type="service" id="liip_imagine.cache.manager"/>
            </call>
            <tag name="form.type"/>
            <tag name="form.js" selector=".product-configurable-slot" path="ekyna-product/form/configurable-slot" />
        </service>

        <!-- Pricing form types -->
        <service id="ekyna_product.pricing.form_type"
                 class="%ekyna_product.pricing.form_type.class%">
            <argument>%ekyna_product.pricing.class%</argument>
            <argument>%ekyna_commerce.customer_group.class%</argument>
            <argument>%ekyna_commerce.country.class%</argument>
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Product form types -->
        <service id="ekyna_product.product.form_type.builder"
                 class="%ekyna_product.product.form_type.builder.class%">
            <argument>%ekyna_product.product.class%</argument>
            <argument>%ekyna_product.product_media.class%</argument>
            <argument>%ekyna_product.attribute_set.class%</argument>
        </service>
        <service id="ekyna_product.product.form_type.event_subscriber"
                 class="%ekyna_product.product.form_type.event_subscriber.class%">
            <argument type="service" id="ekyna_product.product.form_type.builder"/>
        </service>
        <service id="ekyna_product.product.form_type"
                 class="%ekyna_product.product.form_type.class%">
            <argument type="service" id="ekyna_product.product.form_type.event_subscriber"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Product type column column type -->
        <service id="ekyna_product.product_type.column_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Column\ProductTypeType">
            <argument type="service" id="ekyna_product.constants_helper"/>
            <tag name="table.column_type" alias="ekyna_product_product_type"/>
        </service>

        <!-- Product table type -->
        <service id="ekyna_product.product.table_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Type\ProductType"><!-- TODO use parameter defined by config builder -->
            <argument>%ekyna_product.product.class%</argument>
            <argument>%ekyna_product.brand.class%</argument>
            <argument>%ekyna_product.category.class%</argument>
            <argument>%ekyna_commerce.tax_group.class%</argument>
            <tag name="table.type" alias="ekyna_product_product"/>
        </service>

        <!-- Pricing resolver -->
        <service id="ekyna_product.pricing.resolver"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceResolver"
                 lazy="true">
            <argument id="ekyna_product.pricing.repository" type="service"/>
            <argument id="ekyna_commerce.customer_group.repository" type="service"/>
            <argument id="ekyna_commerce.country.repository" type="service"/>
        </service>

        <!-- Twig extension -->
        <service id="ekyna_product.twig.product_extension"
                 class="Ekyna\Bundle\ProductBundle\Twig\ProductExtension">
            <argument type="service" id="ekyna_product.constants_helper"/>
            <tag name="twig.extension"/>
        </service>

        <!-- Product subject provider -->
        <service id="ekyna_product.product.subject_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ProductProvider">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.pricing.resolver"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="ekyna_commerce.subject_provider"/>
        </service>

        <!-- Sale view vars builder -->
        <service id="ekyna_product.sale_view_type"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\SaleViewType"
                 parent="ekyna_commerce.abstract_view_type">
            <tag name="ekyna_commerce.view_type"/>
        </service>

        <!-- Sale item event listener -->
        <service id="ekyna_product.sale_item.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\SaleItemEventSubscriber">
            <argument type="service" id="ekyna_product.product.subject_provider"/>
            <argument type="service" id="ekyna_product.pricing.resolver"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Variant generator -->
        <service id="ekyna_product.product.variant_generator"
                 class="Ekyna\Bundle\ProductBundle\Service\Generator\VariantGenerator">
            <argument>%ekyna_product.product.class%</argument>
        </service>

        <!-- Simple product event handler -->
        <service id="ekyna_product.product.event_subscriber.simple_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\SimpleHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Variant product event handler -->
        <service id="ekyna_product.product.event_subscriber.variant_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\VariantHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Variable product event handler -->
        <service id="ekyna_product.product.event_subscriber.variable_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\VariableHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Bundle product event handler -->
        <service id="ekyna_product.product.event_subscriber.bundle_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\BundleHandler"
                 public="false">
            <!--<argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>-->
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Configurable product event handler -->
        <service id="ekyna_product.product.event_subscriber.configurable_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\ConfigurableHandler"
                 public="false">
            <tag name="ekyna_product.product_event_handler"/>
        </service>

        <!-- Product event handlers registry -->
        <service id="ekyna_product.product.event_subscriber.handler_registry"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\HandlerRegistry"/>

        <!-- Product event listener -->
        <service id="ekyna_product.product.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductEventSubscriber">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.product.event_subscriber.handler_registry"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product stock unit event listener -->
        <service id="ekyna_product.product_stock_unit.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductStockUnitEventSubscriber"
                 parent="ekyna_commerce.stock_unit.abstract_listener">
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Variant constraint validator -->
        <service id="ekyna_product.validator.variant_validator"
                 class="Ekyna\Bundle\ProductBundle\Validator\Constraints\VariantValidator">
            <argument type="service" id="ekyna_resource.locale.request_provider"/>
            <tag name="validator.constraint_validator" />
        </service>

        <!-- Search -->
        <!-- TODO Handle wide_search tag in \Ekyna\Bundle\ResourceBundle\Elastica\RepositoryManager
        <service id="ekyna_product.category.search_repository"
                 class="%ekyna_product.category.search_repository.class%">
            <factory service="fos_elastica.manager" method="getRepository"/>
            <argument>%ekyna_product.category.class%</argument>
            <tag name="ekyna_cms.wide_search.provider"/>
        </service>
        <service id="ekyna_product.brand.search_repository"
                 class="%ekyna_product.brand.search_repository.class%">
            <factory service="fos_elastica.manager" method="getRepository"/>
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="ekyna_cms.wide_search.provider"/>
        </service>
        <service id="ekyna_product.product.search_repository"
                 class="%ekyna_product.product.search_repository.class%">
            <factory service="fos_elastica.manager" method="getRepository"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="ekyna_cms.wide_search.provider"/>
        </service>-->

        <!-- Serialization -->
        <service id="ekyna_product.product.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\ProductNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.brand.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\BrandNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.category.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\CategoryNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>

    </services>

</container>
