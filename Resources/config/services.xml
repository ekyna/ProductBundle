<?xml version="1.0" encoding="UTF-8" ?>
<container
        xmlns="http://symfony.com/schema/dic/services"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://symfony.com/schema/dic/services
                        http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="ekyna_product.attribute_slot.class">Ekyna\Bundle\ProductBundle\Entity\AttributeSlot</parameter>

        <!-- TODO Remove ? (can be overridden by compiler pass) -->
        <parameter key="ekyna_product.product.form_type.class">Ekyna\Bundle\ProductBundle\Form\Type\ProductType</parameter>
        <parameter key="ekyna_product.product.form_type.builder.class">Ekyna\Bundle\ProductBundle\Form\ProductFormBuilder</parameter>
        <parameter key="ekyna_product.product.form_type.event_subscriber.class">Ekyna\Bundle\ProductBundle\Form\EventListener\ProductTypeSubscriber</parameter>
    </parameters>

    <services>

        <!-- Features -->
        <service id="Ekyna\Bundle\ProductBundle\Service\Features">
            <argument type="collection"/><!-- Replaced by DI extension -->
        </service>

        <!-- Product bookmark repository -->
        <service id="Ekyna\Bundle\ProductBundle\Repository\ProductBookmarkRepository"
                 public="false">
            <factory service="doctrine" method="getRepository"/>
            <argument>Ekyna\Bundle\ProductBundle\Entity\ProductBookmark</argument>
        </service>

        <!-- Product account controller -->
        <service id="Ekyna\Bundle\ProductBundle\Controller\Account\ProductController">
            <argument type="service" id="Symfony\Component\Security\Core\Authorization\AuthorizationCheckerInterface"/>
            <argument type="service" id="FOS\ElasticaBundle\Manager\RepositoryManagerInterface"/>
            <argument type="service" id="Elastica\Client"/>
            <argument>%ekyna_product.product.class%</argument>
        </service>

        <!-- Product bookmark controller -->
        <service id="Ekyna\Bundle\ProductBundle\Controller\Admin\ProductBookmarkController">
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\ProductBookmarkRepository"/>
            <argument type="service" id="doctrine"/>
        </service>

        <!-- Account dashboard event subscriber -->
        <service id="ekyna_product.account.dashboard_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\AccountDashboardSubscriber">
            <argument type="service" id="ekyna_commerce.common.context_provider"/>
            <argument type="service" id="ekyna_product.pricing.repository"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Account menu event subscriber -->
        <service id="ekyna_product.account.menu_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\AccountMenuSubscriber">
            <argument type="service" id="ekyna_commerce.customer.security_provider"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Routing loader -->
        <service id="ekyna_product.routing.account_loader"
                 class="Ekyna\Bundle\ProductBundle\Service\Routing\AccountLoader">
            <argument type="collection"/><!-- Replaced by DI extension -->
            <tag name="routing.loader"/>
        </service>

        <!-- Attribute types -->
        <service id="ekyna_product.attribute.type_registry"
                 class="Ekyna\Bundle\ProductBundle\Attribute\AttributeTypeRegistry"
                 lazy="true">
            <argument type="collection"/>
        </service>
        <service id="ekyna_product.attribute.type.select"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\SelectType">
            <tag name="ekyna_product.attribute_type" alias="select"/>
        </service>
        <service id="ekyna_product.attribute.type.text"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\TextType">
            <tag name="ekyna_product.attribute_type" alias="text"/>
        </service>
        <service id="ekyna_product.attribute.type.boolean"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\BooleanType">
            <argument type="service" id="translator"/>
            <argument>%locales%</argument>
            <argument>%kernel.default_locale%</argument>
            <tag name="ekyna_product.attribute_type" alias="boolean"/>
        </service>
        <service id="ekyna_product.attribute.type.unit"
                 class="Ekyna\Bundle\ProductBundle\Attribute\Type\UnitType">
            <argument type="service" id="translator"/>
            <tag name="ekyna_product.attribute_type" alias="unit"/>
        </service>

        <!-- Barcode -->
        <service id="Ekyna\Bundle\ProductBundle\EventListener\BarcodeListener">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="Symfony\Component\Routing\Generator\UrlGeneratorInterface"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Inventory -->
        <service id="ekyna_product.inventory"
                 class="Ekyna\Bundle\ProductBundle\Service\Stock\Inventory">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <argument type="service" id="router"/>
            <argument type="service" id="translator"/>
            <argument type="service" id="form.factory"/>
            <argument type="service" id="session"/>
            <argument type="service" id="ekyna_commerce.util.formatter_factory"/>
            <argument type="service" id="Ekyna\Bundle\AdminBundle\Service\Security\UserProvider"/>
            <argument>%ekyna_commerce.supplier_order_item.class%</argument>
            <argument>%ekyna_product.product_stock_unit.class%</argument>
        </service>
        <service id="ekyna_product.resupply"
                 class="Ekyna\Bundle\ProductBundle\Service\Stock\Resupply">
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_product.operator"/>
            <argument type="service" id="ekyna_commerce.supplier_order.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_order_item.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_order.operator"/>
            <argument type="service" id="ekyna_commerce.supplier_delivery.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_delivery_item.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_delivery.operator"/>
            <argument type="service" id="ekyna_commerce.subject_helper"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\InventoryType">
            <argument type="service" id="ekyna_product.brand.repository"/>
            <argument type="service" id="ekyna_commerce.supplier.repository"/>
            <tag name="form.type"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\QuickEditType">
            <argument type="service" id="ekyna_commerce.subject.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.stock_subject.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.pricing.tax_resolver"/>
            <tag name="form.type"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\BatchEditType">
            <argument type="service" id="ekyna_commerce.stock_subject.form_type.builder"/>
            <tag name="form.type"/>
            <tag name="form.js" selector="form[name=batch_edit]"
                 path="ekyna-product/form/batch-edit"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\ResupplyType">
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <tag name="form.type"/>
            <tag name="form.js" selector="form[name=ekyna_product_inventory_resupply]"
                 path="ekyna-product/form/resupply"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Form\Type\Inventory\ResupplyProductType">
            <argument type="service" id="ekyna_commerce.supplier_order.repository"/>
            <tag name="form.type"/>
        </service>

        <!-- Category event listener -->
        <service id="ekyna_product.category.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\CategoryListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product subject provider -->
        <service id="ekyna_product.commerce.subject_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ProductProvider">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="ekyna_commerce.subject_provider"/>
        </service>
        <service id="ekyna_product.commerce.product_filter"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ProductFilter"/>
        <service id="ekyna_product.commerce.item_builder"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\ItemBuilder">
            <argument type="service" id="ekyna_product.commerce.subject_provider"/>
            <argument type="service" id="ekyna_product.commerce.product_filter"/>
        </service>
        <service id="ekyna_product.commerce.form_builder"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\FormBuilder">
            <argument type="service" id="ekyna_product.commerce.subject_provider"/>
            <argument type="service" id="ekyna_product.commerce.product_filter"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_commerce.availability_helper"/>
            <argument type="service" id="ekyna_resource.locale_provider"/>
            <argument type="service" id="translator"/>
            <argument>%ekyna_product.default.no_image%</argument>
            <call method="setCacheManager">
                <argument type="service" id="liip_imagine.cache.manager"/>
            </call>
        </service>

        <!-- Constants helper -->
        <service id="ekyna_product.constants_helper"
                 class="Ekyna\Bundle\ProductBundle\Service\ConstantsHelper">
            <argument type="service" id="translator"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
        </service>

        <!-- TODO Remove resources form types definitions (see configuration), by using resource choice form types -->

        <!-- Attribute form types -->
        <service id="ekyna_product.attribute.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeType">
            <argument>%ekyna_product.attribute.class%</argument>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeChoiceType">
            <argument>%ekyna_product.attribute_choice.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeSlotType">
            <argument>%ekyna_product.attribute_slot.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute_set_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\AttributeSetChoiceType">
            <argument>%ekyna_product.attribute_set.class%</argument>
            <tag name="form.type"/>
        </service>
        <!-- Attribute type form types -->
        <service id="ekyna_product.attribute.unit.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\Type\UnitAttributeType">
            <argument type="service" id="translator"/>
            <tag name="form.type"/>
        </service>

        <!-- Brand choice form type -->
        <service id="ekyna_product.brand_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Brand\BrandChoiceType">
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Bundle form types -->
        <service id="ekyna_product.bundle_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleChoiceType">
            <argument>%ekyna_product.bundle_choice.class%</argument>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_choice_rule.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleChoiceRuleType">
            <argument>%ekyna_product.bundle_choice_rule.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_slots.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleSlotsType">
            <tag name="form.js"
                 selector=".product-bundle-slots"
                 path="ekyna-product/form/product-bundle-slots"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleSlotType">
            <argument>%ekyna_product.bundle_slot.class%</argument>
            <argument>%ekyna_product.bundle_choice.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.bundle_slot_rule.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Bundle\BundleSlotRuleType">
            <argument>%ekyna_product.bundle_slot_rule.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Bundle choice event listener -->
        <service id="ekyna_product.bundle_choice.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\BundleChoiceListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>
        <!-- Bundle slot event listener -->
        <service id="ekyna_product.bundle_slot.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\BundleSlotListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Catalog form types -->
        <service id="ekyna_product.catalog.theme_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Catalog\CatalogThemeChoiceType">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.catalog_page.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Catalog\CatalogPageType">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="form.type"/>
            <tag name="form.js" selector=".catalog-page" path="ekyna-product/form/catalog-page"/>
        </service>
        <service id="ekyna_product.catalog_template.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Catalog\Template\TemplateChoiceType">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="form.type"/>
        </service>

        <!-- Category choice form type -->
        <service id="ekyna_product.category_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Category\CategoryChoiceType">
            <argument>%ekyna_product.category.class%</argument>
            <tag name="form.type"/>
        </service>

        <!-- Component event listener -->
        <service id="ekyna_product.component.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ComponentListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Customer group event listener -->
        <service id="Ekyna\Bundle\ProductBundle\EventListener\CustomerGroupListener">
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Sale item configurable/slots form types -->
        <service id="ekyna_product.sale_item.configurable_slots.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\ConfigurableSlotsType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.sale_item.configurable_slot.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\ConfigurableSlotType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <tag name="form.type"/>
        </service>

        <!-- Sale item options/groups form types -->
        <service id="ekyna_product.sale_item.option_groups.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\OptionGroupsType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.sale_item.option_group.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\OptionGroupType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.sale_item.variant_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\SaleItem\VariantChoiceType">
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <tag name="form.type"/>
        </service>

        <!-- Sale item configure type extension -->
        <service id="ekyna_product.sale_item_configure.type_extension"
                 class="Ekyna\Bundle\ProductBundle\Form\Extension\SaleItemConfigureTypeExtension">
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <argument type="service" id="twig.form.renderer"/>
            <argument>%ekyna_product.default.sale_item_form_theme%</argument>
            <tag name="form.type_extension"
                 extended-type="Ekyna\Bundle\CommerceBundle\Form\Type\Sale\SaleItemConfigureType"/>
            <tag name="form.js" selector=".sale-item-configure"
                 path="ekyna-product/form/sale-item-configure"/>
        </service>

        <!-- Option form types -->
        <service id="ekyna_product.option.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Option\OptionType">
            <argument>%ekyna_product.option.class%</argument>
            <tag name="form.js" selector=".product-option" path="ekyna-product/form/product-option"/>
            <tag name="form.type"/>
        </service>

        <!-- Option event listener -->
        <service id="ekyna_product.option.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\OptionListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Option group event listener -->
        <service id="ekyna_product.option_group.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\OptionGroupListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product form type builder -->
        <service id="ekyna_product.product.form_type.builder"
                 class="%ekyna_product.product.form_type.builder.class%">
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Service\Features"/>
            <argument>%ekyna_product.product_media.class%</argument>
        </service>

        <!-- Product form types -->
        <service id="ekyna_product.product.form_type.event_subscriber"
                 class="%ekyna_product.product.form_type.event_subscriber.class%">
            <argument type="service" id="ekyna_product.product.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.subject.form_type.builder"/>
            <argument type="service" id="ekyna_commerce.stock_subject.form_type.builder"/>
            <argument type="service" id="ekyna_product.attribute_set.repository"/>
        </service>
        <service id="ekyna_product.product.form_type"
                 class="%ekyna_product.product.form_type.class%">
            <argument type="service" id="ekyna_product.product.form_type.event_subscriber"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.product_attributes.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\ProductAttributesType">
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <argument>%ekyna_product.product_attribute.class%</argument>
            <tag name="form.js" selector=".product-attributes" path="ekyna-product/form/product-attributes"/>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.attribute.boolean_config.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Attribute\Config\BooleanConfigType">
            <argument>%locales%</argument>
            <argument>%kernel.default_locale%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.product_choice.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\ProductChoiceType">
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.product_search.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\ProductSearchType">
            <argument>%ekyna_product.product.class%</argument>
            <tag name="form.type"/>
        </service>
        <service id="ekyna_product.editor.product_selection.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Editor\ProductSelectionType">
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="form.type"/>
        </service>

        <!-- Product type column column type -->
        <service id="ekyna_product.product_type.column_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Column\ProductTypeType">
            <argument type="service" id="ekyna_product.constants_helper"/>
            <tag name="table.column_type"/>
        </service>

        <!-- Product table type -->
        <service id="ekyna_product.product.table_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Type\ProductType"><!-- TODO use parameter defined by config builder -->
            <argument type="service" id="ekyna_commerce.subject_helper"/>
            <argument type="service" id="router"/>
            <argument>%ekyna_product.product.class%</argument>
            <tag name="table.type"/>
        </service>
        <service id="ekyna_product.brand.table_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Type\BrandType">
            <argument type="service" id="ekyna_admin.helper.resource_helper"/>
            <argument type="service" id="router"/>
            <argument>%ekyna_product.brand.class%</argument>
            <tag name="table.type"/>
        </service>
        <service id="ekyna_product.category.table_type"
                 class="Ekyna\Bundle\ProductBundle\Table\Type\CategoryType">
            <argument type="service" id="ekyna_admin.helper.resource_helper"/>
            <argument type="service" id="router"/>
            <argument>%ekyna_product.category.class%</argument>
            <tag name="table.type"/>
        </service>

        <!-- Show types -->
        <service id="ekyna_product.show.attribute_config_type"
                 class="Ekyna\Bundle\ProductBundle\Show\Type\AttributeConfigType">
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="ekyna_admin.show.type" alias="attribute_config"/>
        </service>

        <!-- Offer repository -->
        <service id="ekyna_product.offer.repository"
                 class="Ekyna\Bundle\ProductBundle\Repository\OfferRepository">
            <argument type="service" id="ekyna_product.offer.manager"/>
            <argument type="service" id="ekyna_product.offer.metadata"/>
            <call method="setCachedCountryCodes">
                <argument>%ekyna_commerce.cache.countries%</argument>
            </call>
            <call method="setCacheTtl">
                <argument>%ekyna_product.cache_ttl%</argument>
            </call>
        </service>

        <!-- Offer resolver -->
        <service id="ekyna_product.offer.resolver"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\OfferResolver">
            <argument type="service" id="ekyna_product.pricing.repository"/>
            <argument type="service" id="ekyna_product.special_offer.repository"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
        </service>

        <!-- Offer updater -->
        <service id="ekyna_product.offer.updater"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\OfferUpdater">
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
            <argument type="service" id="ekyna_product.offer.resolver"/>
            <argument type="service" id="ekyna_product.offer.repository"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <argument>%ekyna_commerce.customer_group.class%</argument>
            <argument>%ekyna_commerce.country.class%</argument>
            <argument>%ekyna_product.pricing.class%</argument>
            <argument>%ekyna_product.special_offer.class%</argument>
        </service>

        <!-- Offer invalidator -->
        <service id="ekyna_product.offer.invalidator"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\OfferInvalidator">
            <argument>%ekyna_product.product.class%</argument>
        </service>

        <!-- Price repository -->
        <service id="ekyna_product.price.repository"
                 class="Ekyna\Bundle\ProductBundle\Repository\PriceRepository">
            <argument type="service" id="ekyna_product.price.manager"/>
            <argument type="service" id="ekyna_product.price.metadata"/>
            <call method="setCachedCountryCodes">
                <argument>%ekyna_commerce.cache.countries%</argument>
            </call>
            <call method="setCacheTtl">
                <argument>%ekyna_product.cache_ttl%</argument>
            </call>
        </service>

        <!-- Price event listener -->
        <service id="ekyna_product.price.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\PriceListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_commerce.customer_group.repository"/>
            <argument type="service" id="ekyna_commerce.country.repository"/>
            <tag name="resource.event_subscriber"/>
            <tag name="kernel.event_listener" event="console.terminate" method="onTerminate"/>
        </service>

        <!-- Price updater -->
        <service id="ekyna_product.price.updater"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceUpdater">
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
            <argument type="service" id="ekyna_product.offer.resolver"/>
            <argument type="service" id="ekyna_product.price.repository"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <argument>%ekyna_commerce.customer_group.class%</argument>
            <argument>%ekyna_commerce.country.class%</argument>
        </service>

        <!-- Price invalidator -->
        <service id="ekyna_product.price.invalidator"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceInvalidator">
            <argument type="service" id="ekyna_product.product.repository"/>
        </service>

        <!-- Price calculator -->
        <service id="ekyna_product.pricing.price_calculator"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceCalculator"
                 lazy="true">
            <argument id="ekyna_product.price.repository" type="service"/>
            <argument id="ekyna_product.offer.repository" type="service"/>
            <argument id="ekyna_commerce.pricing.tax_resolver" type="service"/>
            <argument id="Ekyna\Component\Commerce\Common\Currency\CurrencyConverterInterface" type="service"/>
            <argument>%ekyna_commerce.default.currency%</argument>
        </service>

        <!-- Purchase cost calculator -->
        <service id="ekyna_product.pricing.purchase_cost_calculator"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PurchaseCostCalculator"
                 lazy="true">
            <argument id="ekyna_product.pricing.price_calculator" type="service"/>
            <argument id="ekyna_commerce.subject.purchase_cost_guesser" type="service"/>
            <argument>%ekyna_commerce.default.currency%</argument>
        </service>

        <!-- Price renderer -->
        <service id="ekyna_product.pricing.renderer"
                 class="Ekyna\Bundle\ProductBundle\Service\Pricing\PriceRenderer"
                 lazy="true">
            <argument id="ekyna_product.pricing.price_calculator" type="service"/>
            <argument id="ekyna_product.pricing.purchase_cost_calculator" type="service"/>
            <argument id="ekyna_resource.locale_provider" type="service"/>
            <argument id="ekyna_commerce.common.context_provider" type="service"/>
            <argument id="ekyna_commerce.util.formatter_factory" type="service"/>
            <argument id="translator" type="service"/>
            <argument id="templating" type="service"/>
            <argument type="collection"/><!-- Replaced by DI extension -->
        </service>

        <!-- Offer event listener -->
        <service id="ekyna_product.offer.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\OfferListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_commerce.customer_group.repository"/>
            <argument type="service" id="ekyna_commerce.country.repository"/>
            <tag name="resource.event_subscriber"/>
            <tag name="kernel.event_listener" event="console.terminate" method="onTerminate"/>
        </service>

        <!-- Special offer event listener -->
        <service id="ekyna_product.special_offer.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\SpecialOfferListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.offer.invalidator"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <argument type="service" id="translator"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Pricing event listener -->
        <service id="ekyna_product.pricing.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\PricingListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.offer.invalidator"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Pricing rule event listener -->
        <service id="ekyna_product.pricing_rule.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\PricingRuleListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.offer.invalidator"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Add to cart event subscriber -->
        <service id="ekyna_product.add_to_cart.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\AddToCartEventSubscriber">
            <argument type="service" id="templating"/>
            <argument type="string"/><!-- Replaced by DI extension -->
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Sale buttons event listener -->
        <service id="ekyna_product.sale_buttons.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\SaleButtonsEventSubscriber">
            <argument type="service" id="router"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Sale item event listener -->
        <service id="ekyna_product.sale_item.event_subscriber"
                 class="Ekyna\Bundle\ProductBundle\EventListener\SaleItemEventSubscriber">
            <argument type="service" id="ekyna_commerce.common.context_provider"/>
            <argument type="service" id="ekyna_product.commerce.item_builder"/>
            <argument type="service" id="ekyna_product.commerce.form_builder"/>
            <argument type="service" id="ekyna_product.offer.repository"/>
            <argument type="service" id="Symfony\Component\Translation\TranslatorInterface"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Sale view type -->
        <service id="ekyna_product.sale.view_type"
                 class="Ekyna\Bundle\ProductBundle\Service\Commerce\SaleViewType"
                 parent="ekyna_commerce.abstract_view_type">
            <tag name="ekyna_commerce.view_type"/>
        </service>

        <!-- Variant generator -->
        <service id="ekyna_product.product.variant_generator"
                 class="Ekyna\Bundle\ProductBundle\Service\Generator\VariantGenerator">
            <argument>%ekyna_product.product.class%</argument>
        </service>

        <!-- Simple product event handler -->
        <service id="ekyna_product.product.listener.simple_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\SimpleHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Variant product event handler -->
        <service id="ekyna_product.product.listener.variant_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\VariantHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.locale_provider"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Variable product event handler -->
        <service id="ekyna_product.product.listener.variable_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\VariableHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_resource.locale_provider"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <call method="setPriceInvalidator">
                <argument type="service" id="ekyna_product.price.invalidator"/>
            </call>
            <call method="setStockUpdater">
                <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            </call>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Bundle product event handler -->
        <service id="ekyna_product.product.listener.bundle_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\BundleHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>
        <!-- Configurable product event handler -->
        <service id="ekyna_product.product.listener.configurable_handler"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\ConfigurableHandler"
                 public="false">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            <tag name="ekyna_product.product_event_handler"/>
        </service>

        <!-- Product event handlers registry -->
        <service id="ekyna_product.product.listener.handler_registry"
                 class="Ekyna\Bundle\ProductBundle\EventListener\Handler\HandlerRegistry"/>

        <!-- Product event listener -->
        <service id="ekyna_product.product.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <argument type="service" id="ekyna_product.product.listener.handler_registry"/>
            <argument type="service" id="ekyna_product.product.reference_generator"/>
            <argument type="service" id="ekyna_product.offer.invalidator"/>
            <argument type="service" id="ekyna_product.price.invalidator"/>
            <argument>%ekyna_commerce.stock_subject_defaults%</argument>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product media event listener -->
        <service id="ekyna_product.product_media.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductMediaListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product stock unit event listener -->
        <service id="ekyna_product.product_stock_unit.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductStockUnitListener"
                 parent="ekyna_commerce.stock_unit.abstract_listener">
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product translation event listener -->
        <service id="ekyna_product.product_translation.listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\ProductTranslationListener">
            <argument type="service" id="ekyna_resource.doctrine.orm.persistence_helper"/>
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- Product label event listener -->
        <service id="ekyna_product.product.label_listener"
                 class="Ekyna\Bundle\ProductBundle\EventListener\LabelListener">
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Product constraint validator -->
        <service id="Ekyna\Bundle\ProductBundle\Validator\Constraints\ProductValidator">
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Product translation constraint validator -->
        <service id="Ekyna\Bundle\ProductBundle\Validator\Constraints\ProductTranslationValidator">
            <argument type="service" id="ekyna_product.product_translation.repository"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Variant constraint validator -->
        <service id="Ekyna\Bundle\ProductBundle\Validator\Constraints\VariantValidator">
            <argument type="service" id="ekyna_resource.locale_provider"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Product attribute constraint validator -->
        <service id="Ekyna\Bundle\ProductBundle\Validator\Constraints\ProductAttributeValidator">
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <tag name="validator.constraint_validator"/>
        </service>

        <!-- Reference generator -->
        <service id="ekyna_product.product.reference_generator"
                 class="Ekyna\Bundle\ProductBundle\Service\Generator\ReferenceGenerator">
            <argument>%kernel.data_dir%/product_reference</argument>
            <argument>8</argument>
            <argument>ym</argument>
        </service>

        <!-- Public url listener -->
        <service id="Ekyna\Bundle\ProductBundle\EventListener\UrlEventSubscriber">
            <tag name="resource.event_subscriber"/>
        </service>

        <!-- External Reference generator -->
        <service id="Ekyna\Bundle\ProductBundle\Service\Generator\ExternalReferenceGenerator">
            <argument type="service" id="ekyna_product.product_reference.repository"/>
        </service>

        <!-- Product converter -->
        <service id="ekyna_product.product.product_converter"
                 class="Ekyna\Bundle\ProductBundle\Service\Converter\ProductConverter">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <argument type="service" id="ekyna_product.product.operator"/>
            <argument type="service" id="Symfony\Component\Form\FormFactoryInterface"/>
            <argument type="service" id="Symfony\Component\HttpFoundation\RequestStack"/>
            <argument type="service" id="Symfony\Component\Validator\Validator\ValidatorInterface"/>
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
        </service>

        <!-- Product convert form type -->
        <service id="ekyna_product.convert_variable.form_type"
                 class="Ekyna\Bundle\ProductBundle\Form\Type\Convert\VariableType">
            <argument type="service" id="ekyna_admin.helper.resource_helper"/>
            <argument type="service" id="ekyna_product.attribute_set.repository"/>
            <tag name="form.type"/>
        </service>

        <!-- CMS Editor plugins -->
        <service id="ekyna_product.editor.block_plugin.product_thumb"
                 class="Ekyna\Bundle\ProductBundle\Service\Editor\Block\ProductSlidePlugin"
                 parent="ekyna_cms.editor.block_plugin.abstract"
                 public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="templating"/>
            <argument>%ekyna_product.editor.slide%</argument>
            <tag name="ekyna_cms.editor.block_plugin"/>
        </service>

        <!-- Search -->
        <service id="ekyna_product.category.search"
                 class="Ekyna\Bundle\ProductBundle\Service\Search\CategoryRepository">
            <argument type="service" id="fos_elastica.index.ekyna_product_category.doc"/>
            <argument type="service" id="fos_elastica.elastica_to_model_transformer.ekyna_product_category.doc"/>
            <call method="setLocaleProvider">
                <argument type="service" id="Ekyna\Component\Resource\Locale\LocaleProviderInterface"/>
            </call>
            <tag name="ekyna_resource.search" resource="ekyna_product.category"/>
        </service>
        <service id="ekyna_product.brand.search"
                 class="Ekyna\Bundle\ProductBundle\Service\Search\BrandRepository">
            <argument type="service" id="fos_elastica.index.ekyna_product_brand.doc"/>
            <argument type="service" id="fos_elastica.elastica_to_model_transformer.ekyna_product_brand.doc"/>
            <call method="setLocaleProvider">
                <argument type="service" id="Ekyna\Component\Resource\Locale\LocaleProviderInterface"/>
            </call>
            <tag name="ekyna_resource.search" resource="ekyna_product.brand"/>
        </service>
        <service id="ekyna_product.product.search"
                 class="Ekyna\Bundle\ProductBundle\Service\Search\ProductRepository">
            <argument type="service" id="fos_elastica.index.ekyna_product_product.doc"/>
            <argument type="service" id="fos_elastica.elastica_to_model_transformer.ekyna_product_product.doc"/>
            <call method="setLocaleProvider">
                <argument type="service" id="Ekyna\Component\Resource\Locale\LocaleProviderInterface"/>
            </call>
            <tag name="ekyna_resource.search" resource="ekyna_product.product"/>
        </service>

        <!-- Exporter -->
        <service id="Ekyna\Bundle\ProductBundle\Service\Exporter\ProductExporter">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <argument type="service" id="ekyna_commerce.subject_helper"/>
            <argument type="service" id="Symfony\Component\Translation\TranslatorInterface"/>
        </service>

        <!-- Catalog services -->
        <service id="ekyna_product.catalog.registry"
                 class="Ekyna\Bundle\ProductBundle\Service\Catalog\CatalogRegistry">
            <argument type="collection"/><!-- Replaced by DI extension -->
            <argument type="collection"/><!-- Replaced by DI extension -->
        </service>
        <service id="ekyna_product.catalog.renderer"
                 class="Ekyna\Bundle\ProductBundle\Service\Catalog\CatalogRenderer">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <argument type="service" id="templating"/>
            <argument type="service" id="Ekyna\Bundle\CommerceBundle\Service\Document\PdfGenerator"/>
            <argument type="service" id="ekyna_commerce.subject_helper"/>
            <argument>%ekyna_commerce.default.company_logo%</argument>
            <argument>%kernel.debug%</argument>
        </service>

        <!-- Serialization -->
        <service id="ekyna_product.product.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\ProductNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer"
                 public="false">
            <call method="setCacheManager">
                <argument type="service" id="liip_imagine.cache.manager"/>
            </call>
            <call method="setSubjectNormalizerHelper">
                <argument type="service" id="ekyna_commerce.subject.normalizer_helper"/>
            </call>
            <call method="setSupplierProductRepository">
                <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            </call>
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.product_reference.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\ProductReferenceNormalizer"
                 public="false">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.brand.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\BrandNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer"
                 public="false">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>
        <service id="ekyna_product.category.normalizer"
                 class="Ekyna\Bundle\ProductBundle\Service\Serializer\CategoryNormalizer"
                 parent="ekyna_resource.serializer.resource_normalizer"
                 public="false">
            <tag name="serializer.normalizer"/>
            <tag name="serializer.denormalizer"/>
        </service>

        <!-- Stat count repository -->
        <service id="Ekyna\Bundle\ProductBundle\Repository\StatCountRepository">
            <argument type="service" id="Symfony\Bridge\Doctrine\RegistryInterface"/>
            <call method="setLocaleProvider">
                <argument type="service" id="ekyna_resource.locale_provider"/>
            </call>
            <tag name="doctrine.repository_service"/>
        </service>
        <!-- Stat cross repository -->
        <service id="Ekyna\Bundle\ProductBundle\Repository\StatCrossRepository">
            <argument type="service" id="Symfony\Bridge\Doctrine\RegistryInterface"/>
            <call method="setLocaleProvider">
                <argument type="service" id="ekyna_resource.locale_provider"/>
            </call>
            <tag name="doctrine.repository_service"/>
        </service>

        <!-- Stat updater -->
        <service id="ekyna_product.stat.updater"
                 class="Ekyna\Bundle\ProductBundle\Service\Stat\StatUpdater"
                 public="false">
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\StatCountRepository"/>
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\StatCrossRepository"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.customer_group.repository"/>
            <argument type="service" id="doctrine.orm.default_entity_manager"/>
        </service>

        <!-- Stat chart builder factory -->
        <service id="ekyna_product.stat.chart_builder_factory"
                 class="Ekyna\Bundle\ProductBundle\Service\Stat\ChartBuilderFactory">
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\StatCountRepository"/>
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\StatCrossRepository"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.customer_group.repository"/>
        </service>

        <!-- Stat chart renderer -->
        <service id="ekyna_product.stat.chart_renderer"
                 class="Ekyna\Bundle\ProductBundle\Service\Stat\ChartRenderer">
            <argument type="service" id="ekyna_product.stat.chart_builder_factory"/>
            <argument type="service" id="templating"/>
            <argument type="collection"/>
        </service>

        <!-- Highlight -->
        <service id="ekyna_product.highlight"
                 class="Ekyna\Bundle\ProductBundle\Service\Highlight\Highlight">
            <argument type="service" id="ekyna_commerce.common.context_provider"/>
            <argument type="service" id="ekyna_commerce.cart.session_provider"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\StatCountRepository"/>
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Repository\StatCrossRepository"/>
            <argument type="service" id="templating"/>
            <argument type="collection"/><!-- Replaced by DI extesion -->
            <tag name="twig.runtime"/>
        </service>

        <!-- Checkout event listener -->
        <service id="ekyna_product.event_subscriber.checkout"
                 class="Ekyna\Bundle\ProductBundle\EventListener\CheckoutEventSubscriber">
            <argument type="service" id="ekyna_product.highlight"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <!-- Google tracking helper -->
        <service id="ekyna_product.google.tracking_helper"
                 class="Ekyna\Bundle\ProductBundle\Service\Google\TrackingHelper">
            <argument type="service" id="ekyna_google.tracking.pool"/>
        </service>


        <!-- Schema.org providers -->
        <service id="ekyna_product.product.schema_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\SchemaOrg\ProductProvider">
            <argument type="service" id="ekyna_resource.event_dispatcher"/>
            <argument>%ekyna_commerce.default.currency%</argument>
            <tag name="ekyna_cms.schema_org_provider"/>
        </service>
        <service id="ekyna_product.brand.schema_provider"
                 class="Ekyna\Bundle\ProductBundle\Service\SchemaOrg\BrandProvider">
            <tag name="ekyna_cms.schema_org_provider"/>
        </service>

        <!-- Twig extensions -->
        <service id="Ekyna\Bundle\ProductBundle\Twig\ProductExtension" public="false">
            <argument type="service" id="ekyna_product.constants_helper"/>
            <argument type="service" id="ekyna_product.pricing.renderer"/>
            <argument type="service" id="ekyna_product.attribute.type_registry"/>
            <argument type="service" id="ekyna_resource.locale_provider"/>
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="Ekyna\Bundle\ProductBundle\Service\Features"/>
            <argument>%ekyna_product.default.no_image%</argument>
            <tag name="twig.extension"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Twig\CatalogExtension" public="false">
            <argument type="service" id="ekyna_product.catalog.registry"/>
            <tag name="twig.extension"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Twig\HighlightExtension" public="false">
            <tag name="twig.extension"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Twig\StatExtension" public="false">
            <argument type="service" id="ekyna_product.stat.chart_renderer"/>
            <tag name="twig.extension"/>
        </service>

        <!-- Commands -->
        <service id="Ekyna\Bundle\ProductBundle\Command\OfferInvalidateCommand" public="false">
            <argument type="service" id="ekyna_product.special_offer.repository"/>
            <argument type="service" id="ekyna_product.offer.invalidator"/>
            <argument type="service" id="ekyna_product.special_offer.manager"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\OfferUpdateCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.offer.updater"/>
            <argument type="service" id="ekyna_product.price.updater"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\ReferenceConvertCommand" public="false">
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="Swift_Mailer"/>
            <argument>%error_report_mail%</argument>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\ResupplyCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_order.operator"/>
            <argument type="service" id="ekyna_commerce.supplier_delivery.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_delivery_item.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_delivery.operator"/>
            <argument type="service" id="ekyna_product.resupply"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\StatUpdateCommand" public="false">
            <argument type="service" id="ekyna_product.stat.updater"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\StockReportCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="Symfony\Component\Templating\EngineInterface"/>
            <argument type="service" id="ekyna_setting.manager"/>
            <argument type="service" id="Symfony\Component\Translation\TranslatorInterface"/>
            <argument type="service" id="Swift_Mailer"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\StockShowCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\StockUpdateCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.stock_subject_updater"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\UpdateMinPriceCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\VariableFixVisibilityCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\VariantFixPositionCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <argument type="service" id="ekyna_product.pricing.price_calculator"/>
            <tag name="console.command"/>
        </service>
        <service id="Ekyna\Bundle\ProductBundle\Command\WeightFromSupplierCommand" public="false">
            <argument type="service" id="ekyna_product.product.repository"/>
            <argument type="service" id="ekyna_commerce.supplier_product.repository"/>
            <argument type="service" id="ekyna_product.product.manager"/>
            <tag name="console.command"/>
        </service>

    </services>

</container>
